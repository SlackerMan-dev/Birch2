<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="react-devtools" content="false">
    <title>Система отчетности арбитража</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script>
        // Отключаем предупреждения React DevTools
        window.__REACT_DEVTOOLS_GLOBAL_HOOK__ = {
            supportsFiber: true,
            inject: function() {},
            onCommitFiberRoot: function() {},
            onCommitFiberUnmount: function() {}
        };
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script>
        // Отключаем предупреждения Babel
        if (window.Babel) {
            window.Babel.transform = function(code, options) {
                try {
                    return window.Babel.transform(code, options);
                } catch (e) {
                    console.warn('Babel transform warning suppressed');
                    return { code: code };
                }
            };
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Отключаем прокрутку для числовых полей */
        input[type="number"] {
            -moz-appearance: textfield;
        }
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 95vw;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-align: center;
        }

        .header p {
            color: #7f8c8d;
            text-align: center;
            font-size: 1.1em;
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
        }

        .nav-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s ease;
            font-weight: 600;
            color: #7f8c8d;
        }


        .platforms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .platform-card {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .platform-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .platform-header h4 {
            margin: 0;
            color: #333;
            font-size: 18px;
        }

        .platform-header h4 i {
            margin-right: 8px;
            color: #667eea;
        }

        .platform-total {
            text-align: right;
        }

        .balance-amount {
            font-size: 20px;
            font-weight: bold;
            color: #27ae60;
            display: block;
        }

        .accounts-count {
            font-size: 12px;
            color: #666;
        }

        .accounts-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .account-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f8f9fa;
        }

        .account-row:last-child {
            border-bottom: none;
        }

        .account-name {
            font-size: 14px;
            color: #333;
        }

        .account-balance {
            font-size: 14px;
            font-weight: 500;
            color: #27ae60;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-2px);
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        /* Анимация пульсации для блока времени */
        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 0.1;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.2;
            }
            100% {
                transform: scale(1);
                opacity: 0.1;
            }
        }

        /* Анимация плавания частиц */
        @keyframes float {
            0%, 100% {
                transform: translateY(0px) rotate(0deg);
                opacity: 0.8;
            }
            50% {
                transform: translateY(-20px) rotate(180deg);
                opacity: 1;
            }
        }

        /* Анимация свечения */
        @keyframes glow {
            0% {
                box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
            }
            100% {
                box-shadow: 0 0 30px rgba(255, 255, 255, 0.6), 0 0 40px rgba(102, 126, 234, 0.4);
            }
        }

        /* Анимация свечения текста */
        @keyframes textGlow {
            0% {
                text-shadow: 0 0 30px rgba(255, 255, 255, 0.8), 0 0 60px rgba(102, 126, 234, 0.6);
            }
            100% {
                text-shadow: 0 0 40px rgba(255, 255, 255, 1), 0 0 80px rgba(102, 126, 234, 0.8), 0 0 100px rgba(240, 147, 251, 0.4);
            }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .stat-card h3 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .stat-card p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .table th,
        .table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e1e8ed;
        }

        .table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }

        .table tr:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        .positive {
            color: #27ae60;
            font-weight: 600;
        }

        .negative {
            color: #e74c3c;
            font-weight: 600;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #7f8c8d;
        }

        .employee-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
        }

        .employee-card h4 {
            margin-bottom: 10px;
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-item {
            flex: 1;
            min-width: 200px;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            .filters {
                flex-direction: column;
            }
            .filter-item {
                min-width: auto;
            }
            .nav-tabs {
                flex-direction: column;
                gap: 8px;
                padding: 8px 0;
            }
            .nav-tab {
                font-size: 1.1em;
                padding: 14px 0;
                border-radius: 8px;
            }
            .header {
                padding: 18px 8px;
            }
            .container {
                padding: 8px;
            }
            .btn, .btn-secondary {
                font-size: 1.1em;
                padding: 16px 0;
                width: 100%;
                margin-bottom: 8px;
            }
            .form-control {
                font-size: 1.1em;
                padding: 16px 12px;
            }
            .table {
                display: block;
                width: 100%;
                overflow-x: auto;
                font-size: 0.98em;
            }
            .table thead, .table tbody, .table tr {
                display: table;
                width: 100%;
                table-layout: fixed;
            }
            .table th, .table td {
                padding: 10px 6px;
            }
        }
        @media (max-width: 500px) {
            .table, .table thead, .table tbody, .table tr, .table th, .table td {
                display: block;
                width: 100%;
            }
            .table thead { display: none; }
            .table tr {
                margin-bottom: 18px;
                background: #fff;
                border-radius: 12px;
                box-shadow: 0 2px 8px #e1e8ed;
                padding: 10px 8px;
            }
            .table td {
                padding: 8px 4px;
                border: none;
                position: relative;
            }
            .table td:before {
                content: attr(data-label);
                font-weight: bold;
                color: #764ba2;
                display: block;
                margin-bottom: 2px;
                font-size: 0.98em;
            }
        }

        /* --- Новый стиль для детального отчёта ---
           1. Секции: карточки с тенью и цветными полосками
           2. Балансы по аккаунтам: таблица с фиксированным заголовком, горизонтальный скролл, цвет дельты
           3. Финансовые итоги: ключевые показатели в карточках с иконками
           4. Второстепенные детали (файлы, комментарии) — свернуты по умолчанию
           5. Всё адаптивно, не меняю названия блоков и полей */
        .table th:last-child,
        .table th:nth-last-child(2),
        .table td:last-child,
        .table td:nth-last-child(2) {
            text-align: center !important;
            width: 120px;
            min-width: 100px;
            max-width: 140px;
            padding-left: 0 !important;
            padding-right: 0 !important;
            vertical-align: middle;
        }
    </style>
    <script>

    // Безопасная аутентификация
    const authenticateUser = async (password, isAdmin = false) => {
        try {
            const endpoint = isAdmin ? '/api/auth/admin' : '/api/auth/login';
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ password: password })
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    sessionStorage.setItem('authenticated', 'true');
                    if (isAdmin) {
                        sessionStorage.setItem('admin', 'true');
                    }
                    return true;
                }
            }
            return false;
        } catch (error) {
            console.error('Ошибка аутентификации:', error);
            return false;
        }
    };
    
    // Проверка аутентификации при загрузке
    const checkAuthentication = () => {
        return sessionStorage.getItem('authenticated') === 'true';
    };
    
    // Проверка админских прав
    const checkAdminRights = () => {
        return sessionStorage.getItem('admin') === 'true';
    };
    
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ДЛЯ РАСЧЁТОВ ---
        const PLATFORMS = ['bybit','htx','bliss','gate'];

        function compareShifts(dateA, shiftA, dateB, shiftB) {
            const dA = new Date(dateA);
            const dB = new Date(dateB);
            if (dA < dB) return -1;
            if (dA > dB) return 1;
            if (shiftA === shiftB) return 0;
            if (shiftA === 'morning' && shiftB === 'evening') return -1;
            if (shiftA === 'evening' && shiftB === 'morning') return 1;
            return 0;
        }

        function findPrevBalanceJS(account_id, platform, reports, report, settingsInitialBalances, accounts) {
            if (reports && Array.isArray(reports)) {
                const prev = reports
                    .filter(r => {
                        if (r.id === report.id) return false;
                        if (compareShifts(r.shift_date, r.shift_type, report.shift_date, report.shift_type) >= 0) return false;
                        return true;
                    })
                    .sort((a, b) => {
                        if (compareShifts(a.shift_date, a.shift_type, b.shift_date, b.shift_type) > 0) return -1;
                        if (compareShifts(a.shift_date, a.shift_type, b.shift_date, b.shift_type) < 0) return 1;
                        return 0;
                    });
                if (prev.length > 0) {
                    let prevBalances = {};
                    try { prevBalances = JSON.parse(prev[0].balances_json || '{}'); } catch { prevBalances = {}; }
                    const found = prevBalances[platform]?.find(a => (a.account_id || a.id) == account_id);
                    if (found && found.balance !== '' && !isNaN(found.balance)) return parseFloat(found.balance);
                }
            }
            if (settingsInitialBalances) {
                const acc = settingsInitialBalances.find(b => b.platform === platform && (b.account_id == account_id || b.account_name == (accounts?.find(a => a.id == account_id)?.account_name)));
                if (acc && acc.balance !== undefined) return parseFloat(acc.balance);
            }
            return 0;
        }

        function getTotalBalance(balances, internal) {
            let total = 0;
            PLATFORMS.forEach(platform => {
                if (balances[platform]) {
                    balances[platform].forEach(acc => {
                        // Сначала проверяем end_balance (новая структура)
                        if (acc.end_balance !== '' && !isNaN(acc.end_balance)) {
                            total += parseFloat(acc.end_balance);
                        }
                        // Затем проверяем balance (старая структура)
                        else if (acc.balance !== '' && !isNaN(acc.balance)) {
                            total += parseFloat(acc.balance);
                        }
                    });
                }
            });
            return total + (parseFloat(internal) || 0);
        }

        function getPrevTotal(report, reports, settingsInitialBalances, accounts) {
            let prevTotal = null;
            let usedInitial = false;
            if (reports && Array.isArray(reports)) {
                const prev = reports
                    .filter(r => {
                        if (r.id === report.id) return false;
                        if (compareShifts(r.shift_date, r.shift_type, report.shift_date, report.shift_type) >= 0) return false;
                        return true;
                    })
                    .sort((a, b) => {
                        if (compareShifts(a.shift_date, a.shift_type, b.shift_date, b.shift_type) > 0) return -1;
                        if (compareShifts(a.shift_date, a.shift_type, b.shift_date, b.shift_type) < 0) return 1;
                        return 0;
                    });
                if (prev.length > 0) {
                    let prevBalances = {};
                    try { prevBalances = JSON.parse(prev[0].balances_json || '{}'); } catch { prevBalances = {}; }
                    let prevSum = 0;
                    PLATFORMS.forEach(platform => {
                        if (prevBalances[platform]) {
                            prevBalances[platform].forEach(acc => {
                                // Сначала проверяем end_balance (новая структура)
                                if (acc.end_balance !== '' && !isNaN(acc.end_balance)) {
                                    prevSum += parseFloat(acc.end_balance);
                                }
                                // Затем проверяем balance (старая структура)
                                else if (acc.balance !== '' && !isNaN(acc.balance)) {
                                    prevSum += parseFloat(acc.balance);
                                }
                            });
                        }
                    });
                    const prevInternal = parseFloat(prev[0].internal_transfer_amount) || 0;
                    prevTotal = prevSum + prevInternal;
                }
            }
            if (prevTotal === null && settingsInitialBalances) {
                prevTotal = 0;
                settingsInitialBalances.forEach(b => {
                    if (b.balance !== '' && !isNaN(b.balance)) prevTotal += parseFloat(b.balance);
                });
                usedInitial = true;
            }
            return { prevTotal, usedInitial };
        }


        function PlatformBalances() {
            const [balances, setBalances] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');
            const [lastUpdate, setLastUpdate] = useState(null);

            const loadBalances = async () => {
                try {
                    setLoading(true);
                    setError('');
                    const response = await fetch('/api/platform-balances');
                    const data = await response.json();
                    
                    if (response.ok) {
                        setBalances(data);
                        setLastUpdate(new Date());
                    } else {
                        setError(data.error || 'Ошибка при загрузке данных');
                    }
                } catch (err) {
                    setError('Ошибка сети: ' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                loadBalances();
            }, []);

            if (loading) {
                return (
                    <div className="card">
                        <h3><i className="fas fa-coins"></i> Балансы площадок</h3>
                        <div style={{textAlign: 'center', padding: '40px', color: '#666'}}>
                            <i className="fas fa-spinner fa-spin fa-2x"></i>
                            <p style={{marginTop: '10px'}}>Загрузка балансов...</p>
                        </div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="card">
                        <h3><i className="fas fa-coins"></i> Балансы площадок</h3>
                        <div style={{textAlign: 'center', padding: '40px', color: '#e74c3c'}}>
                            <i className="fas fa-exclamation-triangle fa-2x"></i>
                            <p style={{marginTop: '10px'}}>{error}</p>
                            <button className="btn btn-primary" onClick={loadBalances} style={{marginTop: '10px'}}>
                                Попробовать снова
                            </button>
                        </div>
                    </div>
                );
            }

            if (!balances || !balances.platforms || balances.platforms.length === 0) {
                return (
                    <div className="card">
                        <h3><i className="fas fa-coins"></i> Балансы площадок</h3>
                        <div style={{textAlign: 'center', padding: '40px', color: '#666'}}>
                            <i className="fas fa-info-circle fa-2x"></i>
                            <p style={{marginTop: '10px'}}>Нет данных о балансах</p>
                        </div>
                    </div>
                );
            }

            return (
                <div>
                    <div className="card">
                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px'}}>
                            <h3><i className="fas fa-coins"></i> Балансы площадок</h3>
                            <button className="btn btn-primary" onClick={loadBalances}>
                                <i className="fas fa-sync-alt"></i> Обновить
                            </button>
                        </div>

                        {/* Общая информация */}
                        <div className="stats-grid" style={{marginBottom: '30px'}}>
                            <div className="stat-card">
                                <h3>${balances.total_balance.toFixed(2)}</h3>
                                <p>Общий баланс</p>
                            </div>
                            <div className="stat-card">
                                <h3>{balances.platforms.reduce((sum, p) => sum + p.accounts_count, 0)}</h3>
                                <p>Всего аккаунтов</p>
                            </div>
                            <div className="stat-card">
                                <h3>{balances.active_platforms_count || balances.platforms.filter(p => p.accounts_count > 0).length}</h3>
                                <p>Активных площадок</p>
                            </div>
                        </div>

                        {/* Информация о последнем обновлении */}
                        {balances.last_update && (
                            <div style={{
                                background: '#f8f9fa',
                                padding: '15px',
                                borderRadius: '8px',
                                marginBottom: '20px',
                                fontSize: '14px',
                                color: '#666'
                            }}>
                                <i className="fas fa-clock"></i> Последнее обновление: {' '}
                                {new Date(balances.last_update.date).toLocaleDateString('ru-RU')} {' '}
                                ({balances.last_update.shift_type === 'morning' ? 'Утренняя' : 'Вечерняя'} смена, {' '}
                                {balances.last_update.employee_name})
                            </div>
                        )}

                        {/* Балансы по площадкам */}
                        <div className="platforms-grid">
                            {balances.platforms.map(platform => (
                                <div key={platform.platform} className="platform-card">
                                    <div className="platform-header">
                                        <h4>
                                            <i className={`fab fa-${platform.platform}`}></i>
                                            {platform.platform_name}
                                        </h4>
                                        <div className="platform-total">
                                            <span className="balance-amount">${platform.total_balance.toFixed(2)}</span>
                                            <span className="accounts-count">({platform.accounts_count} акк.)</span>
                                        </div>
                                    </div>
                                    
                                    {platform.accounts.length > 0 && (
                                        <div className="accounts-list">
                                            {platform.accounts.map(account => (
                                                <div key={account.account_id} className="account-row">
                                                    <span className="account-name">{account.account_name}</span>
                                                    <span className="account-balance">${account.balance.toFixed(2)}</span>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        // --- Глобальная история балансов аккаунтов ---
        window.accountBalanceHistory = window.accountBalanceHistory || [];

        // --- Сохранять историю балансов после каждого отчёта ---
        async function saveAccountBalancesToHistory(report, employees, accounts) {
            let balances = {};
            try { balances = typeof report.balances_json === 'string' ? JSON.parse(report.balances_json) : report.balances_json || {}; } catch { balances = {}; }
            const employee = employees.find(emp => emp.id === report.employee_id);
            for (const platform of ['bybit','htx','bliss','gate']) {
                if (!balances[platform]) continue;
                    for (const acc of balances[platform]) {
                    // Сохраняем начальный баланс
                    const bodyStart = {
                            account_id: acc.account_id || acc.id,
                            account_name: acc.account_name,
                            platform,
                            shift_date: report.shift_date,
                            shift_type: report.shift_type,
                        balance: acc.start_balance !== '' && !isNaN(acc.start_balance) ? parseFloat(acc.start_balance) : 0,
                            employee_id: employee ? employee.id : null,
                        employee_name: employee ? employee.name : '—',
                        balance_type: 'start'
                        };
                        try {
                        await fetch('/api/account-balance-history', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(bodyStart)
                            });
                    } catch (e) {
                        console.error('Ошибка сохранения начального баланса в историю:', e);
                    }
                    // Сохраняем конечный баланс
                    const bodyEnd = {
                        account_id: acc.account_id || acc.id,
                        account_name: acc.account_name,
                        platform,
                        shift_date: report.shift_date,
                        shift_type: report.shift_type,
                        balance: acc.end_balance !== '' && !isNaN(acc.end_balance) ? parseFloat(acc.end_balance) : 0,
                        employee_id: employee ? employee.id : null,
                        employee_name: employee ? employee.name : '—',
                        balance_type: 'end'
                    };
                    try {
                        await fetch('/api/account-balance-history', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(bodyEnd)
                        });
                        } catch (e) {
                        console.error('Ошибка сохранения конечного баланса в историю:', e);
                    }
                }
            }
        }

        // --- Использовать историю для расчёта дельты ---
        function findPrevAccountBalanceInHistory(account_id, platform, shift_date, shift_type, accounts = []) {
            // Найти последнюю запись по этому аккаунту до текущей смены
            const prev = window.accountBalanceHistory
                .filter(h => h.account_id == account_id && h.platform === platform && compareShifts(h.shift_date, h.shift_type, shift_date, shift_type) < 0)
                .sort((a, b) => compareShifts(b.shift_date, b.shift_type, a.shift_date, a.shift_type));
            if (prev.length > 0) return prev[0].balance;
            // Если нет — ищем стартовый баланс из настроек
            if (window.settingsInitialBalances) {
                const found = window.settingsInitialBalances.find(b => b.platform === platform && (b.account_id == account_id || b.account_name == (accounts.find(a => a.id == account_id)?.account_name)));
                if (found && found.balance !== undefined && found.balance !== '' && !isNaN(found.balance)) return parseFloat(found.balance);
            }
            return 0;
        }

        // --- Модифицировать calculateProfit и calculateSalaryProfit ---
        function calculateProfit(report, reports, settingsInitialBalances, accounts, employees) {
            let balances = {};
            try { balances = typeof report.balances_json === 'string' ? JSON.parse(report.balances_json) : report.balances_json || {}; } catch { balances = {}; }
            let endSum = 0;
            let startSum = 0;
            ['bybit','htx','bliss','gate'].forEach(platform => {
                if (balances[platform]) {
                    balances[platform].forEach(acc => {
                        // Проверяем и исправляем аномальные значения
                        let endBalance = parseFloat(acc.end_balance || 0);
                        let startBalance = parseFloat(acc.start_balance || 0);
                        
                        if (isNaN(endBalance) || Math.abs(endBalance) > 100000) {
                            console.warn(`Аномальный конечный баланс: ${endBalance}, обнуляем`);
                            endBalance = 0;
                        }
                        if (isNaN(startBalance) || Math.abs(startBalance) > 100000) {
                            console.warn(`Аномальный начальный баланс: ${startBalance}, обнуляем`);
                            startBalance = 0;
                        }
                        
                        endSum += endBalance;
                        startSum += startBalance;
                    });
                }
            });
            const dokidka = parseFloat(report.dokidka_amount) || 0;
            const internal = parseFloat(report.internal_transfer_amount) || 0;
            let profit = (endSum - startSum) - dokidka - internal;
            
            // Проверяем на аномально большую прибыль
            if (Math.abs(profit) > 50000) {
                console.warn(`Аномально большая прибыль: ${profit}, обнуляем`);
                profit = 0;
            }
            
            return { endSum, startSum, dokidka, internal, profit };
        }
        function calculateSalaryProfit(report, reports, settingsInitialBalances, accounts, employees) {
            let balances = {};
            try { balances = typeof report.balances_json === 'string' ? JSON.parse(report.balances_json) : report.balances_json || {}; } catch { balances = {}; }
            let endSum = 0;
            let startSum = 0;
            ['bybit','htx','bliss','gate'].forEach(platform => {
                if (balances[platform]) {
                    balances[platform].forEach(acc => {
                        // Проверяем и исправляем аномальные значения
                        let endBalance = parseFloat(acc.end_balance || 0);
                        let startBalance = parseFloat(acc.start_balance || 0);
                        
                        if (isNaN(endBalance) || Math.abs(endBalance) > 100000) {
                            console.warn(`Аномальный конечный баланс: ${endBalance}, обнуляем`);
                            endBalance = 0;
                        }
                        if (isNaN(startBalance) || Math.abs(startBalance) > 100000) {
                            console.warn(`Аномальный начальный баланс: ${startBalance}, обнуляем`);
                            startBalance = 0;
                        }
                        
                        endSum += endBalance;
                        startSum += startBalance;
                    });
                }
            });
            const dokidka = parseFloat(report.dokidka_amount) || 0;
            const internal = parseFloat(report.internal_transfer_amount) || 0;
            const scam = 0; // Скам больше не вычитается из зарплатной прибыли
            let profit = endSum - startSum - dokidka - internal - scam;
            
            // Проверяем на аномально большую прибыль
            if (Math.abs(profit) > 50000) {
                console.warn(`Аномально большая прибыль: ${profit}, обнуляем`);
                profit = 0;
            }
            
            return { endSum, startSum, dokidka, internal, scam, profit };
        }

        // --- Сохранять историю балансов в localStorage ---
        function saveAccountBalanceHistoryToStorage() {
            try {
                localStorage.setItem('accountBalanceHistory', JSON.stringify(window.accountBalanceHistory));
            } catch {}
        }
        function loadAccountBalanceHistoryFromStorage() {
            try {
                const data = localStorage.getItem('accountBalanceHistory');
                if (data) window.accountBalanceHistory = JSON.parse(data);
            } catch {}
        }
        // Загружаем историю при старте
        loadAccountBalanceHistoryFromStorage();

        function App() {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [dashboardData, setDashboardData] = useState(null);
            const [employees, setEmployees] = useState([]);
            const [reports, setReports] = useState([]);
            const [loading, setLoading] = useState(true);
            const [settingsVisible, setSettingsVisible] = useState(false);
            const [settingsPassword, setSettingsPassword] = useState('');
            const [settingsAuthed, setSettingsAuthed] = useState(false);
            const [settingsInitialBalances, setSettingsInitialBalances] = useState([]);
            const [settingsAccounts, setSettingsAccounts] = useState([]);
            const [settingsLoading, setSettingsLoading] = useState(false);
            const [stats, setStats] = useState([]);
            const [statsStart, setStatsStart] = useState(() => {
                const d = new Date();
                return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-01';
            });
            const [statsEnd, setStatsEnd] = useState(() => {
                const d = new Date();
                return d.toISOString().slice(0,10);
            });
            const [statsLoading, setStatsLoading] = useState(false);
            const [globalAuthed, setGlobalAuthed] = useState(false);
            const [globalPassword, setGlobalPassword] = useState('');
            const [globalError, setGlobalError] = useState('');
            const [showDetails, setShowDetails] = useState({id: null, type: null});

            // Фиксированный список площадок
            const platforms = [
                { id: 1, name: 'Bybit', type: 'exchange' },
                { id: 2, name: 'HTX', type: 'exchange' },
                { id: 3, name: 'Bliss', type: 'arbitrage' },
                { id: 4, name: 'Gate', type: 'arbitrage' }
            ];

            // Проверяем аутентификацию при загрузке
            useEffect(() => {
                const isAuthenticated = sessionStorage.getItem('authenticated');
                if (isAuthenticated === 'true') {
                    setGlobalAuthed(true);
                }
            }, []);

            useEffect(() => {
                if (globalAuthed) {
                loadData();
                // Загружаем начальные балансы при старте приложения
                fetch('/api/settings/balances').then(r => r.json()).then(balances => {
                    window.settingsInitialBalances = balances;
                });
                }
            }, [activeTab, globalAuthed]);

            useEffect(() => {
                if (activeTab === 'settings' && settingsAuthed && globalAuthed) {
                    setSettingsLoading(true);
                    fetch('/api/accounts').then(r => r.json()).then(setSettingsAccounts);
                    fetch('/api/settings/balances').then(r => r.json()).then(balances => {
                        setSettingsInitialBalances(balances);
                        window.settingsInitialBalances = balances;
                        setSettingsLoading(false);
                    });
                }
            }, [activeTab, settingsAuthed, globalAuthed]);

            useEffect(() => {
                if (activeTab === 'statistics' && globalAuthed) {
                    setStatsLoading(true);
                    fetch(`/api/statistics?start_date=${statsStart}&end_date=${statsEnd}`)
                        .then(r => r.json())
                        .then(data => { setStats(data); setStatsLoading(false); });
                }
            }, [activeTab, statsStart, statsEnd, globalAuthed]);

            const loadData = async () => {
                try {
                    const [dashboardRes, employeesRes, reportsRes] = await Promise.all([
                        fetch('/api/dashboard'),
                        fetch('/api/employees'),
                        fetch('/api/reports')
                    ]);

                    const dashboard = await dashboardRes.json();
                    const employeesData = await employeesRes.json();
                    const reportsData = await reportsRes.json();

                    setDashboardData(dashboard);
                    setEmployees(employeesData);
                    setReports(reportsData);
                    setLoading(false);
                } catch (error) {
                    console.error('Error loading data:', error);
                    setLoading(false);
                }
            };

            const handleLogin = () => {
                // Use Flask API instead of process.env.APP_PASSWORD
                fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: globalPassword })
                })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        setGlobalAuthed(true);
                        setGlobalError('');
                        sessionStorage.setItem('authenticated', 'true');
                    } else {
                        setGlobalError('Неверный пароль!');
                    }
                })
                .catch(err => {
                    console.error('Login error:', err);
                    setGlobalError('Ошибка при входе в систему');
                });
            };

            const handleLogout = () => {
                setGlobalAuthed(false);
                setGlobalPassword('');
                setGlobalError('');
                sessionStorage.removeItem('authenticated');
                setDashboardData(null);
                setEmployees([]);
                setReports([]);
                setLoading(true);
            };

            // Если не аутентифицирован, показываем форму входа
            if (!globalAuthed) {
                return (
                    <div className="container">
                        <div className="header">
                            <h1><i className="fas fa-coins"></i> Birch Team</h1>
                            <p>Мониторинг и аналитика P2P арбитражной команды</p>
                        </div>
                        <div className="card" style={{maxWidth: 400, margin: '40px auto', textAlign: 'center'}}>
                            <h3><i className="fas fa-lock"></i> Вход в систему</h3>
                            <div className="form-group">
                                <input 
                                    type="password" 
                                    className="form-control" 
                                    placeholder="Введите пароль" 
                                    value={globalPassword} 
                                    onChange={e => setGlobalPassword(e.target.value)}
                                    onKeyPress={e => e.key === 'Enter' && handleLogin()}
                                    style={{margin: '20px 0'}} 
                                />
                            </div>
                            <button className="btn" onClick={handleLogin}>
                                <i className="fas fa-sign-in-alt"></i> Войти
                            </button>
                            {globalError && <div style={{color: '#e74c3c', marginTop: 10}}>{globalError}</div>}
                        </div>
                    </div>
                );
            }

            if (loading) {
                return (
                    <div className="container">
                        <div className="loading">
                            <i className="fas fa-spinner fa-spin fa-2x"></i>
                            <p>Загрузка данных...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="container">
                    <div className="header">
                        <h1><i className="fas fa-coins"></i> Birch Team</h1>
                        <p>Мониторинг и аналитика P2P арбитражной команды</p>
                        <button className="logout-btn" onClick={handleLogout}>
                            <i className="fas fa-sign-out-alt"></i> Выйти
                        </button>
                    </div>

                    <div className="nav-tabs">
                        <div className={`nav-tab ${activeTab === 'dashboard' ? 'active' : ''}`} 
                             onClick={() => setActiveTab('dashboard')}>
                            <i className="fas fa-tachometer-alt"></i> Дашборд
                        </div>
                        <div className={`nav-tab ${activeTab === 'employees' ? 'active' : ''}`} 
                             onClick={() => setActiveTab('employees')}>
                            <i className="fas fa-users"></i> Сотрудники
                        </div>
                        <div className={`nav-tab ${activeTab === 'platforms' ? 'active' : ''}`} 
                             onClick={() => setActiveTab('platforms')}>
                            <i className="fas fa-exchange-alt"></i> Площадки
                        </div>
                        <div className={`nav-tab ${activeTab === 'reports' ? 'active' : ''}`} 
                             onClick={() => setActiveTab('reports')}>
                            <i className="fas fa-file-alt"></i> Отчеты
                        </div>
                        <div className={`nav-tab ${activeTab === 'settings' ? 'active' : ''}`} onClick={() => setActiveTab('settings')}>
                            <i className="fas fa-cog"></i> Настройки
                        </div>
                        <div className={`nav-tab ${activeTab === 'statistics' ? 'active' : ''}`} onClick={() => setActiveTab('statistics')}>
                            <i className="fas fa-chart-pie"></i> Статистика
                        </div>
                        <div className={`nav-tab ${activeTab === 'platformBalances' ? 'active' : ''}`} onClick={() => setActiveTab('platformBalances')}>
                            <i className="fas fa-coins"></i> Балансы площадок
                        </div>
                        <div className={`nav-tab ${activeTab === 'accountBalanceHistory' ? 'active' : ''}`} onClick={() => setActiveTab('accountBalanceHistory')}>
                            <i className="fas fa-database"></i> История балансов
                        </div>
                        <div className={`nav-tab ${activeTab === 'orders' ? 'active' : ''}`} onClick={() => setActiveTab('orders')}>
                            <i className="fas fa-list-alt"></i> История ордеров
                        </div>
                    </div>

                    {activeTab === 'dashboard' && <Dashboard data={dashboardData} />}
                    {activeTab === 'employees' && <Employees employees={employees} onUpdate={loadData} />}
                    {activeTab === 'platforms' && <Platforms platforms={platforms} employees={employees} onUpdate={loadData} />}
                    {activeTab === 'reports' && <Reports reports={reports} employees={employees} platforms={platforms} onUpdate={loadData} />}
                    {activeTab === 'settings' && (
                        <Settings
                            authed={settingsAuthed}
                            setAuthed={setSettingsAuthed}
                            password={settingsPassword}
                            setPassword={setSettingsPassword}
                            initialBalances={settingsInitialBalances}
                            setInitialBalances={setSettingsInitialBalances}
                            accounts={settingsAccounts}
                            loading={settingsLoading}
                        />
                    )}
                    {activeTab === 'statistics' && (
                        <Statistics
                            stats={stats}
                            start={statsStart}
                            end={statsEnd}
                            setStart={setStatsStart}
                            setEnd={setStatsEnd}
                            loading={statsLoading}
                        />
                    )}
                    {activeTab === 'platformBalances' && <PlatformBalances />}
                    {activeTab === 'accountBalanceHistory' && <AccountBalanceHistoryViewer accounts={settingsAccounts || []} employees={employees} />}
                    {activeTab === 'orders' && <OrdersHistory employees={employees} />}
                </div>
            );
        }

        function Dashboard({ data: initialData }) {
            const [chart, setChart] = useState(null);
            const [startDate, setStartDate] = useState(() => {
                const d = new Date();
                return d.toISOString().slice(0,10);
            });
            const [endDate, setEndDate] = useState(() => {
                const d = new Date();
                return d.toISOString().slice(0,10);
            });
            const [data, setData] = useState(initialData);
            const [currentTime, setCurrentTime] = useState(new Date());
            
            useEffect(() => { setData(initialData); }, [initialData]);

            // --- Новый useEffect для загрузки данных по выбранным датам ---
            useEffect(() => {
                fetch(`/api/dashboard?start_date=${startDate}&end_date=${endDate}`)
                    .then(r => r.json())
                    .then(setData);
            }, [startDate, endDate]);

            // Обновление времени каждую секунду
            useEffect(() => {
                const timer = setInterval(() => {
                    setCurrentTime(new Date());
                }, 1000);
                return () => clearInterval(timer);
            }, []);

            const [showChart, setShowChart] = useState(false);
            const [chartReady, setChartReady] = useState(false);
            useEffect(() => {
                setChartReady(false);
                if (data && data.reports && data.reports.length > 0) {
                    const timer = setTimeout(() => setChartReady(true), 400);
                    return () => clearTimeout(timer);
                }
            }, [data]);

            if (!data) return <div className="loading">Нет данных</div>;

            // Форматирование времени и даты
            const formatTime = (date) => {
                return date.toLocaleTimeString('ru-RU', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
            };

            const formatDate = (date) => {
                return date.toLocaleDateString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
            };

            const formatDayOfWeek = (date) => {
                const days = ['Воскресенье', 'Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота'];
                return days[date.getDay()];
            };

            return (
                <div>
                    <div className="stats-grid" style={{
                        display: 'flex',
                        justifyContent: 'center',
                        alignItems: 'center',
                        marginBottom: '30px'
                    }}>
                        <div className="stat-card" style={{
                            background: 'linear-gradient(135deg, #00b894 0%, #00a085 50%, #00d4aa 100%)',
                            color: 'white',
                            borderRadius: '25px',
                            padding: '50px 60px',
                            textAlign: 'center',
                            boxShadow: '0 20px 60px rgba(0, 184, 148, 0.4), 0 0 100px rgba(0, 212, 170, 0.2)',
                            position: 'relative',
                            overflow: 'hidden',
                            border: '2px solid rgba(255, 255, 255, 0.2)',
                            backdropFilter: 'blur(10px)',
                            transform: 'perspective(1000px) rotateX(3deg)',
                            transition: 'all 0.3s ease',
                            width: '100%',
                            maxWidth: '600px',
                            minHeight: '200px',
                            display: 'flex',
                            flexDirection: 'column',
                            justifyContent: 'center',
                            alignItems: 'center'
                        }}>
                            {/* Декоративные элементы */}
                            <div style={{
                                position: 'absolute',
                                top: '-60px',
                                right: '-60px',
                                width: '120px',
                                height: '120px',
                                background: 'radial-gradient(circle, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 70%, transparent 100%)',
                                borderRadius: '50%',
                                animation: 'pulse 3s infinite ease-in-out',
                                filter: 'blur(2px)'
                            }}></div>
                            <div style={{
                                position: 'absolute',
                                bottom: '-40px',
                                left: '-40px',
                                width: '80px',
                                height: '80px',
                                background: 'radial-gradient(circle, rgba(0, 212, 170, 0.2) 0%, rgba(0, 212, 170, 0.05) 70%, transparent 100%)',
                                borderRadius: '50%',
                                animation: 'pulse 4s infinite ease-in-out',
                                filter: 'blur(3px)'
                            }}></div>
                            
                            {/* Частицы */}
                            {[...Array(4)].map((_, i) => (
                                <div key={i} style={{
                                    position: 'absolute',
                                    width: '3px',
                                    height: '3px',
                                    background: 'rgba(255, 255, 255, 0.8)',
                                    borderRadius: '50%',
                                    top: `${25 + i * 20}%`,
                                    left: `${15 + i * 20}%`,
                                    animation: `float ${2.5 + i * 0.5}s infinite ease-in-out`,
                                    animationDelay: `${i * 0.3}s`
                                }}></div>
                            ))}
                            
                            {/* Иконка и заголовок */}
                            <div style={{
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                gap: '20px',
                                marginBottom: '30px',
                                position: 'relative',
                                zIndex: 2
                            }}>
                                <div style={{
                                    background: 'rgba(255, 255, 255, 0.2)',
                                    borderRadius: '50%',
                                    width: '60px',
                                    height: '60px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    boxShadow: '0 0 25px rgba(255, 255, 255, 0.4)',
                                    animation: 'glow 2s infinite alternate'
                                }}>
                                    <i className="fas fa-coins" style={{fontSize: '28px', color: 'white'}}></i>
                        </div>
                                <h3 style={{
                                    margin: 0, 
                                    fontSize: '32px', 
                                    fontWeight: 700,
                                    textShadow: '0 0 20px rgba(255, 255, 255, 0.6)',
                                    background: 'linear-gradient(45deg, #fff, #f0f0f0)',
                                    WebkitBackgroundClip: 'text',
                                    WebkitTextFillColor: 'transparent',
                                    backgroundClip: 'text'
                                }}>Общая прибыль</h3>
                        </div>
                            
                            {/* Сумма с эффектом свечения */}
                            <div style={{
                                fontSize: '72px',
                                fontWeight: 900,
                                marginBottom: '20px',
                                fontFamily: 'monospace',
                                textShadow: '0 0 35px rgba(255, 255, 255, 0.9), 0 0 70px rgba(0, 184, 148, 0.7)',
                                background: 'linear-gradient(45deg, #fff, #f0f0f0, #fff)',
                                WebkitBackgroundClip: 'text',
                                WebkitTextFillColor: 'transparent',
                                backgroundClip: 'text',
                                animation: 'textGlow 2s infinite alternate',
                                position: 'relative',
                                zIndex: 2
                            }}>
                                ${(data.month_total_profit ?? 0).toFixed(2)}
                    </div>

                            {/* Подпись */}
                            <div style={{
                                fontSize: '20px',
                                fontWeight: 600,
                                opacity: 0.95,
                                background: 'rgba(255, 255, 255, 0.15)',
                                padding: '10px 25px',
                                borderRadius: '15px',
                                backdropFilter: 'blur(10px)',
                                border: '1px solid rgba(255, 255, 255, 0.3)',
                                position: 'relative',
                                zIndex: 2
                            }}>
                                за месяц
                            </div>
                        </div>
                    </div>

                    <div style={{display:'flex',gap:30,justifyContent:'space-between',marginTop:30,flexWrap:'wrap'}}>
                                                {/* Первый отдел */}
                        <div className="card" style={{
                            flex:'1',
                            minWidth:450,
                            background: 'linear-gradient(135deg, #2c3e50 0%, #34495e 50%, #3498db 100%)',
                            color: 'white',
                            borderRadius: '20px',
                            padding: '30px',
                            boxShadow: '0 15px 40px rgba(44, 62, 80, 0.3), 0 0 60px rgba(52, 152, 219, 0.1)',
                            position: 'relative',
                            overflow: 'hidden',
                            border: '1px solid rgba(255, 255, 255, 0.1)',
                            backdropFilter: 'blur(10px)',
                            transform: 'perspective(1000px) rotateX(3deg)',
                            transition: 'all 0.3s ease'
                        }}>
                            <div style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '15px',
                                marginBottom: '25px',
                                position: 'relative',
                                zIndex: 2
                            }}>
                                <div style={{
                                    background: 'rgba(255, 255, 255, 0.1)',
                                    borderRadius: '50%',
                                    width: '45px',
                                    height: '45px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    boxShadow: '0 0 15px rgba(255, 255, 255, 0.2)',
                                    animation: 'glow 3s infinite alternate'
                                }}>
                                    <i className="fas fa-trophy" style={{fontSize: '20px', color: '#f39c12'}}></i>
                                </div>
                                <h3 style={{
                                    margin: 0, 
                                    fontSize: '22px', 
                                    fontWeight: 600,
                                    color: 'white',
                                    textShadow: '0 1px 3px rgba(0, 0, 0, 0.3)'
                                }}>Топ-3 сотрудника по прибыли (1-й отдел)</h3>
                            </div>
                            
                            <div style={{display:'flex',gap:20,justifyContent:'flex-start',flexWrap:'wrap',position:'relative',zIndex:2}}>
                                {(data.employee_stats_by_department?.first_department || []).slice().sort((a,b)=>Number(b.net_profit||0)-Number(a.net_profit||0)).slice(0,3).map((emp, idx) => (
                                    <div key={emp.id || emp.name} style={{
                                        background: 'rgba(255, 255, 255, 0.95)',
                                        borderRadius: '15px',
                                        padding: '20px 25px',
                                        minWidth: 240,
                                        boxShadow: '0 8px 25px rgba(0, 0, 0, 0.15)',
                                        display: 'flex',
                                        flexDirection: 'column',
                                        alignItems: 'center',
                                        position: 'relative',
                                        border: '1px solid rgba(52, 152, 219, 0.2)',
                                        transition: 'all 0.3s ease',
                                        transform: 'perspective(1000px) rotateY(2deg)'
                                    }}>
                                        <div style={{
                                            position: 'absolute',
                                            top: '12px',
                                            right: '15px',
                                            fontSize: '24px',
                                            fontWeight: 700
                                        }} title={`Место #${idx+1}`}>{['🥇','🥈','🥉'][idx]}</div>
                                        
                                        <div style={{
                                            fontWeight: 700,
                                            fontSize: '1.2em',
                                            marginBottom: '6px',
                                            color: '#2c3e50'
                                        }}>{emp.name}</div>
                                        
                                        <div style={{
                                            color: '#7f8c8d',
                                            marginBottom: '10px',
                                            fontSize: '0.9em',
                                            fontWeight: 500
                                        }}>Смен: {emp.total_shifts ?? '-'}</div>
                                        
                                        <div style={{
                                            fontSize: '1.6em',
                                            fontWeight: 700,
                                            color: '#27ae60',
                                            marginBottom: '6px'
                                        }} title="Суммарная прибыль за смены">
                                      {(Number(emp.net_profit) >= 0 ? '+' : '') + (Number(emp.net_profit) || 0).toFixed(2)} USDT
                                    </div>
                                        
                                        <div style={{
                                            color: '#3498db',
                                            fontSize: '1em',
                                            fontWeight: 600
                                        }}>
                                      Средняя за смену: {(emp.total_shifts ? ((Number(emp.net_profit)||0)/emp.total_shifts).toFixed(2) : '—')} USDT
                                    </div>
                                </div>
                            ))}
                            </div>
                        </div>
                        
                        {/* Второй отдел */}
                        <div className="card" style={{
                            flex:'1',
                            minWidth:450,
                            background: 'linear-gradient(135deg, #34495e 0%, #2c3e50 50%, #e74c3c 100%)',
                            color: 'white',
                            borderRadius: '20px',
                            padding: '30px',
                            boxShadow: '0 15px 40px rgba(52, 73, 94, 0.3), 0 0 60px rgba(231, 76, 60, 0.1)',
                            position: 'relative',
                            overflow: 'hidden',
                            border: '1px solid rgba(255, 255, 255, 0.1)',
                            backdropFilter: 'blur(10px)',
                            transform: 'perspective(1000px) rotateX(3deg)',
                            transition: 'all 0.3s ease'
                        }}>
                            <div style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '15px',
                                marginBottom: '25px',
                                position: 'relative',
                                zIndex: 2
                            }}>
                                <div style={{
                                    background: 'rgba(255, 255, 255, 0.1)',
                                    borderRadius: '50%',
                                    width: '45px',
                                    height: '45px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    boxShadow: '0 0 15px rgba(255, 255, 255, 0.2)',
                                    animation: 'glow 3s infinite alternate'
                                }}>
                                    <i className="fas fa-trophy" style={{fontSize: '20px', color: '#e74c3c'}}></i>
                                </div>
                                <h3 style={{
                                    margin: 0, 
                                    fontSize: '22px', 
                                    fontWeight: 600,
                                    color: 'white',
                                    textShadow: '0 1px 3px rgba(0, 0, 0, 0.3)'
                                }}>Топ-3 сотрудника по прибыли (2-й отдел)</h3>
                            </div>
                            
                            <div style={{display:'flex',gap:20,justifyContent:'flex-start',flexWrap:'wrap',position:'relative',zIndex:2}}>
                                {(data.employee_stats_by_department?.second_department || []).slice().sort((a,b)=>Number(b.net_profit||0)-Number(a.net_profit||0)).slice(0,3).map((emp, idx) => (
                                    <div key={emp.id || emp.name} style={{
                                        background: 'rgba(255, 255, 255, 0.95)',
                                        borderRadius: '15px',
                                        padding: '20px 25px',
                                        minWidth: 240,
                                        boxShadow: '0 8px 25px rgba(0, 0, 0, 0.15)',
                                        display: 'flex',
                                        flexDirection: 'column',
                                        alignItems: 'center',
                                        position: 'relative',
                                        border: '1px solid rgba(231, 76, 60, 0.2)',
                                        transition: 'all 0.3s ease',
                                        transform: 'perspective(1000px) rotateY(-2deg)'
                                    }}>
                                        <div style={{
                                            position: 'absolute',
                                            top: '12px',
                                            right: '15px',
                                            fontSize: '24px',
                                            fontWeight: 700
                                        }} title={`Место #${idx+1}`}>{['🥇','🥈','🥉'][idx]}</div>
                                        
                                        <div style={{
                                            fontWeight: 700,
                                            fontSize: '1.2em',
                                            marginBottom: '6px',
                                            color: '#2c3e50'
                                        }}>{emp.name}</div>
                                        
                                        <div style={{
                                            color: '#7f8c8d',
                                            marginBottom: '10px',
                                            fontSize: '0.9em',
                                            fontWeight: 500
                                        }}>Смен: {emp.total_shifts ?? '-'}</div>
                                        
                                        <div style={{
                                            fontSize: '1.6em',
                                            fontWeight: 700,
                                            color: '#27ae60',
                                            marginBottom: '6px'
                                        }} title="Суммарная прибыль за смены">
                                          {(Number(emp.net_profit) >= 0 ? '+' : '') + (Number(emp.net_profit) || 0).toFixed(2)} USDT
                                        </div>
                                        
                                        <div style={{
                                            color: '#3498db',
                                            fontSize: '1em',
                                            fontWeight: 600
                                        }}>
                                          Средняя за смену: {(emp.total_shifts ? ((Number(emp.net_profit)||0)/emp.total_shifts).toFixed(2) : '—')} USDT
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* Блок с текущим временем */}
                    <div style={{marginTop: 24}}>
                        <div className="card" style={{
                            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%)',
                            color: 'white',
                            borderRadius: '25px',
                            padding: '40px',
                            textAlign: 'center',
                            boxShadow: '0 20px 60px rgba(102, 126, 234, 0.4), 0 0 100px rgba(240, 147, 251, 0.2)',
                            position: 'relative',
                            overflow: 'hidden',
                            border: '2px solid rgba(255, 255, 255, 0.2)',
                            backdropFilter: 'blur(10px)',
                            transform: 'perspective(1000px) rotateX(5deg)',
                            transition: 'all 0.3s ease'
                        }}>
                            {/* Анимированные декоративные элементы */}
                            <div style={{
                                position: 'absolute',
                                top: '-80px',
                                right: '-80px',
                                width: '160px',
                                height: '160px',
                                background: 'radial-gradient(circle, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 70%, transparent 100%)',
                                borderRadius: '50%',
                                animation: 'pulse 3s infinite ease-in-out',
                                filter: 'blur(2px)'
                            }}></div>
                            <div style={{
                                position: 'absolute',
                                bottom: '-60px',
                                left: '-60px',
                                width: '120px',
                                height: '120px',
                                background: 'radial-gradient(circle, rgba(240, 147, 251, 0.2) 0%, rgba(240, 147, 251, 0.05) 70%, transparent 100%)',
                                borderRadius: '50%',
                                animation: 'pulse 4s infinite ease-in-out',
                                filter: 'blur(3px)'
                            }}></div>
                            <div style={{
                                position: 'absolute',
                                top: '50%',
                                left: '50%',
                                transform: 'translate(-50%, -50%)',
                                width: '200px',
                                height: '200px',
                                background: 'radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%)',
                                borderRadius: '50%',
                                animation: 'pulse 5s infinite ease-in-out',
                                filter: 'blur(4px)'
                            }}></div>
                            
                            {/* Частицы */}
                            {[...Array(6)].map((_, i) => (
                                <div key={i} style={{
                                    position: 'absolute',
                                    width: '4px',
                                    height: '4px',
                                    background: 'rgba(255, 255, 255, 0.8)',
                                    borderRadius: '50%',
                                    top: `${20 + i * 15}%`,
                                    left: `${10 + i * 15}%`,
                                    animation: `float ${3 + i * 0.5}s infinite ease-in-out`,
                                    animationDelay: `${i * 0.2}s`
                                }}></div>
                            ))}
                            
                            {/* Заголовок с эффектом свечения */}
                            <div style={{
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                gap: '20px',
                                marginBottom: '25px',
                                position: 'relative',
                                zIndex: 2
                            }}>
                                <div style={{
                                    background: 'rgba(255, 255, 255, 0.2)',
                                    borderRadius: '50%',
                                    width: '50px',
                                    height: '50px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    boxShadow: '0 0 20px rgba(255, 255, 255, 0.3)',
                                    animation: 'glow 2s infinite alternate'
                                }}>
                                    <i className="fas fa-clock" style={{fontSize: '24px', color: 'white'}}></i>
                                </div>
                                <h3 style={{
                                    margin: 0, 
                                    fontSize: '32px', 
                                    fontWeight: 700,
                                    textShadow: '0 0 20px rgba(255, 255, 255, 0.5)',
                                    background: 'linear-gradient(45deg, #fff, #f0f0f0)',
                                    WebkitBackgroundClip: 'text',
                                    WebkitTextFillColor: 'transparent',
                                    backgroundClip: 'text'
                                }}>Текущее время</h3>
                            </div>
                            
                            {/* Время с эффектом неонового свечения */}
                            <div style={{
                                fontSize: '64px',
                                fontWeight: 900,
                                marginBottom: '15px',
                                fontFamily: 'monospace',
                                textShadow: '0 0 30px rgba(255, 255, 255, 0.8), 0 0 60px rgba(102, 126, 234, 0.6)',
                                background: 'linear-gradient(45deg, #fff, #f0f0f0, #fff)',
                                WebkitBackgroundClip: 'text',
                                WebkitTextFillColor: 'transparent',
                                backgroundClip: 'text',
                                animation: 'textGlow 2s infinite alternate',
                                position: 'relative',
                                zIndex: 2
                            }}>
                                {formatTime(currentTime)}
                            </div>
                            
                            {/* Дата с красивым оформлением */}
                            <div style={{
                                fontSize: '24px',
                                fontWeight: 600,
                                marginBottom: '12px',
                                opacity: 0.95,
                                textShadow: '0 2px 10px rgba(0, 0, 0, 0.3)',
                                background: 'rgba(255, 255, 255, 0.1)',
                                padding: '8px 20px',
                                borderRadius: '15px',
                                backdropFilter: 'blur(10px)',
                                border: '1px solid rgba(255, 255, 255, 0.2)',
                                position: 'relative',
                                zIndex: 2
                            }}>
                                {formatDate(currentTime)}
                            </div>
                            
                            {/* День недели с градиентным текстом */}
                            <div style={{
                                fontSize: '20px',
                                fontWeight: 500,
                                opacity: 0.9,
                                fontStyle: 'italic',
                                background: 'linear-gradient(45deg, #fff, #e0e0e0)',
                                WebkitBackgroundClip: 'text',
                                WebkitTextFillColor: 'transparent',
                                backgroundClip: 'text',
                                textShadow: '0 2px 8px rgba(0, 0, 0, 0.2)',
                                position: 'relative',
                                zIndex: 2
                            }}>
                                {formatDayOfWeek(currentTime)}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function Employees({ employees, onUpdate }) {
            const [showForm, setShowForm] = useState(false);
            const [formData, setFormData] = useState({
                name: '',
                telegram: ''
            });

            const handleSubmit = async (e) => {
                e.preventDefault();
                try {
                    const response = await fetch('/api/employees', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                    if (response.ok) {
                        setFormData({ name: '', telegram: '' });
                        setShowForm(false);
                        onUpdate();
                    }
                } catch (error) {
                    console.error('Error creating employee:', error);
                }
            };

            const handleDelete = async (id) => {
                const password = prompt('Для удаления сотрудника введите пароль:');
                if (!password) return;
                try {
                    const response = await fetch(`/api/employees/${id}`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password })
                    });
                    if (response.ok) {
                        onUpdate();
                    } else {
                        const data = await response.json();
                        alert(data.error || 'Ошибка удаления');
                    }
                } catch (error) {
                    alert('Ошибка удаления');
                }
            };

            return (
                <div>
                    <div className="card">
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                            <h3><i className="fas fa-users"></i> Сотрудники</h3>
                            <button className="btn" onClick={() => setShowForm(!showForm)}>
                                <i className="fas fa-plus"></i> Добавить сотрудника
                            </button>
                        </div>

                        {showForm && (
                            <form onSubmit={handleSubmit} style={{ marginBottom: '20px', padding: '20px', background: '#f8f9fa', borderRadius: '10px' }}>
                                <div className="form-group">
                                    <label>Имя сотрудника</label>
                                    <input
                                        type="text"
                                        className="form-control"
                                        value={formData.name}
                                        onChange={(e) => setFormData({...formData, name: e.target.value})}
                                        required
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Ник Telegram</label>
                                    <input
                                        type="text"
                                        className="form-control"
                                        value={formData.telegram}
                                        onChange={(e) => setFormData({...formData, telegram: e.target.value})}
                                        required
                                    />
                                </div>
                                <button type="submit" className="btn">Сохранить</button>
                                <button type="button" className="btn btn-secondary" onClick={() => setShowForm(false)}>Отмена</button>
                            </form>
                        )}

                        <table className="table">
                            <thead>
                                <tr>
                                    <th>Имя</th>
                                    <th>Ник Telegram</th>
                                    <th>Дата добавления</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                {employees.map(emp => (
                                    <tr key={emp.id}>
                                        <td>{emp.name}</td>
                                        <td>{emp.telegram}</td>
                                        <td>{new Date(emp.created_at).toLocaleDateString('ru-RU')}</td>
                                        <td>
                                            <button className="btn btn-secondary" onClick={() => handleDelete(emp.id)} style={{padding:'4px 10px',fontSize:'0.9em'}}>Удалить</button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        function Platforms({ platforms, employees, onUpdate }) {
            const [showForm, setShowForm] = useState(false);
            const [accounts, setAccounts] = useState([]);
            const [formData, setFormData] = useState({
                platform: '',
                account_name: ''
            });
            const platformOptions = [
                { value: 'bybit', label: 'Bybit' },
                { value: 'htx', label: 'HTX' },
                { value: 'bliss', label: 'Bliss' },
                { value: 'gate', label: 'Gate' }
            ];

            useEffect(() => {
                fetch('/api/accounts').then(r => r.json()).then(setAccounts);
            }, [showForm]);

            const handleSubmit = async (e) => {
                e.preventDefault();
                try {
                    // Добавляем аккаунт
                    const response = await fetch('/api/accounts', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            platform: formData.platform,
                            account_name: formData.account_name
                        })
                    });
                    if (response.ok) {
                        setFormData({ platform: '', account_name: '' });
                        setShowForm(false);
                        fetch('/api/accounts').then(r => r.json()).then(setAccounts);
                        if (onUpdate) onUpdate();
                    }
                } catch (error) {
                    console.error('Error creating account:', error);
                }
            };

            const handleDelete = async (id) => {
                const password = prompt('Для удаления аккаунта введите пароль:');
                if (!password) return;
                try {
                    const response = await fetch(`/api/accounts/${id}`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password })
                    });
                    if (response.ok) {
                        fetch('/api/accounts').then(r => r.json()).then(setAccounts);
                        if (onUpdate) onUpdate();
                    } else {
                        const data = await response.json();
                        alert(data.error || 'Ошибка удаления');
                    }
                } catch (error) {
                    alert('Ошибка удаления');
                }
            };

            return (
                <div>
                    <div className="card">
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                            <h3><i className="fas fa-exchange-alt"></i> Аккаунты площадок</h3>
                            <button className="btn" onClick={() => setShowForm(!showForm)}>
                                <i className="fas fa-plus"></i> Добавить аккаунт
                            </button>
                        </div>

                        {showForm && (
                            <form onSubmit={handleSubmit} style={{ marginBottom: '20px', padding: '20px', background: '#f8f9fa', borderRadius: '10px' }}>
                                <div className="form-group">
                                    <label>Площадка</label>
                                    <select className="form-control" value={formData.platform} onChange={e => setFormData({ ...formData, platform: e.target.value })} required>
                                        <option value="">Выберите площадку</option>
                                        {platformOptions.map(opt => (
                                            <option key={opt.value} value={opt.value}>{opt.label}</option>
                                        ))}
                                    </select>
                                </div>
                                <div className="form-group">
                                    <label>Название аккаунта</label>
                                    <input
                                        type="text"
                                        className="form-control"
                                        value={formData.account_name}
                                        onChange={e => setFormData({ ...formData, account_name: e.target.value })}
                                        required
                                    />
                                </div>
                                <button type="submit" className="btn">Сохранить</button>
                                <button type="button" className="btn btn-secondary" onClick={() => setShowForm(false)}>Отмена</button>
                            </form>
                        )}

                        <table className="table">
                            <thead>
                                <tr>
                                    <th>Площадка</th>
                                    <th>Название аккаунта</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                {accounts.map(acc => (
                                    <tr key={acc.id}>
                                        <td>{platformOptions.find(opt => opt.value === acc.platform)?.label || acc.platform}</td>
                                        <td>{acc.account_name}</td>
                                        <td>
                                            <button className="btn btn-secondary" onClick={() => handleDelete(acc.id)} style={{padding:'4px 10px',fontSize:'0.9em'}}>Удалить</button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        function Reports({ reports: initialReports, employees, platforms, onUpdate }) {
            // 1. All useState hooks in a consistent order
            const [showForm, setShowForm] = useState(false);
            const [reports, setReports] = useState(initialReports || []);
            const [accounts, setAccounts] = useState([]);
            const [expandedReportId, setExpandedReportId] = useState(null);
            const [zoomedImage, setZoomedImage] = useState(null);
            const [showDetails, setShowDetails] = useState({id: null, type: null});
            const [filters, setFilters] = useState({
                start_date: '',
                end_date: '',
                employee_id: '',
                department: '' // новый фильтр
            });
            const [formData, setFormData] = useState({
                employee_id: '',
                shift_date: new Date().toISOString().split('T')[0], // Текущая дата по умолчанию
                shift_type: 'morning', // Тип смены (morning/night)
                department: 'first', // Отдел (first/second)
                shift_start_time: '',
                shift_end_time: '',
                selectedAccounts: {},
                availableAccounts: {},
                accountFiles: {},
                scam_amount: 0,
                scam_amount_rub: 0, // новое поле
                scam_platform: 'bybit', // новое поле
                scam_account: '', // новое поле
                scam_comment: '',
                scam_count_in_sales: false, // новое поле
                scam_count_in_purchases: false, // новое поле
                dokidka_amount: 0,
                dokidka_amount_rub: 0,
                dokidka_platform: 'bybit',
                dokidka_account: '',
                dokidka_comment: '',
                dokidka_count_in_sales: false, // новое поле
                dokidka_count_in_purchases: false, // новое поле
                internal_transfer_amount: 0,
                internal_transfer_amount_rub: 0, // новое поле
                internal_transfer_platform: 'bybit', // новое поле
                internal_transfer_account: '', // новое поле
                internal_transfer_comment: '',
                internal_transfer_count_in_sales: false, // новое поле
                internal_transfer_count_in_purchases: false, // новое поле
                appeal_amount: 0,
                appeal_amount_rub: 0,
                appeal_platform: 'bybit',
                appeal_account: '',
                appeal_comment: '',
                appeal_count_in_sales: false, // новое поле
                appeal_count_in_purchases: false, // новое поле
                start_photo: null,
                end_photo: null,
                balances: {
                    bybit: [],
                    htx: [],
                    bliss: [],
                    gate: []
                },
                gate_amounts: {}, // Суммы для Gate аккаунтов (USDT)
                gate_amounts_rub: {} // Суммы для Gate аккаунтов (RUB)
            });
            
            const [reportsStats, setReportsStats] = useState({});

            // Helper functions
            const loadReports = async () => {
                try {
                    const params = new URLSearchParams();
                    Object.entries(filters).forEach(([key, value]) => {
                        if (value) params.append(key, value);
                    });
                    const response = await fetch(`/api/reports?${params}`);
                    const data = await response.json();
                    setReports(data);
                    
                    // Очищаем кэш статистики при загрузке новых отчетов
                    if (window.reportsStatsCache) {
                        delete window.reportsStatsCache;
                    }
                } catch (error) {
                    console.error('Error loading reports:', error);
                }
            };

            // 2. All useEffect hooks
            useEffect(() => {
                loadReports();
                // Очищаем кэш статистики при изменении фильтров
                if (window.reportsStatsCache) {
                    delete window.reportsStatsCache;
                }
            }, [filters]); // Add filters dependency

            useEffect(() => {
                fetch('/api/accounts')
                    .then(r => r.json())
                    .then(setAccounts)
                    .catch(err => console.error('Ошибка загрузки аккаунтов:', err));
            }, []);

            useEffect(() => {
                // Загружаем все доступные аккаунты для формы создания отчёта
                fetch('/api/employee-accounts/0') // Передаем 0, так как аккаунты не привязаны к сотруднику
                    .then(r => r.json())
                    .then(data => {
                        setFormData(prev => ({...prev, availableAccounts: data.accounts || {}}));
                    })
                    .catch(err => console.error('Ошибка загрузки аккаунтов:', err));
            }, []);

            // Эффект для загрузки статистики всех отчетов
            useEffect(() => {
                if (!reports || reports.length === 0) {
                    setReportsStats({});
                    return;
                }

                // Создаем ключ для кэширования на основе данных отчетов
                const reportsKey = reports.map(r => `${r.id}-${r.shift_date}-${r.employee_id}`).join('|');
                
                // Проверяем, не загружали ли мы уже эту статистику
                if (window.reportsStatsCache && 
                    window.reportsStatsCache.key === reportsKey && 
                    Date.now() - window.reportsStatsCache.timestamp < 300000) { // 5 минут
                    setReportsStats(window.reportsStatsCache.data);
                    return;
                }

                const loadStats = async () => {
                    const stats = {};
                    const promises = [];
                    
                    // Создаем промисы для всех запросов
                    for (const report of reports) {
                        const promise = fetch(`/api/orders/statistics?start_date=${report.shift_date}&end_date=${report.shift_date}&employee_id=${report.employee_id}&exclude_canceled=true`)
                            .then(response => response.json())
                            .then(data => ({
                                reportId: report.id,
                                data: {
                                total_sales_rub: data.sell_volume,
                                total_sales_usdt: data.sell_volume_usdt,
                                total_purchases_rub: data.buy_volume,
                                total_purchases_usdt: data.buy_volume_usdt,
                                total_profit_usdt: data.profit_usdt,
                                avg_sale_price: data.avg_sell_rate,
                                    avg_purchase_price: data.avg_buy_rate,
                                    // Добавляем данные о докидках и переводах из отчета
                                    dokidka_amount: report.dokidka_amount || 0,
                                    internal_transfer_amount: report.internal_transfer_amount || 0,
                                    scam_amount: report.scam_amount || 0,
                                    // Общая сумма продаж с учетом переводов
                                    total_sales_with_transfers_usdt: data.total_sales_with_transfers_usdt || data.sell_volume_usdt
                                }
                            }))
                            .catch(error => {
                            console.error(`Error loading stats for report ${report.id}:`, error);
                                return { reportId: report.id, data: null };
                            });
                        
                        promises.push(promise);
                    }
                    
                    // Выполняем все запросы параллельно
                    const results = await Promise.all(promises);
                    
                    // Собираем результаты
                    results.forEach(result => {
                        if (result.data) {
                            stats[result.reportId] = result.data;
                        }
                    });
                    
                    // Кэшируем результат
                    window.reportsStatsCache = {
                        key: reportsKey,
                        data: stats,
                        timestamp: Date.now()
                    };
                    
                    setReportsStats(stats);
                };
                
                // Добавляем дебаунсинг для запросов статистики
                const timeoutId = setTimeout(() => {
                loadStats();
                }, 300); // Задержка 300мс
                
                return () => clearTimeout(timeoutId);
            }, [reports]);

            const handleAccountChange = (platform, selectedIds) => {
                setFormData(fd => {
                    // Список выбранных аккаунтов для этой платформы
                    const selectedAccounts = accounts
                        .filter(a => selectedIds.includes(a.id.toString()) && a.platform === platform)
                        .map(acc => {
                            // Если уже были введены балансы — сохраняем их
                            const existing = fd.balances[platform].find(a => a.id === acc.id);
                            return existing ? existing : { ...acc, start_balance: '', end_balance: '' };
                        });
                    return {
                        ...fd,
                        balances: {
                            ...fd.balances,
                            [platform]: selectedAccounts
                        }
                    };
                });
            };

            const handleBalanceChange = (platform, idx, field, value) => {
                setFormData(fd => {
                    const updated = [...fd.balances[platform]];
                    updated[idx][field] = value;
                    return {
                        ...fd,
                        balances: {
                            ...fd.balances,
                            [platform]: updated
                        }
                    };
                });
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                
                // Валидация базовых полей
                if (!formData.employee_id || !formData.shift_start_time || !formData.shift_end_time) {
                    alert('Заполните все обязательные поля: сотрудник, время начала и окончания смены');
                    return;
                }
                
                // Валидация даты
                    if (!formData.shift_date) {
                        alert('Заполните дату смены');
                        return;
                }

                // Простая валидация формата времени
                const timeRegex = /^([01]?[0-9]|2[0-3]):[0-5][0-9]$/;
                if (!timeRegex.test(formData.shift_start_time) || !timeRegex.test(formData.shift_end_time)) {
                    alert('Неверный формат времени. Используйте формат ЧЧ:ММ (например, 09:00)');
                    return;
                }
                
                // Проверяем, что выбраны аккаунты и загружены соответствующие файлы
                let hasSelectedAccounts = false;
                let missingFiles = [];
                let missingGateAmounts = [];
                
                ['bybit', 'htx', 'bliss', 'gate'].forEach(platform => {
                    if (formData.selectedAccounts[platform] && formData.selectedAccounts[platform].length > 0) {
                        hasSelectedAccounts = true;
                        
                        if (platform === 'gate') {
                            // Для Gate проверяем, что введены суммы
                            formData.selectedAccounts[platform].forEach(accountId => {
                                if (!formData.gate_amounts?.[accountId] || formData.gate_amounts[accountId] === '') {
                                    const account = formData.availableAccounts[platform]?.find(acc => acc.id === accountId);
                                    missingGateAmounts.push(`${platform.toUpperCase()} - ${account?.account_name}`);
                                }
                            });
                        } else {
                            // Для остальных площадок проверяем, что загружены файлы
                            formData.selectedAccounts[platform].forEach(accountId => {
                                const fileKey = `${platform}_${accountId}`;
                                if (!formData.accountFiles[fileKey]) {
                                    const account = formData.availableAccounts[platform]?.find(acc => acc.id === accountId);
                                    missingFiles.push(`${platform.toUpperCase()} - ${account?.account_name}`);
                                }
                            });
                        }
                    }
                });
                
                if (!hasSelectedAccounts) {
                    alert('Выберите хотя бы один аккаунт на любой площадке');
                    return;
                }
                
                if (missingFiles.length > 0) {
                    alert(`Загрузите файлы выгрузок для аккаунтов:\n${missingFiles.join('\n')}`);
                    return;
                }
                
                if (missingGateAmounts.length > 0) {
                    alert(`Введите суммы для аккаунтов Gate:\n${missingGateAmounts.join('\n')}`);
                    return;
                }
                
                // Создаем FormData для отправки
                const form = new FormData();
                form.append('employee_id', formData.employee_id);
                form.append('shift_type', formData.shift_type);
                    form.append('shift_date', formData.shift_date);
                form.append('department', formData.department);
                
                // Добавляем суммы для Gate (USDT и RUB)
                if (formData.gate_amounts) {
                    Object.entries(formData.gate_amounts).forEach(([accountId, amount]) => {
                        if (amount && amount !== '') {
                            form.append(`gate_amount_${accountId}`, amount);
                        }
                    });
                }
                
                // Добавляем суммы в рублях для Gate
                if (formData.gate_amounts_rub) {
                    Object.entries(formData.gate_amounts_rub).forEach(([accountId, amount]) => {
                        if (amount && amount !== '') {
                            form.append(`gate_amount_rub_${accountId}`, amount);
                        }
                    });
                }
                

                
                // Преобразуем время в формат YYYY-MM-DDTHH:MM
                const shift_start_time = `${formData.shift_date}T${formData.shift_start_time}`;
                const shift_end_time = `${formData.shift_date}T${formData.shift_end_time}`;
                
                form.append('shift_start_time', shift_start_time);
                form.append('shift_end_time', shift_end_time);

                // Выводим данные в консоль для отладки
                console.log('Отправляемые данные:', {
                    employee_id: formData.employee_id,
                    shift_date: formData.shift_date,
                    shift_type: formData.shift_type,
                    shift_start_time,
                    shift_end_time
                });
                
                // Добавляем выбранные аккаунты и их балансы
                form.append('selected_accounts', JSON.stringify(formData.selectedAccounts));
                form.append('balances', JSON.stringify(formData.balances));
                
                // Добавляем файлы выгрузок для каждого аккаунта
                Object.keys(formData.accountFiles).forEach(fileKey => {
                    if (formData.accountFiles[fileKey]) {
                        form.append(`file_${fileKey}`, formData.accountFiles[fileKey]);
                    }
                });
                
                // Добавляем дополнительные данные
                form.append('scam_amount', formData.scam_amount || 0);
                form.append('scam_amount_rub', formData.scam_amount_rub || 0); // новое поле
                form.append('scam_platform', formData.scam_platform || 'bybit'); // новое поле
                form.append('scam_account', formData.scam_account || ''); // новое поле
                form.append('scam_comment', formData.scam_comment || '');

                form.append('scam_count_in_sales', formData.scam_count_in_sales ? 'true' : ''); // новое поле
                form.append('scam_count_in_purchases', formData.scam_count_in_purchases ? 'true' : ''); // новое поле
                form.append('dokidka_amount', formData.dokidka_amount || 0);
                form.append('dokidka_amount_rub', formData.dokidka_amount_rub || 0);
                form.append('dokidka_platform', formData.dokidka_platform || 'bybit');
                form.append('dokidka_account', formData.dokidka_account || '');
                form.append('dokidka_comment', formData.dokidka_comment || '');
                form.append('dokidka_count_in_sales', formData.dokidka_count_in_sales ? 'true' : ''); // новое поле
                form.append('dokidka_count_in_purchases', formData.dokidka_count_in_purchases ? 'true' : ''); // новое поле
                form.append('internal_transfer_amount', formData.internal_transfer_amount || 0);
                form.append('internal_transfer_amount_rub', formData.internal_transfer_amount_rub || 0); // новое поле
                form.append('internal_transfer_platform', formData.internal_transfer_platform || 'bybit'); // новое поле
                form.append('internal_transfer_account', formData.internal_transfer_account || ''); // новое поле
                form.append('internal_transfer_comment', formData.internal_transfer_comment || '');
                form.append('internal_transfer_count_in_sales', formData.internal_transfer_count_in_sales ? 'true' : ''); // новое поле
                form.append('internal_transfer_count_in_purchases', formData.internal_transfer_count_in_purchases ? 'true' : ''); // новое поле
                form.append('appeal_amount', formData.appeal_amount || 0);
                form.append('appeal_amount_rub', formData.appeal_amount_rub || 0);
                form.append('appeal_platform', formData.appeal_platform || 'bybit');
                form.append('appeal_account', formData.appeal_account || '');
                form.append('appeal_comment', formData.appeal_comment || '');
                form.append('appeal_count_in_sales', formData.appeal_count_in_sales ? 'true' : ''); // новое поле
                form.append('appeal_count_in_purchases', formData.appeal_count_in_purchases ? 'true' : ''); // новое поле
                
                // Добавляем фотографии
                if (formData.start_photo) form.append('start_photo', formData.start_photo);
                if (formData.end_photo) form.append('end_photo', formData.end_photo);
                
                try {
                    const response = await fetch('/api/reports/create-shift', {
                        method: 'POST',
                        body: form
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        alert(`Отчёт создан успешно!
                        
Статистика обработки:
• Всего ордеров обработано: ${result.stats?.total_orders || 0}
• Привязано к смене: ${result.stats?.linked_orders || 0}
• Площадки: ${result.stats?.platforms_processed?.join(', ') || 'нет данных'}`);
                        
                        // Сохраняем балансы в историю
                        try {
                            let savedReport = null;
                            if (result.id) {
                                // Получаем полный объект отчёта по id
                                const allReports = await fetch('/api/reports').then(r => r.json());
                                savedReport = allReports.find(r => r.id === result.id);
                            }
                            if (!savedReport) {
                                // Если не нашли — fallback на последний отчёт
                                const allReports = await fetch('/api/reports').then(r => r.json());
                                savedReport = allReports && allReports.length > 0 ? allReports[allReports.length - 1] : formData;
                            }
                            console.log('Calling saveAccountBalancesToHistory with', savedReport, employees, accounts);
                            console.log('Report balances_json:', savedReport.balances_json);
                            await saveAccountBalancesToHistory(savedReport, employees, accounts);
                        } catch (e) {
                            console.error('Ошибка сохранения балансов в историю:', e);
                        }
                        
                        // Очищаем форму
                        setFormData({
                            employee_id: '',
                            shift_date: new Date().toISOString().split('T')[0], // Текущая дата по умолчанию
                            shift_type: 'morning', // Тип смены по умолчанию
                            department: 'first', // Отдел по умолчанию
                            shift_start_time: '',
                            shift_end_time: '',
                            selectedAccounts: {},
                            availableAccounts: formData.availableAccounts, // Сохраняем загруженные аккаунты
                            accountFiles: {},
                            scam_amount: 0,
                            scam_amount_rub: 0, // новое поле
                            scam_platform: 'bybit', // новое поле
                            scam_account: '', // новое поле
                            scam_comment: '',
        
                            scam_count_in_sales: false, // новое поле
                            scam_count_in_purchases: false, // новое поле
                            dokidka_amount: 0,
                            dokidka_amount_rub: 0,
                            dokidka_platform: 'bybit',
                            dokidka_account: '',
                            dokidka_comment: '',
                            dokidka_count_in_sales: false, // новое поле
                            dokidka_count_in_purchases: false, // новое поле
                            internal_transfer_amount: 0,
                            internal_transfer_amount_rub: 0, // новое поле
                            internal_transfer_platform: 'bybit', // новое поле
                            internal_transfer_account: '', // новое поле
                            internal_transfer_comment: '',
                            internal_transfer_count_in_sales: false, // новое поле
                            internal_transfer_count_in_purchases: false, // новое поле
                            appeal_amount: 0,
                            appeal_amount_rub: 0,
                            appeal_platform: 'bybit',
                            appeal_account: '',
                            appeal_comment: '',
                            appeal_count_in_sales: false, // новое поле
                            appeal_count_in_purchases: false, // новое поле
                            start_photo: null,
                            end_photo: null,
                            balances: {
                                bybit: [],
                                htx: [],
                                bliss: [],
                                gate: []
                            },
                            gate_amounts: {}, // Очищаем суммы Gate (USDT)
                            gate_amounts_rub: {} // Очищаем суммы Gate (RUB)
                        });
                        
                        setShowForm(false);
                        // Очищаем кэш статистики при создании нового отчета
                        if (window.reportsStatsCache) {
                            delete window.reportsStatsCache;
                        }
                        loadReports();
                        if (onUpdate) onUpdate();
                    } else {
                        alert(`Ошибка создания отчёта: ${result.error || 'Неизвестная ошибка'}`);
                        if (result.details) {
                            console.error('Детали ошибки:', result.details);
                        }
                    }
                } catch (error) {
                    console.error('Ошибка создания отчёта:', error);
                    alert('Ошибка соединения с сервером');
                }
            };

            const handleDelete = async (id) => {
                const password = prompt('Для удаления отчета введите пароль:');
                if (password) {
                try {
                    const response = await fetch(`/api/reports/${id}`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password })
                    });
                    if (response.ok) {
                        // Очищаем кэш статистики при удалении отчета
                        if (window.reportsStatsCache) {
                            delete window.reportsStatsCache;
                        }
                        loadReports();
                        if (onUpdate) onUpdate();
                    } else {
                        const data = await response.json();
                        alert(data.error || 'Ошибка удаления');
                    }
                } catch (error) {
                    alert('Ошибка удаления');
                }
                }
            };



            return (
                <div>
                    <div className="card">
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                            <h3><i className="fas fa-file-alt"></i> Отчеты по сменам</h3>
                            <button className="btn" onClick={() => setShowForm(!showForm)}>
                                <i className="fas fa-plus"></i> Добавить отчет
                            </button>
                        </div>

                        <div style={{display:'flex',gap:8,marginBottom:12,flexWrap:'wrap'}}>
                            <button className="btn btn-secondary" type="button" onClick={() => { // Сегодня
                                const today = new Date();
                                const d = today.toISOString().slice(0,10);
                                setFilters(f => ({...f, start_date: d, end_date: d}));
                            }}>Сегодня</button>
                            <button className="btn btn-secondary" type="button" onClick={() => { // Вчера
                                const y = new Date(); y.setDate(y.getDate()-1);
                                const d = y.toISOString().slice(0,10);
                                setFilters(f => ({...f, start_date: d, end_date: d}));
                            }}>Вчера</button>
                            <button className="btn btn-secondary" type="button" onClick={() => { // Текущая неделя
                                const now = new Date();
                                const day = now.getDay() || 7;
                                const monday = new Date(now); monday.setDate(now.getDate() - day + 1);
                                setFilters(f => ({...f, start_date: monday.toISOString().slice(0,10), end_date: now.toISOString().slice(0,10)}));
                            }}>Текущая неделя</button>
                            <button className="btn btn-secondary" type="button" onClick={() => { // Текущий месяц
                                const now = new Date();
                                const start = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0') + '-01';
                                const end = now.toISOString().slice(0,10);
                                setFilters(f => ({...f, start_date: start, end_date: end}));
                            }}>Текущий месяц</button>
                            <button className="btn btn-secondary" type="button" onClick={() => { // Последние 7 дней
                                const now = new Date();
                                const start = new Date(now); start.setDate(now.getDate()-6);
                                setFilters(f => ({...f, start_date: start.toISOString().slice(0,10), end_date: now.toISOString().slice(0,10)}));
                            }}>Последние 7 дней</button>
                            <button className="btn btn-secondary" type="button" onClick={async () => { // Всё время
                                // Получаем самую раннюю дату из отчетов
                                const response = await fetch('/api/reports');
                                const data = await response.json();
                                if (data.length > 0) {
                                    const minDate = data.map(r => r.shift_date).sort()[0];
                                    const maxDate = data.map(r => r.shift_date).sort().reverse()[0];
                                    setFilters(f => ({...f, start_date: minDate, end_date: maxDate}));
                                }
                            }}>Всё время</button>
                            {/* --- Кнопка Экспорт в CSV --- */}
                            <button className="btn" type="button" style={{marginLeft:16,background:'#27ae60'}} onClick={() => {
                                // НОВАЯ ФУНКЦИЯ ЭКСПОРТА CSV
                                console.log('=== НАЧАЛО ЭКСПОРТА CSV ===');
                                
                                function escapeCSV(val, forceQuotes=false) {
                                    if (val == null || val === undefined) return '';
                                    let s = String(val);
                                    if (forceQuotes || s.search(/[",;\n\r]/) >= 0) {
                                        s = s.replace(/"/g, '""');
                                        return '"'+s+'"';
                                    }
                                    return s;
                                }
                                
                                // СТРОГО ОПРЕДЕЛЕННАЯ СТРУКТУРА ЗАГОЛОВКОВ
                                const header = [
                                    'Дата',
                                    'Сотрудник', 
                                    'Смена',
                                    'Всего заявок',
                                    'Bybit заявки',
                                    'HTX заявки', 
                                    'Bliss заявки',
                                    'Балансы (JSON)',
                                    'СКАМ (USDT)',
                                    'Комментарий СКАМ',
                                    'Докидка (USDT)',
                                    'Комментарий докидки',
                                    'Внутренний перевод (USDT)',
                                    'Комментарий внутреннего перевода',
                                    'BYBIT первая сделка',
                                    'BYBIT последняя сделка',
                                    'HTX первая сделка',
                                    'HTX последняя сделка',
                                    'BLISS первая сделка',
                                    'BLISS последняя сделка',
                                    'GATE первая сделка',
                                    'GATE последняя сделка',
                                    'Аппеляции (USDT)',
                                    'Комментарий аппеляции'
                                ];
                                
                                console.log('Заголовки:', header);
                                
                                // СТРОГО ОПРЕДЕЛЕННАЯ СТРУКТУРА ДАННЫХ
                                const rows = reports.map((r, index) => {
                                    console.log(`Обработка отчета ${index + 1}:`, r);
                                    
                                    const employee = employees.find(e => e.id === r.employee_id);
                                    let balancesStr = '';
                                    try {
                                        const balances = JSON.parse(r.balances_json || '{}');
                                        balancesStr = JSON.stringify(balances);
                                    } catch (e) {
                                        console.warn(`Ошибка парсинга балансов для отчета ${index + 1}:`, e);
                                        balancesStr = r.balances_json || '';
                                    }
                                    
                                    const row = [
                                        r.shift_date || '',                                    // Дата
                                        employee ? employee.name : '',                       // Сотрудник
                                        r.shift_type || '',                                   // Смена
                                        r.total_requests || 0,                               // Всего заявок
                                        r.bybit_requests || 0,                               // Bybit заявки
                                        r.htx_requests || 0,                                 // HTX заявки
                                        r.bliss_requests || 0,                               // Bliss заявки
                                        balancesStr,                                         // Балансы (JSON)
                                        r.scam_amount || 0,                                  // СКАМ (USDT)
                                        r.scam_comment || '',                                // Комментарий СКАМ
                                        r.dokidka_amount || 0,                               // Докидка (USDT)
                                        r.dokidka_comment || '',                             // Комментарий докидки
                                        r.internal_transfer_amount || 0,                     // Внутренний перевод (USDT)
                                        r.internal_transfer_comment || '',                   // Комментарий внутреннего перевода
                                        r.bybit_first_trade || '',                           // BYBIT первая сделка
                                        r.bybit_last_trade || '',                            // BYBIT последняя сделка
                                        r.htx_first_trade || '',                             // HTX первая сделка
                                        r.htx_last_trade || '',                              // HTX последняя сделка
                                        r.bliss_first_trade || '',                           // BLISS первая сделка
                                        r.bliss_last_trade || '',                            // BLISS последняя сделка
                                        r.gate_first_trade || '',                            // GATE первая сделка
                                        r.gate_last_trade || '',                             // GATE последняя сделка
                                        r.appeal_amount || 0,                                // Аппеляции (USDT)
                                        r.appeal_comment || ''                               // Комментарий аппеляции
                                    ].map(v => escapeCSV(v));
                                    
                                    console.log(`Строка ${index + 1}:`, row);
                                    return row;
                                });
                                
                                const csv = [header.join(','), ...rows.map(row => row.join(','))].join('\r\n');
                                console.log('CSV данные:', csv.substring(0, 500) + '...');
                                
                                const blob = new Blob([csv], {type: 'text/csv;charset=utf-8'});
                                const url = URL.createObjectURL(blob);
                                const a = document.createElement('a');
                                a.href = url;
                                a.download = `reports_export_${new Date().toISOString().slice(0, 10)}.csv`;
                                document.body.appendChild(a);
                                a.click();
                                setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 100);
                                
                                console.log('=== ЭКСПОРТ CSV ЗАВЕРШЕН ===');
                            }}><i className="fas fa-file-csv"></i> Экспорт в CSV</button>
                            {/* --- Кнопка Импорт из CSV --- */}
                            <input id="import-csv-input" type="file" accept=".csv" style={{display:'none'}} onChange={async e => {
                                const file = e.target.files[0];
                                if (!file) return;
                                
                                console.log('=== НАЧАЛО ИМПОРТА CSV ===');
                                console.log('Файл:', file.name);
                                
                                const text = await file.text();
                                console.log('Содержимое файла (первые 500 символов):', text.substring(0, 500));
                                
                                // Парсим CSV через SheetJS
                                const workbook = XLSX.read(text, {type: 'string'});
                                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                                const data = XLSX.utils.sheet_to_json(sheet, {header:1});
                                
                                console.log('Парсированные данные:', data);
                                
                                const header = data[0];
                                const rows = data.slice(1);
                                
                                console.log('Заголовки:', header);
                                console.log('Количество строк данных:', rows.length);
                                
                                // СТРОГО ОПРЕДЕЛЕННЫЕ ОБЯЗАТЕЛЬНЫЕ ПОЛЯ
                                const requiredFields = ['Дата', 'Сотрудник', 'Смена'];
                                const missing = requiredFields.filter(f => !header.includes(f));
                                
                                if (missing.length > 0) {
                                    const errorMsg = `Ошибка: отсутствуют обязательные столбцы: ${missing.join(', ')}\n\nОжидаемые заголовки:\n${requiredFields.join(', ')}`;
                                    console.error(errorMsg);
                                    alert(errorMsg);
                                    e.target.value = '';
                                    return;
                                }
                                
                                // СОЗДАЕМ МАППИНГ ИНДЕКСОВ
                                const fieldIndexes = {};
                                header.forEach((h, i) => { 
                                    fieldIndexes[h.trim()] = i; 
                                });
                                
                                console.log('Индексы полей:', fieldIndexes);
                                
                                let successCount = 0, errorCount = 0;
                                let duplicateCount = 0;
                                let errorDetails = [];
                                
                                // ОБРАБАТЫВАЕМ КАЖДУЮ СТРОКУ
                                for (let i = 0; i < rows.length; i++) {
                                    const rowIndex = i + 2; // +2 потому что строка 1 - заголовки
                                    const row = rows[i];
                                    
                                    console.log(`\n--- Обработка строки ${rowIndex} ---`);
                                    console.log('Данные строки:', row);
                                    
                                    if (!row || row.length < 3) {
                                        errorCount++;
                                        errorDetails.push(`Строка ${rowIndex}: недостаточно данных`);
                                        continue;
                                    }
                                    
                                    try {
                                        // ИЗВЛЕКАЕМ ДАННЫЕ ПО ИНДЕКСАМ
                                        const employeeName = row[fieldIndexes['Сотрудник']] || '';
                                        let shiftDate = row[fieldIndexes['Дата']] || '';
                                        const shiftType = row[fieldIndexes['Смена']] || '';
                                        
                                        // ОБРАБАТЫВАЕМ ДАТУ (EXCEL МОЖЕТ ПЕРЕДАВАТЬ ЧИСЛОВЫЕ ДАТЫ)
                                        if (typeof shiftDate === 'number' || (!isNaN(shiftDate) && shiftDate !== '' && typeof shiftDate !== 'string')) {
                                            // Это Excel дата в числовом формате
                                            const excelEpoch = new Date(Date.UTC(1899, 11, 30));
                                            const jsDate = new Date(excelEpoch.getTime() + (Math.floor(shiftDate) * 86400000));
                                            if (shiftDate % 1 !== 0) {
                                                jsDate.setTime(jsDate.getTime() + Math.round((shiftDate % 1) * 86400000));
                                            }
                                            shiftDate = jsDate.toISOString().slice(0, 10);
                                        } else if (typeof shiftDate === 'string' && shiftDate.match(/^\d+(\.\d+)?$/)) {
                                            // Это строка с числом (Excel дата)
                                            const num = parseFloat(shiftDate);
                                            if (!isNaN(num)) {
                                                const excelEpoch = new Date(Date.UTC(1899, 11, 30));
                                                const jsDate = new Date(excelEpoch.getTime() + (Math.floor(num) * 86400000));
                                                if (num % 1 !== 0) {
                                                    jsDate.setTime(jsDate.getTime() + Math.round((num % 1) * 86400000));
                                                }
                                                shiftDate = jsDate.toISOString().slice(0, 10);
                                            }
                                        } else {
                                            // Обычная строка даты
                                            shiftDate = String(shiftDate).trim();
                                        }
                                        
                                        console.log('Сотрудник:', employeeName);
                                        console.log('Дата:', shiftDate);
                                        console.log('Смена:', shiftType);
                                        
                                        // ПРОВЕРЯЕМ СОТРУДНИКА
                                        const employee = employees.find(e => 
                                            String(e.name).trim().toLowerCase() === String(employeeName).trim().toLowerCase()
                                        );
                                        
                                        if (!employee) {
                                            errorCount++;
                                            errorDetails.push(`Строка ${rowIndex}: сотрудник "${employeeName}" не найден`);
                                            continue;
                                        }
                                        
                                        // ОБРАБАТЫВАЕМ БАЛАНСЫ
                                        let balancesJson = '{}';
                                        const balancesRaw = row[fieldIndexes['Балансы (JSON)']] || '{}';
                                        
                                        try {
                                            const balances = JSON.parse(balancesRaw);
                                            console.log('Балансы:', balances);
                                            
                                            // ПРОВЕРЯЕМ И ИСПРАВЛЯЕМ СТРУКТУРУ БАЛАНСОВ
                                            for (let platform of ['bybit', 'htx', 'bliss', 'gate']) {
                                                if (balances[platform] && Array.isArray(balances[platform])) {
                                                    for (let acc of balances[platform]) {
                                                        // Исправляем старую структуру
                                                        if (acc.balance !== undefined && acc.end_balance === undefined) {
                                                            acc.end_balance = acc.balance;
                                                            delete acc.balance;
                                                        }
                                                        
                                                        // Устанавливаем значения по умолчанию
                                                        if (acc.start_balance === undefined) acc.start_balance = 0;
                                                        if (acc.end_balance === undefined) acc.end_balance = 0;
                                                        
                                                        // Проверяем на аномальные значения
                                                        acc.start_balance = parseFloat(acc.start_balance) || 0;
                                                        acc.end_balance = parseFloat(acc.end_balance) || 0;
                                                        
                                                        if (Math.abs(acc.start_balance) > 100000) acc.start_balance = 0;
                                                        if (Math.abs(acc.end_balance) > 100000) acc.end_balance = 0;
                                                    }
                                                }
                                            }
                                            
                                            balancesJson = JSON.stringify(balances);
                                        } catch (e) {
                                            console.warn(`Ошибка парсинга балансов в строке ${rowIndex}:`, e);
                                            balancesJson = '{}';
                                        }
                                        
                                        // ФОРМИРУЕМ ОБЪЕКТ ДАННЫХ
                                        const reportData = {
                                            employee_id: employee.id,
                                            shift_date: shiftDate,
                                            shift_type: shiftType,
                                            total_requests: parseInt(row[fieldIndexes['Всего заявок']] || 0) || 0,
                                            bybit_requests: parseInt(row[fieldIndexes['Bybit заявки']] || 0) || 0,
                                            htx_requests: parseInt(row[fieldIndexes['HTX заявки']] || 0) || 0,
                                            bliss_requests: parseInt(row[fieldIndexes['Bliss заявки']] || 0) || 0,
                                            balances_json: balancesJson,
                                            scam_amount: parseFloat(row[fieldIndexes['СКАМ (USDT)']] || 0) || 0,
                                            scam_comment: String(row[fieldIndexes['Комментарий СКАМ']] || '').trim(),
                                            dokidka_amount: parseFloat(row[fieldIndexes['Докидка (USDT)']] || 0) || 0,
                                            dokidka_comment: String(row[fieldIndexes['Комментарий докидки']] || '').trim(),
                                            internal_transfer_amount: parseFloat(row[fieldIndexes['Внутренний перевод (USDT)']] || 0) || 0,
                                            internal_transfer_comment: String(row[fieldIndexes['Комментарий внутреннего перевода']] || '').trim(),
                                            bybit_first_trade: String(row[fieldIndexes['BYBIT первая сделка']] || '').trim(),
                                            bybit_last_trade: String(row[fieldIndexes['BYBIT последняя сделка']] || '').trim(),
                                            htx_first_trade: String(row[fieldIndexes['HTX первая сделка']] || '').trim(),
                                            htx_last_trade: String(row[fieldIndexes['HTX последняя сделка']] || '').trim(),
                                            bliss_first_trade: String(row[fieldIndexes['BLISS первая сделка']] || '').trim(),
                                            bliss_last_trade: String(row[fieldIndexes['BLISS последняя сделка']] || '').trim(),
                                            gate_first_trade: String(row[fieldIndexes['GATE первая сделка']] || '').trim(),
                                            gate_last_trade: String(row[fieldIndexes['GATE последняя сделка']] || '').trim(),
                                            appeal_amount: parseFloat(row[fieldIndexes['Аппеляции (USDT)']] || 0) || 0,
                                            appeal_comment: String(row[fieldIndexes['Комментарий аппеляции']] || '').trim()
                                        };
                                        
                                        // ДОПОЛНИТЕЛЬНАЯ ВАЛИДАЦИЯ
                                        if (!reportData.shift_date || reportData.shift_date === '') {
                                            errorCount++;
                                            errorDetails.push(`Строка ${rowIndex}: отсутствует дата смены`);
                                            continue;
                                        }
                                        
                                        if (!reportData.shift_type || reportData.shift_type === '') {
                                            reportData.shift_type = 'morning'; // значение по умолчанию
                                        }
                                        
                                        // Проверяем дату
                                        const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
                                        if (!dateRegex.test(reportData.shift_date)) {
                                            errorCount++;
                                            errorDetails.push(`Строка ${rowIndex}: неверный формат даты "${reportData.shift_date}". Ожидается YYYY-MM-DD`);
                                            continue;
                                        }
                                        
                                        console.log('Данные для отправки:', reportData);
                                        
                                        // ПРОВЕРКА НА ДУБЛИКАТЫ
                                        const isDuplicate = reports.some(existingReport => 
                                            existingReport.employee_id === reportData.employee_id &&
                                            existingReport.shift_date === reportData.shift_date &&
                                            existingReport.shift_type === reportData.shift_type
                                        );
                                        
                                        if (isDuplicate) {
                                            duplicateCount++;
                                            errorDetails.push(`Строка ${rowIndex}: отчет уже существует (${employee.name}, ${reportData.shift_date}, ${reportData.shift_type})`);
                                            console.warn(`Строка ${rowIndex}: дубликат отчета найден`);
                                            continue;
                                        }
                                        
                                        // ОТПРАВЛЯЕМ НА СЕРВЕР
                                        const response = await fetch('/api/reports', {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify(reportData)
                                        });
                                        
                                        if (response.ok) {
                                            successCount++;
                                            console.log(`Строка ${rowIndex}: успешно сохранена`);
                                        } else {
                                            errorCount++;
                                            let errorText = '';
                                            try {
                                                const contentType = response.headers.get('content-type');
                                                if (contentType && contentType.includes('application/json')) {
                                                    const errorData = await response.json();
                                                    errorText = errorData.message || errorData.error || `HTTP ${response.status}`;
                                                } else {
                                                    errorText = await response.text();
                                                }
                                            } catch (e) {
                                                errorText = `HTTP ${response.status} - ${response.statusText}`;
                                            }
                                            errorDetails.push(`Строка ${rowIndex}: ${errorText}`);
                                            console.error(`Строка ${rowIndex}: ошибка сервера`, errorText);
                                        }
                                        
                                    } catch (error) {
                                        errorCount++;
                                        errorDetails.push(`Строка ${rowIndex}: неожиданная ошибка - ${error.message}`);
                                        console.error(`Строка ${rowIndex}: неожиданная ошибка`, error);
                                    }
                                }
                                
                                // РЕЗУЛЬТАТ ИМПОРТА
                                let resultMessage = `Импорт завершен.\nУспешно: ${successCount} строк\nОшибок: ${errorCount} строк`;
                                if (duplicateCount > 0) {
                                    resultMessage += `\nПропущено дубликатов: ${duplicateCount} строк`;
                                }
                                
                                if (errorDetails.length > 0) {
                                    resultMessage += '\n\nДетали ошибок:\n' + errorDetails.slice(0, 10).join('\n');
                                    if (errorDetails.length > 10) {
                                        resultMessage += `\n... и еще ${errorDetails.length - 10} ошибок`;
                                    }
                                }
                                
                                console.log('=== РЕЗУЛЬТАТ ИМПОРТА ===');
                                console.log(resultMessage);
                                
                                alert(resultMessage);
                                
                                if (successCount > 0) {
                                    // Очищаем кэш статистики при импорте отчетов
                                    if (window.reportsStatsCache) {
                                        delete window.reportsStatsCache;
                                    }
                                    loadReports(); // Обновляем список отчетов
                                }
                                
                                e.target.value = '';
                                console.log('=== ИМПОРТ CSV ЗАВЕРШЕН ===');
                            }} />
                            <button className="btn btn-secondary" type="button" style={{background:'#f7b731'}} onClick={() => document.getElementById('import-csv-input').click()}><i className="fas fa-file-import"></i> Импорт из CSV</button>
                            <button className="btn" type="button" style={{marginLeft:8,background:'#3c78d8'}} onClick={() => {
                                // НОВАЯ ФУНКЦИЯ ЭКСПОРТА EXCEL
                                console.log('=== НАЧАЛО ЭКСПОРТА EXCEL ===');
                                
                                // СТРОГО ОПРЕДЕЛЕННАЯ СТРУКТУРА ЗАГОЛОВКОВ (ТАКАЯ ЖЕ КАК В CSV)
                                const header = [
                                    'Дата',
                                    'Сотрудник', 
                                    'Смена',
                                    'Всего заявок',
                                    'Bybit заявки',
                                    'HTX заявки', 
                                    'Bliss заявки',
                                    'Балансы (JSON)',
                                    'СКАМ (USDT)',
                                    'Комментарий СКАМ',
                                    'Докидка (USDT)',
                                    'Комментарий докидки',
                                    'Внутренний перевод (USDT)',
                                    'Комментарий внутреннего перевода',
                                    'BYBIT первая сделка',
                                    'BYBIT последняя сделка',
                                    'HTX первая сделка',
                                    'HTX последняя сделка',
                                    'BLISS первая сделка',
                                    'BLISS последняя сделка',
                                    'GATE первая сделка',
                                    'GATE последняя сделка',
                                    'Аппеляции (USDT)',
                                    'Комментарий аппеляции'
                                ];
                                
                                // СТРОГО ОПРЕДЕЛЕННАЯ СТРУКТУРА ДАННЫХ (ТАКАЯ ЖЕ КАК В CSV)
                                const rows = reports.map((r, index) => {
                                    console.log(`Обработка отчета ${index + 1} для Excel:`, r);
                                    
                                    const employee = employees.find(e => e.id === r.employee_id);
                                    let balancesStr = '';
                                    try {
                                        const balances = JSON.parse(r.balances_json || '{}');
                                        balancesStr = JSON.stringify(balances);
                                    } catch (e) {
                                        console.warn(`Ошибка парсинга балансов для Excel отчета ${index + 1}:`, e);
                                        balancesStr = r.balances_json || '';
                                    }
                                    
                                    return [
                                        r.shift_date || '',                                    // Дата
                                        employee ? employee.name : '',                       // Сотрудник
                                        r.shift_type || '',                                   // Смена
                                        r.total_requests || 0,                               // Всего заявок
                                        r.bybit_requests || 0,                               // Bybit заявки
                                        r.htx_requests || 0,                                 // HTX заявки
                                        r.bliss_requests || 0,                               // Bliss заявки
                                        balancesStr,                                         // Балансы (JSON)
                                        r.scam_amount || 0,                                  // СКАМ (USDT)
                                        r.scam_comment || '',                                // Комментарий СКАМ
                                        r.dokidka_amount || 0,                               // Докидка (USDT)
                                        r.dokidka_comment || '',                             // Комментарий докидки
                                        r.internal_transfer_amount || 0,                     // Внутренний перевод (USDT)
                                        r.internal_transfer_comment || '',                   // Комментарий внутреннего перевода
                                        r.bybit_first_trade || '',                           // BYBIT первая сделка
                                        r.bybit_last_trade || '',                            // BYBIT последняя сделка
                                        r.htx_first_trade || '',                             // HTX первая сделка
                                        r.htx_last_trade || '',                              // HTX последняя сделка
                                        r.bliss_first_trade || '',                           // BLISS первая сделка
                                        r.bliss_last_trade || '',                            // BLISS последняя сделка
                                        r.gate_first_trade || '',                            // GATE первая сделка
                                        r.gate_last_trade || '',                             // GATE последняя сделка
                                        r.appeal_amount || 0,                                // Аппеляции (USDT)
                                        r.appeal_comment || ''                               // Комментарий аппеляции
                                    ];
                                });
                                
                                const ws = window.XLSX.utils.aoa_to_sheet([header, ...rows]);
                                const wb = window.XLSX.utils.book_new();
                                window.XLSX.utils.book_append_sheet(wb, ws, 'Отчеты');
                                window.XLSX.writeFile(wb, `reports_export_${new Date().toISOString().slice(0, 10)}.xlsx`);
                                
                                console.log('=== ЭКСПОРТ EXCEL ЗАВЕРШЕН ===');
                            }}><i className="fas fa-file-excel"></i> Экспорт в Excel</button>
                        </div>
                        <div className="filters" style={{marginBottom: '8px'}}>
                            <div className="filter-item">
                                <label>Дата начала</label>
                                <input type="date" className="form-control" value={filters.start_date} onChange={e => setFilters({...filters, start_date: e.target.value})} />
                            </div>
                            <div className="filter-item">
                                <label>Дата окончания</label>
                                <input type="date" className="form-control" value={filters.end_date} onChange={e => setFilters({...filters, end_date: e.target.value})} />
                            </div>
                            <div className="filter-item">
                                <label>Сотрудник</label>
                                <select className="form-control" value={filters.employee_id} onChange={e => setFilters({...filters, employee_id: e.target.value})}>
                                    <option value="">Все сотрудники</option>
                                    {employees.map(emp => (
                                        <option key={emp.id} value={emp.id}>{emp.name}</option>
                                    ))}
                                </select>
                            </div>
                            <div className="filter-item">
                                <label>Отдел</label>
                                <select className="form-control" value={filters.department} onChange={e => setFilters({...filters, department: e.target.value})}>
                                    <option value="">Все отделы</option>
                                    <option value="first">Первый отдел</option>
                                    <option value="second">Второй отдел</option>
                                </select>
                            </div>
                            <div className="filter-item" style={{ display: 'flex', alignItems: 'end' }}>
                                <button className="btn" onClick={loadReports}>
                                    <i className="fas fa-search"></i> Применить фильтры
                                </button>
                            </div>
                        </div>
                        <hr style={{margin: '24px 0', border: 'none', borderTop: '2px solid #e1e8ed'}} />
                        {showForm && (
                            <div style={{margin:'0 auto',maxWidth:1000,padding:'32px 0'}}>
                                <h2 style={{color:'#667eea',marginBottom:24,display:'flex',alignItems:'center',gap:12}}>
                                    <i className="fas fa-plus-circle"></i> Создать отчёт по смене
                                </h2>
                                
                                {/* Информационный блок */}
                                <div style={{background:'linear-gradient(135deg, #e8f4fd 0%, #f0f8ff 100%)',border:'1px solid #bee5eb',borderRadius:12,padding:20,marginBottom:24}}>
                                    <div style={{fontWeight:600,color:'#0c5460',marginBottom:12,display:'flex',alignItems:'center',gap:8}}>
                                        <i className="fas fa-info-circle"></i> Новая логика создания отчётов
                                    </div>
                                    <div style={{fontSize:'0.9em',color:'#0c5460',lineHeight:1.6}}>
                                        1. Выберите сотрудника и время смены по МСК<br/>
                                        2. Выберите площадки и аккаунты, на которых работал сотрудник<br/>
                                        3. Загрузите файлы выгрузок с выбранных площадок<br/>
                                        4. Система автоматически проверит время и привяжет ордера к смене
                                    </div>
                                </div>

                                <form onSubmit={handleSubmit} encType="multipart/form-data" style={{display:'flex',flexDirection:'column',gap:24}}>
                                    {/* Шаг 1: Сотрудник и время смены */}
                                    <div style={{background:'#fff',borderRadius:16,boxShadow:'0 2px 12px rgba(102,126,234,0.15)',padding:24,border:'1px solid #e1e8ed'}}>
                                        <div style={{fontWeight:700,color:'#667eea',marginBottom:20,display:'flex',alignItems:'center',gap:8,fontSize:'1.1em'}}>
                                            <span style={{background:'#667eea',color:'#fff',width:28,height:28,borderRadius:'50%',display:'flex',alignItems:'center',justifyContent:'center',fontSize:'0.9em'}}>1</span>
                                            Сотрудник и время смены
                                        </div>
                                        <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(250px, 1fr))',gap:16}}>
                                            <div>
                                                <label style={{fontWeight:600,marginBottom:8,display:'block'}}>Сотрудник *</label>
                                                <select className="form-control" value={formData.employee_id} onChange={e => {
                                                    const employeeId = e.target.value;
                                                    setFormData({...formData, employee_id: employeeId, selectedAccounts: {}});
                                                    
                                                    // Загружаем все доступные аккаунты (не привязанные к сотруднику)
                                                    if (employeeId) {
                                                        fetch(`/api/employee-accounts/${employeeId}`)
                                                            .then(r => r.json())
                                                            .then(data => {
                                                                setFormData(prev => ({...prev, availableAccounts: data.accounts || {}}));
                                                            })
                                                            .catch(err => console.error('Ошибка загрузки аккаунтов:', err));
                                                    }
                                                }} required>
                                                <option value="">Выберите сотрудника</option>
                                                {employees.map(emp => (
                                                    <option key={emp.id} value={emp.id}>{emp.name}</option>
                                                ))}
                                            </select>
                                        </div>
                                                <div>
                                                    <label style={{fontWeight:600,marginBottom:8,display:'block'}}>Дата смены *</label>
                                                    <input 
                                                        type="date" 
                                                        className="form-control" 
                                                        value={formData.shift_date} 
                                                        onChange={e => setFormData({...formData, shift_date: e.target.value})} 
                                                        required 
                                                    />
                                        </div>
                                            
                                            {/* Тип смены */}
                                            <div>
                                                <label style={{fontWeight:600,marginBottom:8,display:'block'}}>Тип смены *</label>
                                                <div style={{display:'flex',gap:12}}>
                                                    <label style={{
                                                        flex:1,
                                                        padding:'10px',
                                                        border:'2px solid ' + (formData.shift_type === 'morning' ? '#667eea' : '#e1e8ed'),
                                                        borderRadius:'8px',
                                                        cursor:'pointer',
                                                        display:'flex',
                                                        alignItems:'center',
                                                        justifyContent:'center',
                                                        gap:'8px',
                                                        background: formData.shift_type === 'morning' ? '#667eea10' : '#fff'
                                                    }}>
                                                        <input
                                                            type="radio"
                                                            name="shift_type"
                                                            value="morning"
                                                            checked={formData.shift_type === 'morning'}
                                                            onChange={e => setFormData({...formData, shift_type: e.target.value})}
                                                            style={{display:'none'}}
                                                        />
                                                        <i className="fas fa-sun" style={{color: formData.shift_type === 'morning' ? '#667eea' : '#495057'}}></i>
                                                        <span style={{color: formData.shift_type === 'morning' ? '#667eea' : '#495057'}}>Утренняя</span>
                                                    </label>
                                                    <label style={{
                                                        flex:1,
                                                        padding:'10px',
                                                        border:'2px solid ' + (formData.shift_type === 'night' ? '#667eea' : '#e1e8ed'),
                                                        borderRadius:'8px',
                                                        cursor:'pointer',
                                                        display:'flex',
                                                        alignItems:'center',
                                                        justifyContent:'center',
                                                        gap:'8px',
                                                        background: formData.shift_type === 'night' ? '#667eea10' : '#fff'
                                                    }}>
                                                        <input
                                                            type="radio"
                                                            name="shift_type"
                                                            value="night"
                                                            checked={formData.shift_type === 'night'}
                                                            onChange={e => setFormData({...formData, shift_type: e.target.value})}
                                                            style={{display:'none'}}
                                                        />
                                                        <i className="fas fa-moon" style={{color: formData.shift_type === 'night' ? '#667eea' : '#495057'}}></i>
                                                        <span style={{color: formData.shift_type === 'night' ? '#667eea' : '#495057'}}>Ночная</span>
                                                    </label>
                                        </div>
                                            </div>

                                            <div>
                                                <label style={{fontWeight:600,marginBottom:8,display:'block'}}>Отдел *</label>
                                                <div style={{display:'flex',gap:12}}>
                                                    <label style={{
                                                        flex:1,
                                                        padding:'10px',
                                                        border:'2px solid ' + (formData.department === 'first' ? '#667eea' : '#e1e8ed'),
                                                        borderRadius:'8px',
                                                        cursor:'pointer',
                                                        display:'flex',
                                                        alignItems:'center',
                                                        justifyContent:'center',
                                                        gap:'8px',
                                                        background: formData.department === 'first' ? '#667eea10' : '#fff'
                                                    }}>
                                                        <input
                                                            type="radio"
                                                            name="department"
                                                            value="first"
                                                            checked={formData.department === 'first'}
                                                            onChange={e => setFormData({...formData, department: e.target.value})}
                                                            style={{display:'none'}}
                                                        />
                                                        <i className="fas fa-building" style={{color: formData.department === 'first' ? '#667eea' : '#495057'}}></i>
                                                        <span style={{color: formData.department === 'first' ? '#667eea' : '#495057'}}>Первый отдел</span>
                                                    </label>
                                                    <label style={{
                                                        flex:1,
                                                        padding:'10px',
                                                        border:'2px solid ' + (formData.department === 'second' ? '#667eea' : '#e1e8ed'),
                                                        borderRadius:'8px',
                                                        cursor:'pointer',
                                                        display:'flex',
                                                        alignItems:'center',
                                                        justifyContent:'center',
                                                        gap:'8px',
                                                        background: formData.department === 'second' ? '#667eea10' : '#fff'
                                                    }}>
                                                        <input
                                                            type="radio"
                                                            name="department"
                                                            value="second"
                                                            checked={formData.department === 'second'}
                                                            onChange={e => setFormData({...formData, department: e.target.value})}
                                                            style={{display:'none'}}
                                                        />
                                                        <i className="fas fa-building" style={{color: formData.department === 'second' ? '#667eea' : '#495057'}}></i>
                                                        <span style={{color: formData.department === 'second' ? '#667eea' : '#495057'}}>Второй отдел</span>
                                                    </label>
                                        </div>
                                            </div>

                                            <div>
                                                <label style={{fontWeight:600,marginBottom:8,display:'block'}}>Время начала смены (МСК) *</label>
                                                <div style={{display:'flex',gap:8,alignItems:'center'}}>
                                                    <input 
                                                        type="text" 
                                                        className="form-control"
                                                        placeholder="ЧЧ"
                                                        style={{width:'80px',textAlign:'center'}}
                                                        value={formData.shift_start_time.split(':')[0] || ''}
                                                        onChange={e => {
                                                            let hours = e.target.value.replace(/\D/g, '');
                                                            if (hours === '') {
                                                                const minutes = formData.shift_start_time.split(':')[1] || '';
                                                                setFormData({...formData, shift_start_time: minutes ? `:${minutes}` : ''});
                                                                return;
                                                            }
                                                            hours = Math.min(Math.max(parseInt(hours) || 0, 0), 23).toString();
                                                            const minutes = formData.shift_start_time.split(':')[1] || '';
                                                            setFormData({...formData, shift_start_time: `${hours}${minutes ? ':' + minutes : ''}`});
                                                        }}
                                                        onBlur={e => {
                                                            let hours = e.target.value.replace(/\D/g, '');
                                                            if (hours) {
                                                                hours = hours.padStart(2, '0');
                                                                const minutes = formData.shift_start_time.split(':')[1] || '00';
                                                                setFormData({...formData, shift_start_time: `${hours}:${minutes}`});
                                                            }
                                                        }}
                                                        onWheel={e => e.target.blur()}
                                                        maxLength="2"
                                                        required
                                                    />
                                                    <span style={{alignSelf:'center',fontWeight:'bold',userSelect:'none'}}>:</span>
                                                    <input 
                                                        type="text"
                                                        className="form-control"
                                                        placeholder="ММ"
                                                        style={{width:'80px',textAlign:'center'}}
                                                        value={formData.shift_start_time.split(':')[1] || ''}
                                                        onChange={e => {
                                                            let minutes = e.target.value.replace(/\D/g, '');
                                                            if (minutes === '') {
                                                                const hours = formData.shift_start_time.split(':')[0] || '';
                                                                setFormData({...formData, shift_start_time: hours ? `${hours}:` : ''});
                                                                return;
                                                            }
                                                            minutes = Math.min(Math.max(parseInt(minutes) || 0, 0), 59).toString();
                                                            const hours = formData.shift_start_time.split(':')[0] || '';
                                                            setFormData({...formData, shift_start_time: hours ? `${hours}:${minutes}` : `0:${minutes}`});
                                                        }}
                                                        onBlur={e => {
                                                            let minutes = e.target.value.replace(/\D/g, '');
                                                            if (minutes) {
                                                                minutes = minutes.padStart(2, '0');
                                                                const hours = formData.shift_start_time.split(':')[0] || '00';
                                                                setFormData({...formData, shift_start_time: `${hours}:${minutes}`});
                                                            }
                                                        }}
                                                        onWheel={e => e.target.blur()}
                                                        maxLength="2"
                                                        required
                                                    />
                                            </div>
                                    </div>
                                            <div>
                                                <label style={{fontWeight:600,marginBottom:8,display:'block'}}>Время окончания смены (МСК) *</label>
                                                <div style={{display:'flex',gap:8,alignItems:'center'}}>
                                                    <input 
                                                        type="text"
                                                        className="form-control"
                                                        placeholder="ЧЧ"
                                                        style={{width:'80px',textAlign:'center'}}
                                                        value={formData.shift_end_time.split(':')[0] || ''}
                                                        onChange={e => {
                                                            let hours = e.target.value.replace(/\D/g, '');
                                                            if (hours === '') {
                                                                const minutes = formData.shift_end_time.split(':')[1] || '';
                                                                setFormData({...formData, shift_end_time: minutes ? `:${minutes}` : ''});
                                                                return;
                                                            }
                                                            hours = Math.min(Math.max(parseInt(hours) || 0, 0), 23).toString();
                                                            const minutes = formData.shift_end_time.split(':')[1] || '';
                                                            setFormData({...formData, shift_end_time: `${hours}${minutes ? ':' + minutes : ''}`});
                                                        }}
                                                        onBlur={e => {
                                                            let hours = e.target.value.replace(/\D/g, '');
                                                            if (hours) {
                                                                hours = hours.padStart(2, '0');
                                                                const minutes = formData.shift_end_time.split(':')[1] || '00';
                                                                setFormData({...formData, shift_end_time: `${hours}:${minutes}`});
                                                            }
                                                        }}
                                                        onWheel={e => e.target.blur()}
                                                        maxLength="2"
                                                        required
                                                    />
                                                    <span style={{alignSelf:'center',fontWeight:'bold',userSelect:'none'}}>:</span>
                                                    <input 
                                                        type="text"
                                                        className="form-control"
                                                        placeholder="ММ"
                                                        style={{width:'80px',textAlign:'center'}}
                                                        value={formData.shift_end_time.split(':')[1] || ''}
                                                        onChange={e => {
                                                            let minutes = e.target.value.replace(/\D/g, '');
                                                            if (minutes === '') {
                                                                const hours = formData.shift_end_time.split(':')[0] || '';
                                                                setFormData({...formData, shift_end_time: hours ? `${hours}:` : ''});
                                                                return;
                                                            }
                                                            minutes = Math.min(Math.max(parseInt(minutes) || 0, 0), 59).toString();
                                                            const hours = formData.shift_end_time.split(':')[0] || '';
                                                            setFormData({...formData, shift_end_time: hours ? `${hours}:${minutes}` : `0:${minutes}`});
                                                        }}
                                                        onBlur={e => {
                                                            let minutes = e.target.value.replace(/\D/g, '');
                                                            if (minutes) {
                                                                minutes = minutes.padStart(2, '0');
                                                                const hours = formData.shift_end_time.split(':')[0] || '00';
                                                                setFormData({...formData, shift_end_time: `${hours}:${minutes}`});
                                                            }
                                                        }}
                                                        onWheel={e => e.target.blur()}
                                                        maxLength="2"
                                                        required
                                                    />
                                        </div>
                                        </div>
                                        </div>
                                    </div>

                                    {/* Шаг 2: Выбор площадок и аккаунтов */}
                                    <div style={{background:'#fff',borderRadius:16,boxShadow:'0 2px 12px rgba(102,126,234,0.15)',padding:24,border:'1px solid #e1e8ed'}}>
                                        <div style={{fontWeight:700,color:'#667eea',marginBottom:20,display:'flex',alignItems:'center',gap:8,fontSize:'1.1em'}}>
                                            <span style={{background:'#667eea',color:'#fff',width:28,height:28,borderRadius:'50%',display:'flex',alignItems:'center',justifyContent:'center',fontSize:'0.9em'}}>2</span>
                                            Выбор площадок и аккаунтов
                                    </div>
                                        <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(300px, 1fr))',gap:20}}>
                                            {['bybit','htx','bliss','gate'].map(platform => (
                                                <div key={platform} style={{background:'#f8f9fa',borderRadius:8,padding:16}}>
                                                    <div style={{fontWeight:600,color:'#495057',marginBottom:12,display:'flex',alignItems:'center',gap:8}}>
                                                        <i className={`fab fa-${platform === 'htx' ? 'bitcoin' : platform}`}></i>
                                                        {platform.toUpperCase()}
                                        </div>
                                                    {formData.availableAccounts[platform] && formData.availableAccounts[platform].length > 0 ? (
                                                        <div style={{display:'flex',flexDirection:'column',gap:8}}>
                                                            {formData.availableAccounts[platform].map(acc => (
                                                                <label key={acc.id} style={{display:'flex',alignItems:'center',gap:8,fontSize:'0.9em'}}>
                                                                    <input 
                                                                        type="checkbox" 
                                                                        checked={formData.selectedAccounts[platform]?.includes(acc.id) || false}
                                                                        onChange={e => {
                                                                            const selected = formData.selectedAccounts[platform] || [];
                                                                        if (e.target.checked) {
                                                                                setFormData(prev => ({
                                                                                    ...prev,
                                                                                    selectedAccounts: {
                                                                                        ...prev.selectedAccounts,
                                                                                        [platform]: [...selected, acc.id]
                                                                                    }
                                                                                }));
                                                                        } else {
                                                                                setFormData(prev => ({
                                                                                    ...prev,
                                                                                    selectedAccounts: {
                                                                                        ...prev.selectedAccounts,
                                                                                        [platform]: selected.filter(id => id !== acc.id)
                                                                                    }
                                                                                }));
                                                                            }
                                                                        }}
                                                                    />
                                                                {acc.account_name}
                                                            </label>
                                                            ))}
                                        </div>
                                                    ) : (
                                                        <div style={{color:'#6c757d',fontSize:'0.9em',fontStyle:'italic'}}>
                                                            Нет доступных аккаунтов
                                    </div>
                                                    )}
                                    </div>
                                            ))}
                                    </div>
                                    </div>
                                    {/* Шаг 3: Балансы аккаунтов */}
                                    <div style={{background:'#fff',borderRadius:16,boxShadow:'0 2px 12px rgba(102,126,234,0.15)',padding:24,border:'1px solid #e1e8ed'}}>
                                        <div style={{fontWeight:700,color:'#667eea',marginBottom:20,display:'flex',alignItems:'center',gap:8,fontSize:'1.1em'}}>
                                            <span style={{background:'#667eea',color:'#fff',width:28,height:28,borderRadius:'50%',display:'flex',alignItems:'center',justifyContent:'center',fontSize:'0.9em'}}>3</span>
                                            Балансы аккаунтов
                                        </div>
                                        <div style={{background:'#fff3cd',border:'1px solid #ffeaa7',borderRadius:8,padding:12,marginBottom:16}}>
                                            <div style={{fontWeight:600,color:'#856404',marginBottom:4}}>⚠️ Важно:</div>
                                            <div style={{fontSize:'0.9em',color:'#856404'}}>
                                                Укажите начальный и конечный баланс для каждого выбранного аккаунта.
                                                Эти данные будут использованы для расчета статистики по смене.
                                            </div>
                                        </div>
                                        <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(350px, 1fr))',gap:20}}>
                                            {['bybit','htx','bliss','gate'].map(platform => (
                                                <div key={platform} style={{background:'#f8f9fa',borderRadius:8,padding:16}}>
                                                    <div style={{fontWeight:600,color:'#495057',marginBottom:12,display:'flex',alignItems:'center',gap:8}}>
                                                        <i className={`fab fa-${platform === 'htx' ? 'bitcoin' : platform}`}></i>
                                                        {platform.toUpperCase()}
                                                    </div>
                                                    {formData.selectedAccounts[platform] && formData.selectedAccounts[platform].length > 0 ? (
                                                        <div style={{display:'flex',flexDirection:'column',gap:12}}>
                                                            {formData.selectedAccounts[platform].map(accountId => {
                                                                const account = formData.availableAccounts[platform]?.find(acc => acc.id === accountId);
                                                                const balanceAccount = formData.balances[platform]?.find(acc => acc.id === accountId);
                                                return (
                                                                    <div key={accountId} style={{background:'#fff',borderRadius:6,padding:12,border:'1px solid #dee2e6'}}>
                                                                        <div style={{fontWeight:500,marginBottom:12,color:'#495057'}}>
                                                                            Аккаунт: {account?.account_name}
                                                                        </div>
                                                                        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12}}>
                                                                        <div>
                                                                                <label style={{fontWeight:500,marginBottom:4,display:'block',fontSize:'0.9em',color:'#495057'}}>
                                                                                    Начальный баланс (USDT)
                                                                                </label>
                                                                                                                                                        <input
                                                                                type="number"
                                                                                    step="0.01"
                                                                                className="form-control"
                                                                                    value={balanceAccount?.start_balance || ''}
                                                                                onChange={e => {
                                                                                        const value = e.target.value;
                                                                                        const platformBalances = formData.balances[platform] || [];
                                                                                        const accountIndex = platformBalances.findIndex(acc => acc.id === accountId);
                                                                                        
                                                                                        if (accountIndex === -1) {
                                                                                            // Добавляем новый аккаунт
                                                                                            platformBalances.push({
                                                                                                id: accountId,
                                                                                                account_name: account?.account_name,
                                                                                                start_balance: value,
                                                                                                end_balance: ''
                                                                                            });
                                                                                        } else {
                                                                                            // Обновляем существующий
                                                                                            platformBalances[accountIndex].start_balance = value;
                                                                                        }
                                                                                        
                                                                                setFormData(prev => ({
                                                                                    ...prev,
                                                                                    balances: {
                                                                                        ...prev.balances,
                                                                                                [platform]: platformBalances
                                                                                    }
                                                                                }));
                                                                                    }}
                                                                                    onWheel={e => e.target.blur()}
                                                                                    placeholder="0.00"
                                                                                />
                                        </div>
                                                                        <div>
                                                                                <label style={{fontWeight:500,marginBottom:4,display:'block',fontSize:'0.9em',color:'#495057'}}>
                                                                                    Конечный баланс (USDT)
                                                            </label>
                                                                            <input
                                                                                type="number"
                                                                                    step="0.01"
                                                                                className="form-control"
                                                                                    value={balanceAccount?.end_balance || ''}
                                                                                onChange={e => {
                                                                                        const value = e.target.value;
                                                                                        const platformBalances = formData.balances[platform] || [];
                                                                                        const accountIndex = platformBalances.findIndex(acc => acc.id === accountId);
                                                                                        
                                                                                        if (accountIndex === -1) {
                                                                                            // Добавляем новый аккаунт
                                                                                            platformBalances.push({
                                                                                                id: accountId,
                                                                                                account_name: account?.account_name,
                                                                                                start_balance: '',
                                                                                                end_balance: value
                                                                                            });
                                                                                        } else {
                                                                                            // Обновляем существующий
                                                                                            platformBalances[accountIndex].end_balance = value;
                                                                                        }
                                                                                        
                                                                                        setFormData(prev => ({
                                                                                            ...prev,
                                                                                            balances: {
                                                                                                ...prev.balances,
                                                                                                [platform]: platformBalances
                                                                                            }
                                                                                        }));
                                                                                }}
                                                                                    onWheel={e => e.target.blur()}
                                                                                    placeholder="0.00"
                                                                            />
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                        );
                                                    })}
                                                </div>
                                                    ) : (
                                                        <div style={{color:'#6c757d',fontSize:'0.9em',fontStyle:'italic'}}>
                                                            Не выбраны аккаунты для этой площадки
                                                        </div>
                                                    )}
                                                    </div>
                                                ))}
                                        </div>
                                    </div>

                                    {/* Шаг 4: Загрузка файлов выгрузок и ввод данных */}
                                    <div style={{background:'#fff',borderRadius:16,boxShadow:'0 2px 12px rgba(102,126,234,0.15)',padding:24,border:'1px solid #e1e8ed'}}>
                                        <div style={{fontWeight:700,color:'#667eea',marginBottom:20,display:'flex',alignItems:'center',gap:8,fontSize:'1.1em'}}>
                                            <span style={{background:'#667eea',color:'#fff',width:28,height:28,borderRadius:'50%',display:'flex',alignItems:'center',justifyContent:'center',fontSize:'0.9em'}}>4</span>
                                            Загрузка файлов выгрузок и ввод данных
                                        </div>
                                        <div style={{background:'#fff3cd',border:'1px solid #ffeaa7',borderRadius:8,padding:12,marginBottom:16}}>
                                            <div style={{fontWeight:600,color:'#856404',marginBottom:4}}>⚠️ Важно:</div>
                                            <div style={{fontSize:'0.9em',color:'#856404'}}>
                                                Для Bybit, Bliss и HTX загрузите отдельный файл выгрузки для каждого выбранного аккаунта.
                                                Для Gate введите сумму в USDT (всегда считается как покупка), которую отработал сотрудник за смену.
                                            </div>
                                        </div>
                                        <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(350px, 1fr))',gap:20}}>
                                            {['bybit','htx','bliss','gate'].map(platform => (
                                                <div key={platform} style={{background:'#f8f9fa',borderRadius:8,padding:16}}>
                                                    <div style={{fontWeight:600,color:'#495057',marginBottom:12,display:'flex',alignItems:'center',gap:8}}>
                                                        <i className={`fab fa-${platform === 'htx' ? 'bitcoin' : platform}`}></i>
                                                        {platform.toUpperCase()}
                                                    </div>
                                                    {formData.selectedAccounts[platform] && formData.selectedAccounts[platform].length > 0 ? (
                                                        <div style={{display:'flex',flexDirection:'column',gap:12}}>
                                                            {formData.selectedAccounts[platform].map(accountId => {
                                                                const account = formData.availableAccounts[platform]?.find(acc => acc.id === accountId);
                                                                
                                                                // Для Gate показываем поле ввода суммы
                                                                if (platform === 'gate') {
                                                                    return (
                                                                        <div key={accountId} style={{background:'#fff',borderRadius:6,padding:12,border:'1px solid #dee2e6'}}>
                                                                            <div style={{fontWeight:500,marginBottom:12,color:'#495057'}}>
                                                                                Аккаунт: {account?.account_name}
                                                                            </div>
                                                                            <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12}}>
                                                                                <div>
                                                                                    <label style={{fontWeight:500,marginBottom:4,display:'block',fontSize:'0.9em',color:'#495057'}}>
                                                                                        Сумма за смену (USDT) - всегда покупка
                                                                                    </label>
                                                                                    <input
                                                                                        type="number"
                                                                                        step="0.01"
                                                                                        className="form-control"
                                                                                        value={formData.gate_amounts?.[accountId] || ''}
                                                                                        onChange={e => {
                                                                                            const value = e.target.value;
                                                                                            setFormData(prev => ({
                                                                                                ...prev,
                                                                                                gate_amounts: {
                                                                                                    ...prev.gate_amounts,
                                                                                                    [accountId]: value
                                                                                                }
                                                                                            }));
                                                                                        }}
                                                                                        onWheel={e => e.target.blur()}
                                                                                        placeholder="0.00"
                                                                                    />
                                                                                </div>
                                                                                <div>
                                                                                    <label style={{fontWeight:500,marginBottom:4,display:'block',fontSize:'0.9em',color:'#495057'}}>
                                                                                        Сумма за смену (RUB)
                                                                                    </label>
                                                                                    <input
                                                                                        type="number"
                                                                                        step="0.01"
                                                                                        className="form-control"
                                                                                        value={formData.gate_amounts_rub?.[accountId] || ''}
                                                                                        onChange={e => {
                                                                                            const value = e.target.value;
                                                                                            setFormData(prev => ({
                                                                                                ...prev,
                                                                                                gate_amounts_rub: {
                                                                                                    ...prev.gate_amounts_rub,
                                                                                                    [accountId]: value
                                                                                                }
                                                                                            }));
                                                                                        }}
                                                                                        onWheel={e => e.target.blur()}
                                                                                        placeholder="0.00"
                                                                                    />
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    );
                                                                }
                                                                
                                                                // Для остальных площадок показываем загрузку файла
                                                                return (
                                                                    <div key={accountId} style={{background:'#fff',borderRadius:6,padding:12,border:'1px solid #dee2e6'}}>
                                                                        <label style={{fontWeight:500,marginBottom:8,display:'block',color:'#495057'}}>
                                                                            Файл для {account?.account_name}
                                                                        </label>
                                                                        <input 
                                                                            type="file" 
                                                                            className="form-control" 
                                                                            accept=".csv,.xlsx,.xls" 
                                                                            onChange={e => {
                                                                                const files = formData.accountFiles || {};
                                                                                files[`${platform}_${accountId}`] = e.target.files[0];
                                                                                setFormData(fd => ({...fd, accountFiles: files}));
                                                                            }}
                                                                        />
                                                                        <div style={{fontSize:'0.8em',color:'#6c757d',marginTop:4}}>
                                                                            Выгрузка для аккаунта {account?.account_name}
                                                                        </div>
                                                                        
                                                                        {/* Дополнительное поле для BTC файла Bybit */}
                                                                        {platform === 'bybit' && (
                                                                            <div style={{marginTop:12,padding:12,background:'#f8f9fa',borderRadius:6,border:'1px solid #e9ecef'}}>
                                                                                <label style={{fontWeight:500,marginBottom:8,display:'block',color:'#495057',fontSize:'0.9em'}}>
                                                                                    <i className="fas fa-bitcoin" style={{color:'#f7931a',marginRight:4}}></i>
                                                                                    BTC файл (опционально)
                                                                                </label>
                                                                                <input 
                                                                                    type="file" 
                                                                                    className="form-control" 
                                                                                    accept=".csv" 
                                                                                    onChange={e => {
                                                                                        const files = formData.accountFiles || {};
                                                                                        files[`bybit_btc_${accountId}`] = e.target.files[0];
                                                                                        setFormData(fd => ({...fd, accountFiles: files}));
                                                                                    }}
                                                                                />
                                                                                <div style={{fontSize:'0.75em',color:'#6c757d',marginTop:4}}>
                                                                                    CSV файл с BTC данными (необязательно)
                                                                                </div>
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                );
                                                            })}
                                    </div>
                                                    ) : (
                                                        <div style={{color:'#6c757d',fontSize:'0.9em',fontStyle:'italic'}}>
                                                            Не выбраны аккаунты для этой площадки
                                    </div>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    {/* Шаг 5: Дополнительные данные */}
                                    <div style={{background:'#fff',borderRadius:16,boxShadow:'0 2px 12px rgba(102,126,234,0.15)',padding:24,border:'1px solid #e1e8ed'}}>
                                        <div style={{fontWeight:700,color:'#667eea',marginBottom:20,display:'flex',alignItems:'center',gap:8,fontSize:'1.1em'}}>
                                            <span style={{background:'#667eea',color:'#fff',width:28,height:28,borderRadius:'50%',display:'flex',alignItems:'center',justifyContent:'center',fontSize:'0.9em'}}>5</span>
                                            Дополнительные данные
                                        </div>
                                        
                                        {/* Финансовые корректировки */}
                                        <div style={{marginBottom:24}}>
                                            <h4 style={{fontWeight:600,color:'#333',marginBottom:16,fontSize:'1em',borderBottom:'2px solid #e1e8ed',paddingBottom:8}}>
                                                💰 Финансовые корректировки
                                            </h4>
                                            <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(280px, 1fr))',gap:20}}>
                                                {/* СКАМ */}
                                                <div style={{background:'linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%)',padding:20,borderRadius:12,border:'1px solid #feb2b2'}}>
                                        <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(250px, 1fr))',gap:16}}>
                                                        {/* Сумма в USDT */}
                                            <div>
                                                            <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:8}}>
                                                                <i className="fas fa-exclamation-triangle" style={{color:'#e53e3e',fontSize:'1.1em'}}></i>
                                                                <label style={{fontWeight:600,color:'#c53030',fontSize:'0.95em'}}>СКАМ (сумма, USDT)</label>
                                                            </div>
                                                <input type="number" className="form-control" value={formData.scam_amount || ''} onChange={e => setFormData({ ...formData, scam_amount: e.target.value })} onWheel={e => e.target.blur()} />
                                                        </div>
                                                        
                                                        {/* Сумма в RUB */}
                                                        <div>
                                                            <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:8}}>
                                                                <i className="fas fa-ruble-sign" style={{color:'#e53e3e',fontSize:'1em'}}></i>
                                                                <label style={{fontWeight:600,color:'#c53030',fontSize:'0.95em'}}>СКАМ (сумма, RUB)</label>
                                                            </div>
                                                            <input type="number" className="form-control" value={formData.scam_amount_rub || ''} onChange={e => setFormData({ ...formData, scam_amount_rub: e.target.value })} onWheel={e => e.target.blur()} />
                                                        </div>
                                                        
                                                        {/* Платформа */}
                                                        <div>
                                                            <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:8}}>
                                                                <i className="fas fa-server" style={{color:'#e53e3e',fontSize:'1em'}}></i>
                                                                <label style={{fontWeight:600,color:'#c53030',fontSize:'0.95em'}}>Платформа для скама</label>
                                                            </div>
                                                            <select className="form-control" value={formData.scam_platform || 'bybit'} onChange={e => setFormData({ ...formData, scam_platform: e.target.value })}>
                                                                <option value="bybit">Bybit</option>
                                                                <option value="htx">HTX</option>
                                                                <option value="bliss">Bliss</option>
                                                                <option value="gate">Gate</option>
                                                            </select>
                                                        </div>
                                                        
                                                        {/* Аккаунт */}
                                                        <div>
                                                            <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:8}}>
                                                                <i className="fas fa-user" style={{color:'#e53e3e',fontSize:'1em'}}></i>
                                                                <label style={{fontWeight:600,color:'#c53030',fontSize:'0.95em'}}>Аккаунт для скама</label>
                                                            </div>
                                                            <input type="text" className="form-control" value={formData.scam_account || ''} onChange={e => setFormData({ ...formData, scam_account: e.target.value })} placeholder="Название аккаунта" />
                                                        </div>
                                                    </div>
                                                    

                                                    
                                                    {/* Комментарий */}
                                                    <div style={{marginTop:16}}>
                                                        <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:8}}>
                                                            <i className="fas fa-comment" style={{color:'#e53e3e',fontSize:'1em'}}></i>
                                                            <label style={{fontWeight:600,color:'#c53030',fontSize:'0.95em'}}>Комментарий по СКАМ</label>
                                                        </div>
                                                <input type="text" className="form-control" value={formData.scam_comment || ''} onChange={e => setFormData({ ...formData, scam_comment: e.target.value })} />
                                                    </div>
                                                    
                                                    {/* Чекбоксы для учета в статистике */}
                                                    <div style={{marginTop:16,display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(200px, 1fr))',gap:12}}>
                                                        <div style={{display:'flex',alignItems:'center',gap:8}}>
                                                            <input type="checkbox" checked={formData.scam_count_in_sales || false} onChange={e => setFormData({ ...formData, scam_count_in_sales: e.target.checked })} style={{margin:0}} />
                                                            <label style={{fontWeight:500,color:'#c53030',fontSize:'0.9em',margin:0}}>
                                                                Учитывать в продажах
                                                </label>
                                    </div>
                                                        <div style={{display:'flex',alignItems:'center',gap:8}}>
                                                            <input type="checkbox" checked={formData.scam_count_in_purchases || false} onChange={e => setFormData({ ...formData, scam_count_in_purchases: e.target.checked })} style={{margin:0}} />
                                                            <label style={{fontWeight:500,color:'#c53030',fontSize:'0.9em',margin:0}}>
                                                                Учитывать в покупках
                                                            </label>
                                            </div>
                                        </div>
                                            </div>
                                                

                                                
                                                {/* Внутренний перевод */}
                                                <div style={{background:'linear-gradient(135deg, #f0f9ff 0%, #bae6fd 100%)',padding:20,borderRadius:12,border:'1px solid #7dd3fc'}}>
                                                    <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(250px, 1fr))',gap:16}}>
                                                        {/* Сумма в USDT */}
                                                        <div>
                                                            <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:8}}>
                                                                <i className="fas fa-arrows-alt-h" style={{color:'#3182ce',fontSize:'1.1em'}}></i>
                                                                <label style={{fontWeight:600,color:'#1e40af',fontSize:'0.95em'}}>Внутренний перевод (USDT)</label>
                                        </div>
                                                            <input type="number" className="form-control" value={formData.internal_transfer_amount || ''} onChange={e => setFormData({ ...formData, internal_transfer_amount: e.target.value })} onWheel={e => e.target.blur()} />
                                                        </div>
                                                        
                                                        {/* Сумма в RUB */}
                                            <div>
                                                            <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:8}}>
                                                                <i className="fas fa-ruble-sign" style={{color:'#3182ce',fontSize:'1em'}}></i>
                                                                <label style={{fontWeight:600,color:'#1e40af',fontSize:'0.95em'}}>Внутренний перевод (сумма, RUB)</label>
                                        </div>
                                                            <input type="number" className="form-control" value={formData.internal_transfer_amount_rub || ''} onChange={e => setFormData({ ...formData, internal_transfer_amount_rub: e.target.value })} onWheel={e => e.target.blur()} />
                                                        </div>
                                                        
                                                        {/* Платформа */}
                                            <div>
                                                            <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:8}}>
                                                                <i className="fas fa-server" style={{color:'#3182ce',fontSize:'1em'}}></i>
                                                                <label style={{fontWeight:600,color:'#1e40af',fontSize:'0.95em'}}>Платформа для внутреннего перевода</label>
                                                            </div>
                                                            <select className="form-control" value={formData.internal_transfer_platform || 'bybit'} onChange={e => setFormData({ ...formData, internal_transfer_platform: e.target.value })}>
                                                                <option value="bybit">Bybit</option>
                                                                <option value="htx">HTX</option>
                                                                <option value="bliss">Bliss</option>
                                                                <option value="gate">Gate</option>
                                                            </select>
                                                        </div>
                                                        
                                                        {/* Аккаунт */}
                                                        <div>
                                                            <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:8}}>
                                                                <i className="fas fa-user" style={{color:'#3182ce',fontSize:'1em'}}></i>
                                                                <label style={{fontWeight:600,color:'#1e40af',fontSize:'0.95em'}}>Аккаунт для внутреннего перевода</label>
                                                            </div>
                                                            <input type="text" className="form-control" value={formData.internal_transfer_account || ''} onChange={e => setFormData({ ...formData, internal_transfer_account: e.target.value })} placeholder="Название аккаунта" />
                                                        </div>
                                                    </div>
                                                    
                                                    {/* Комментарий */}
                                                    <div style={{marginTop:16}}>
                                                        <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:8}}>
                                                            <i className="fas fa-comment" style={{color:'#3182ce',fontSize:'1em'}}></i>
                                                            <label style={{fontWeight:600,color:'#1e40af',fontSize:'0.95em'}}>Комментарий по внутреннему переводу</label>
                                                        </div>
                                                <input type="text" className="form-control" value={formData.internal_transfer_comment || ''} onChange={e => setFormData({ ...formData, internal_transfer_comment: e.target.value })} />
                                        </div>
                                                    
                                                    {/* Чекбоксы для учета в статистике */}
                                                    <div style={{marginTop:16,display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(200px, 1fr))',gap:12}}>
                                                        <div style={{display:'flex',alignItems:'center',gap:8}}>
                                                            <input type="checkbox" checked={formData.internal_transfer_count_in_sales || false} onChange={e => setFormData({ ...formData, internal_transfer_count_in_sales: e.target.checked })} style={{margin:0}} />
                                                            <label style={{fontWeight:500,color:'#1e40af',fontSize:'0.9em',margin:0}}>
                                                                Учитывать в продажах
                                                            </label>
                                                        </div>
                                                        <div style={{display:'flex',alignItems:'center',gap:8}}>
                                                            <input type="checkbox" checked={formData.internal_transfer_count_in_purchases || false} onChange={e => setFormData({ ...formData, internal_transfer_count_in_purchases: e.target.checked })} style={{margin:0}} />
                                                            <label style={{fontWeight:500,color:'#1e40af',fontSize:'0.9em',margin:0}}>
                                                                Учитывать в покупках
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {/* Докидки */}
                                        <div style={{marginBottom:24}}>
                                            <h4 style={{fontWeight:600,color:'#333',marginBottom:16,fontSize:'1em',borderBottom:'2px solid #e1e8ed',paddingBottom:8}}>
                                                💰 Докидки
                                            </h4>
                                            <div style={{background:'linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%)',padding:20,borderRadius:12,border:'1px solid #9ae6b4'}}>
                                                <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(250px, 1fr))',gap:16}}>
                                                    {/* Сумма в USDT */}
                                        <div>
                                                        <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:8}}>
                                                            <i className="fas fa-dollar-sign" style={{color:'#38a169',fontSize:'1em'}}></i>
                                                            <label style={{fontWeight:600,color:'#22543d',fontSize:'0.95em'}}>Докидка (сумма, USDT)</label>
                                                        </div>
                                                        <input type="number" className="form-control" value={formData.dokidka_amount || ''} onChange={e => setFormData({ ...formData, dokidka_amount: e.target.value })} onWheel={e => e.target.blur()} />
                                                    </div>
                                                    
                                                    {/* Сумма в RUB */}
                                                    <div>
                                                        <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:8}}>
                                                            <i className="fas fa-ruble-sign" style={{color:'#38a169',fontSize:'1em'}}></i>
                                                            <label style={{fontWeight:600,color:'#22543d',fontSize:'0.95em'}}>Докидка (сумма, RUB)</label>
                                                        </div>
                                                        <input type="number" className="form-control" value={formData.dokidka_amount_rub || ''} onChange={e => setFormData({ ...formData, dokidka_amount_rub: e.target.value })} onWheel={e => e.target.blur()} />
                                                    </div>
                                                    
                                                    {/* Платформа */}
                                                    <div>
                                                        <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:8}}>
                                                            <i className="fas fa-server" style={{color:'#38a169',fontSize:'1em'}}></i>
                                                            <label style={{fontWeight:600,color:'#22543d',fontSize:'0.95em'}}>Платформа для докидки</label>
                                                        </div>
                                                        <select className="form-control" value={formData.dokidka_platform || 'bybit'} onChange={e => setFormData({ ...formData, dokidka_platform: e.target.value })}>
                                                            <option value="bybit">Bybit</option>
                                                            <option value="htx">HTX</option>
                                                            <option value="bliss">Bliss</option>
                                                            <option value="gate">Gate</option>
                                                        </select>
                                                    </div>
                                                    
                                                    {/* Аккаунт */}
                                                    <div>
                                                        <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:8}}>
                                                            <i className="fas fa-user" style={{color:'#38a169',fontSize:'1em'}}></i>
                                                            <label style={{fontWeight:600,color:'#22543d',fontSize:'0.95em'}}>Аккаунт для докидки</label>
                                                        </div>
                                                        <input type="text" className="form-control" value={formData.dokidka_account || ''} onChange={e => setFormData({ ...formData, dokidka_account: e.target.value })} placeholder="Название аккаунта" />
                                                    </div>
                                                </div>
                                                
                                                {/* Комментарий */}
                                                <div style={{marginTop:16}}>
                                                    <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:8}}>
                                                        <i className="fas fa-comment" style={{color:'#38a169',fontSize:'1em'}}></i>
                                                        <label style={{fontWeight:600,color:'#22543d',fontSize:'0.95em'}}>Комментарий по докидке</label>
                                                    </div>
                                                    <input type="text" className="form-control" value={formData.dokidka_comment || ''} onChange={e => setFormData({ ...formData, dokidka_comment: e.target.value })} />
                                                </div>
                                                
                                                {/* Чекбоксы для учета в статистике */}
                                                <div style={{marginTop:16,display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(200px, 1fr))',gap:12}}>
                                                    <div style={{display:'flex',alignItems:'center',gap:8}}>
                                                        <input type="checkbox" checked={formData.dokidka_count_in_sales || false} onChange={e => setFormData({ ...formData, dokidka_count_in_sales: e.target.checked })} style={{margin:0}} />
                                                        <label style={{fontWeight:500,color:'#22543d',fontSize:'0.9em',margin:0}}>
                                                            Учитывать в продажах
                                                        </label>
                                                    </div>
                                                    <div style={{display:'flex',alignItems:'center',gap:8}}>
                                                        <input type="checkbox" checked={formData.dokidka_count_in_purchases || false} onChange={e => setFormData({ ...formData, dokidka_count_in_purchases: e.target.checked })} style={{margin:0}} />
                                                        <label style={{fontWeight:500,color:'#22543d',fontSize:'0.9em',margin:0}}>
                                                            Учитывать в покупках
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Апелляции */}
                                        <div>
                                            <h4 style={{fontWeight:600,color:'#333',marginBottom:16,fontSize:'1em',borderBottom:'2px solid #e1e8ed',paddingBottom:8}}>
                                                ⚖️ Апелляции
                                            </h4>
                                            <div style={{background:'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)',padding:20,borderRadius:12,border:'1px solid #f59e0b'}}>
                                                <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(250px, 1fr))',gap:16}}>
                                                    {/* Сумма в USDT */}
                                                    <div>
                                                        <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:8}}>
                                                            <i className="fas fa-dollar-sign" style={{color:'#d97706',fontSize:'1em'}}></i>
                                                            <label style={{fontWeight:600,color:'#92400e',fontSize:'0.95em'}}>Апелляции (сумма, USDT)</label>
                                                        </div>
                                                <input type="number" className="form-control" value={formData.appeal_amount || ''} onChange={e => setFormData({ ...formData, appeal_amount: e.target.value })} onWheel={e => e.target.blur()} />
                                                    </div>
                                                    
                                                    {/* Сумма в RUB */}
                                                    <div>
                                                        <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:8}}>
                                                            <i className="fas fa-ruble-sign" style={{color:'#d97706',fontSize:'1em'}}></i>
                                                            <label style={{fontWeight:600,color:'#92400e',fontSize:'0.95em'}}>Апелляции (сумма, RUB)</label>
                                                        </div>
                                                        <input type="number" className="form-control" value={formData.appeal_amount_rub || ''} onChange={e => setFormData({ ...formData, appeal_amount_rub: e.target.value })} onWheel={e => e.target.blur()} />
                                                    </div>
                                                    
                                                    {/* Платформа */}
                                                    <div>
                                                        <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:8}}>
                                                            <i className="fas fa-server" style={{color:'#d97706',fontSize:'1em'}}></i>
                                                            <label style={{fontWeight:600,color:'#92400e',fontSize:'0.95em'}}>Платформа для апелляции</label>
                                                        </div>
                                                        <select className="form-control" value={formData.appeal_platform || 'bybit'} onChange={e => setFormData({ ...formData, appeal_platform: e.target.value })}>
                                                            <option value="bybit">Bybit</option>
                                                            <option value="htx">HTX</option>
                                                            <option value="bliss">Bliss</option>
                                                            <option value="gate">Gate</option>
                                                        </select>
                                                    </div>
                                                    
                                                    {/* Аккаунт */}
                                                    <div>
                                                        <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:8}}>
                                                            <i className="fas fa-user" style={{color:'#d97706',fontSize:'1em'}}></i>
                                                            <label style={{fontWeight:600,color:'#92400e',fontSize:'0.95em'}}>Аккаунт для апелляции</label>
                                                        </div>
                                                        <input type="text" className="form-control" value={formData.appeal_account || ''} onChange={e => setFormData({ ...formData, appeal_account: e.target.value })} placeholder="Название аккаунта" />
                                                    </div>
                                                </div>
                                                
                                                {/* Комментарий и чекбокс */}
                                                <div style={{marginTop:16}}>
                                                    <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:8}}>
                                                        <i className="fas fa-comment" style={{color:'#d97706',fontSize:'1em'}}></i>
                                                        <label style={{fontWeight:600,color:'#92400e',fontSize:'0.95em'}}>Комментарий по апелляции</label>
                                                    </div>
                                                <input type="text" className="form-control" value={formData.appeal_comment || ''} onChange={e => setFormData({ ...formData, appeal_comment: e.target.value })} />
                                                    
                                                    <div style={{marginTop:12,display:'flex',alignItems:'center',gap:8}}>
                                                        <input type="checkbox" checked={formData.appeal_deducted || false} onChange={e => setFormData({ ...formData, appeal_deducted: e.target.checked })} style={{margin:0}} />
                                                        <label style={{fontWeight:500,color:'#92400e',fontSize:'0.9em',margin:0}}>
                                                        Вычесть из прибыли
                                                    </label>
                                    </div>
                                                    
                                                    {/* Чекбоксы для учета в статистике */}
                                                    <div style={{marginTop:16,display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(200px, 1fr))',gap:12}}>
                                                        <div style={{display:'flex',alignItems:'center',gap:8}}>
                                                            <input type="checkbox" checked={formData.appeal_count_in_sales || false} onChange={e => setFormData({ ...formData, appeal_count_in_sales: e.target.checked })} style={{margin:0}} />
                                                            <label style={{fontWeight:500,color:'#92400e',fontSize:'0.9em',margin:0}}>
                                                                Учитывать в продажах
                                                            </label>
                                                        </div>
                                                        <div style={{display:'flex',alignItems:'center',gap:8}}>
                                                            <input type="checkbox" checked={formData.appeal_count_in_purchases || false} onChange={e => setFormData({ ...formData, appeal_count_in_purchases: e.target.checked })} style={{margin:0}} />
                                                            <label style={{fontWeight:500,color:'#92400e',fontSize:'0.9em',margin:0}}>
                                                                Учитывать в покупках
                                                            </label>
                                                        </div>
                                                    </div>
                                                </div>
                                    </div>
                                    </div>
                                        </div>

                                    {/* Шаг 6: Фотографии */}
                                    <div style={{background:'#fff',borderRadius:16,boxShadow:'0 2px 12px rgba(102,126,234,0.15)',padding:24,border:'1px solid #e1e8ed'}}>
                                        <div style={{fontWeight:700,color:'#667eea',marginBottom:20,display:'flex',alignItems:'center',gap:8,fontSize:'1.1em'}}>
                                            <span style={{background:'#667eea',color:'#fff',width:28,height:28,borderRadius:'50%',display:'flex',alignItems:'center',justifyContent:'center',fontSize:'0.9em'}}>6</span>
                                            Фотографии смены
                                        </div>
                                        <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(300px, 1fr))',gap:20}}>
                                            <div>
                                                <label style={{fontWeight:600,marginBottom:8,display:'block'}}>Фото начала смены</label>
                                            <input type="file" className="form-control" accept="image/*" onChange={e => setFormData(fd => ({...fd, start_photo: e.target.files[0]}))} />
                                        </div>
                                            <div>
                                                <label style={{fontWeight:600,marginBottom:8,display:'block'}}>Фото конца смены</label>
                                            <input type="file" className="form-control" accept="image/*" onChange={e => setFormData(fd => ({...fd, end_photo: e.target.files[0]}))} />
                                        </div>
                                    </div>
                                    </div>
                                    {/* Кнопки */}
                                    <div style={{display:'flex',gap:18,justifyContent:'flex-end',marginTop:8}}>
                                        <button type="submit" className="btn" style={{minWidth:140}}><i className="fas fa-save"></i> Сохранить</button>
                                        <button type="button" className="btn btn-secondary" style={{minWidth:120}} onClick={() => setShowForm(false)}><i className="fas fa-times"></i> Отмена</button>
                                    </div>
                                </form>
                            </div>
                        )}

                        {/* --- НАЧАЛО: новая адаптивная таблица отчётов по сменам --- */}
                        <div style={{overflowX:'auto', width:'100%', marginTop: 12, borderRadius: '12px', boxShadow: '0 2px 12px #e1e8ed', background: '#fff', padding: '0'}}>
                          <table className="table shift-reports-table" style={{minWidth: '1200px', borderCollapse: 'separate', borderSpacing: 0, width: '100%'}}>
                            <thead style={{background: 'linear-gradient(90deg,#667eea 60%,#764ba2 100%)'}}>
                              <tr>
                                <th style={{color:'#fff',padding:'12px 8px',fontWeight:700,whiteSpace:'nowrap',borderTopLeftRadius:12}}>Дата</th>
                                <th style={{color:'#fff',padding:'12px 8px',fontWeight:700,whiteSpace:'nowrap'}}>Аккаунты смены</th>
                                <th style={{color:'#fff',padding:'12px 8px',fontWeight:700,whiteSpace:'nowrap'}}>Сотрудник</th>
                                <th style={{color:'#fff',padding:'12px 8px',fontWeight:700,whiteSpace:'nowrap'}}>Смена</th>
                                <th style={{color:'#fff',padding:'12px 8px',fontWeight:700,whiteSpace:'nowrap'}}>Всего заявок</th>
                                <th style={{color:'#fff',padding:'12px 8px',fontWeight:700,whiteSpace:'nowrap'}}>Продажи</th>
                                <th style={{color:'#fff',padding:'12px 8px',fontWeight:700,whiteSpace:'nowrap'}}>Покупки</th>
                                <th style={{color:'#fff',padding:'12px 8px',fontWeight:700,whiteSpace:'nowrap'}}>Прибыль</th>
                                <th style={{color:'#fff',padding:'12px 8px',fontWeight:700,whiteSpace:'nowrap'}}>СКАМ</th>
                                <th style={{color:'#fff',padding:'12px 8px',fontWeight:700,whiteSpace:'nowrap'}}>Докидка (внешний перевод, USDT)</th>
                                <th style={{color:'#fff',padding:'12px 8px',fontWeight:700,whiteSpace:'nowrap'}}>Внутренний перевод (USDT)</th>
                                <th style={{color:'#fff',padding:'12px 8px',fontWeight:700,whiteSpace:'nowrap'}}>Аппеляции (USDT)</th>
                                <th style={{color:'#fff',padding:'12px 8px',fontWeight:700,whiteSpace:'nowrap'}}></th>
                                <th style={{color:'#fff',padding:'12px 8px',fontWeight:700,whiteSpace:'nowrap',borderTopRightRadius:12}}></th>
                              </tr>
                            </thead>
                            <tbody>
                              {reports.map((report, idx) => {
                                const employee = employees.find(emp => emp.id === report.employee_id);
                                let balances = {};
                                try { balances = JSON.parse(report.balances_json || '{}'); } catch { balances = {}; }
                                
                                            // Статистика теперь передается напрямую в объекте report
                                
                                return (
                                  <React.Fragment key={report.id}>
                                    <tr style={{background: idx%2===0 ? '#f8f9fa' : '#fff', borderBottom: '1px solid #e1e8ed'}}>
                                      <td style={{padding:'10px 8px',verticalAlign:'middle',fontWeight:500}}>{new Date(report.shift_date).toLocaleDateString('ru-RU')}</td>
                                      <td style={{padding:'10px 8px',verticalAlign:'middle'}}>
                                        {(() => {
                                          const platformIcons = {
                                            BYBIT: <i className="fab fa-btc" style={{color:'#f7b731',marginRight:4}}></i>,
                                            HTX: <i className="fab fa-hubspot" style={{color:'#27ae60',marginRight:4}}></i>,
                                            BLISS: <i className="fas fa-bolt" style={{color:'#e74c3c',marginRight:4}}></i>,
                                            GATE: <i className="fas fa-circle" style={{color:'#764ba2',marginRight:4}}></i>
                                          };
                                          let accs = [];
                                          try {
                                            const bals = JSON.parse(report.balances_json || '{}');
                                            ['bybit','htx','bliss','gate'].forEach(platform => {
                                              if (bals[platform] && bals[platform].length > 0) {
                                                const names = bals[platform].map(acc => acc.account_name).filter(Boolean);
                                                if (names.length > 0) accs.push({
                                                  platform: platform.toUpperCase(),
                                                  names
                                                });
                                              }
                                            });
                                          } catch {}
                                          if (accs.length === 0) return '—';
                                          return (
                                            <div style={{display:'flex',flexDirection:'column',gap:4}}>
                                              {accs.map(acc => (
                                                <div key={acc.platform} style={{display:'flex',alignItems:'center',gap:6,marginBottom:2}}>
                                                  {platformIcons[acc.platform]}
                                                  <span style={{fontWeight:600,color:'#667eea',fontSize:'0.98em',marginRight:4}}>{acc.platform}:</span>
                                                  {acc.names.map((name, i) => (
                                                    <span key={name+i} style={{background:'#e1e8ed',color:'#333',borderRadius:12,padding:'3px 12px',fontSize:'0.97em',fontWeight:500,marginRight:6,marginBottom:2}}>{name}</span>
                                                  ))}
                                                </div>
                                              ))}
                                            </div>
                                          );
                                        })()}
                                      </td>
                                      <td style={{padding:'10px 8px',verticalAlign:'middle'}}>{employee ? employee.name : 'Неизвестно'}</td>
                                      <td style={{padding:'10px 8px',verticalAlign:'middle'}}>{report.shift_type === 'morning' ? 'Утренняя' : 'Вечерняя'}</td>
                                      <td style={{padding:'10px 8px',verticalAlign:'middle'}}>{report.total_requests}</td>
                                      <td style={{padding:'10px 8px',verticalAlign:'middle'}}>
                                        <div style={{background:'#ffebee',borderRadius:10,padding:'10px 12px',minWidth:180}}>
                                          <div style={{fontWeight:700,color:'#e74c3c',fontSize:'1.08em',marginBottom:4}}>
                                            {reportsStats[report.id]?.total_sales_rub?.toFixed(2) || '0.00'} ₽
                                              </div>
                                          <div style={{fontWeight:700,color:'#e74c3c',fontSize:'0.95em'}}>
                                            {reportsStats[report.id]?.total_sales_usdt?.toFixed(2) || '0.00'} USDT
                                              </div>
                                            </div>
                                      </td>
                                      <td style={{padding:'10px 8px',verticalAlign:'middle'}}>
                                        <div style={{background:'#e8f5e9',borderRadius:10,padding:'10px 12px',minWidth:180}}>
                                          <div style={{fontWeight:700,color:'#2ecc71',fontSize:'1.08em',marginBottom:4}}>
                                            {reportsStats[report.id]?.total_purchases_rub?.toFixed(2) || '0.00'} ₽
                                          </div>
                                          <div style={{fontWeight:700,color:'#2ecc71',fontSize:'0.95em'}}>
                                            {reportsStats[report.id]?.total_purchases_usdt?.toFixed(2) || '0.00'} USDT
                                          </div>
                                        </div>
                                      </td>
                                      <td style={{padding:'10px 8px',verticalAlign:'middle'}}>
                                        <div style={{background:'#f3f6fd',borderRadius:10,padding:'10px 12px',minWidth:180}}>
                                          <div style={{fontWeight:700,color:(reportsStats && reportsStats[report.id]?.total_profit_usdt >= 0) ? '#27ae60' : '#e74c3c',fontSize:'1.08em'}}>
                                            {(() => {
                                                let profit = (reportsStats && reportsStats[report.id]?.total_profit_usdt) || 0;
                                                // Если аппеляция должна быть вычтена из прибыли
                                                if (report.appeal_deducted && report.appeal_amount) {
                                                    profit -= parseFloat(report.appeal_amount);
                                                }
                                                return `${profit >= 0 ? '+' : ''}${profit.toFixed(2)} USDT`;
                                        })()}
                                          </div>
                                        </div>
                                      </td>
                                      <td style={{padding:'10px 8px',verticalAlign:'middle'}}>{report.scam_amount > 0 ? `${report.scam_amount} USDT` : '—'}</td>
                                      <td style={{padding:'10px 8px',verticalAlign:'middle'}}>{report.dokidka_amount !== 0 ? <span style={{color: report.dokidka_amount < 0 ? '#27ae60' : '#f7b731', fontWeight:600}}>{report.dokidka_amount > 0 ? '+' : ''}{report.dokidka_amount} USDT</span> : '—'}</td>
                                      <td style={{padding:'10px 8px',verticalAlign:'middle'}}>{report.internal_transfer_amount !== 0 ? <span style={{color: report.internal_transfer_amount < 0 ? '#27ae60' : '#f7b731', fontWeight:600}}>{report.internal_transfer_amount > 0 ? '+' : ''}{report.internal_transfer_amount} USDT</span> : '—'}</td>
                                      <td style={{padding:'10px 8px',verticalAlign:'middle'}}>{(report.appeal_amount || 0).toFixed(2)} USDT</td>
                                      <td style={{padding:'10px 8px',verticalAlign:'middle'}}>
                                        <button className="btn btn-secondary" style={{padding:'4px 10px',fontSize:'0.9em'}} onClick={() => setExpandedReportId(expandedReportId === report.id ? null : report.id)}>
                                          {expandedReportId === report.id ? 'Скрыть' : 'Подробнее'}
                                        </button>
                                      </td>
                                      <td style={{padding:'10px 8px',verticalAlign:'middle'}}>
                                        <button className="btn btn-secondary" onClick={() => handleDelete(report.id)} style={{padding:'4px 10px',fontSize:'0.9em'}}>Удалить</button>
                                      </td>
                                    </tr>
                                    {expandedReportId === report.id && (
                                      <ReportDetails 
                                        report={{
                                          ...report,
                                          total_sales_rub: reportsStats && reportsStats[report.id]?.total_sales_rub,
                                          total_sales_usdt: reportsStats && reportsStats[report.id]?.total_sales_usdt,
                                          total_purchases_rub: reportsStats && reportsStats[report.id]?.total_purchases_rub,
                                          total_purchases_usdt: reportsStats && reportsStats[report.id]?.total_purchases_usdt,
                                          total_profit_usdt: reportsStats && reportsStats[report.id]?.total_profit_usdt,
                                          avg_sale_price: reportsStats && reportsStats[report.id]?.avg_sale_price,
                                          avg_purchase_price: reportsStats && reportsStats[report.id]?.avg_purchase_price
                                        }} 
                                        reports={reports} 
                                        employees={employees} 
                                        accounts={accounts} 
                                        setShowDetails={setShowDetails} 
                                        showDetails={showDetails} 
                                        setZoomedImage={setZoomedImage} 
                                      />
                                    )}
                                  </React.Fragment>
                                );
                              })}
                            </tbody>
                          </table>
                        </div>
                        {/* --- КОНЕЦ: новая адаптивная таблица --- */}
                    </div>
                    {/* Модальное окно для увеличенного фото */}
                    {zoomedImage && (
                        <div style={{position:'fixed',top:0,left:0,width:'100vw',height:'100vh',background:'rgba(0,0,0,0.7)',zIndex:9999,display:'flex',alignItems:'center',justifyContent:'center'}} onClick={() => setZoomedImage(null)}>
                            <img src={zoomedImage} alt="Увеличенное фото" style={{maxHeight:'90vh',maxWidth:'90vw',borderRadius:12,boxShadow:'0 4px 32px #000'}} onClick={e => e.stopPropagation()} />
                            <button onClick={() => setZoomedImage(null)} style={{position:'fixed',top:30,right:40,fontSize:32,color:'#fff',background:'none',border:'none',cursor:'pointer',zIndex:10000}} title="Закрыть">&times;</button>
                        </div>
                    )}
                </div>
            );
        }

                // Добавляю компонент ReportDetails
        function ReportDetails({ report, reports, employees, accounts, setShowDetails, showDetails, setZoomedImage, reportsStats }) {
            const employee = employees.find(emp => emp.id === report.employee_id);
            let balances = {};
            try { balances = JSON.parse(report.balances_json || '{}'); } catch { balances = {}; }
            
            // Статистика теперь передается напрямую в объекте report
            
            return (
                <tr>
                    <td colSpan={15}>
                        <div style={{
                            display:'flex',
                            flexDirection:'column',
                            gap:'24px',
                            background:'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                            borderRadius:'24px',
                            padding:'2px',
                            margin:'16px 0',
                            boxShadow:'0 8px 32px rgba(102,126,234,0.25)',
                            maxWidth:'1200px',
                            marginLeft:'auto',
                            marginRight:'auto'
                        }}>
                            <div style={{
                                background:'#ffffff',
                                borderRadius:'22px',
                                padding:'32px 24px',
                                display:'flex',
                                flexDirection:'column',
                                gap:'24px'
                            }}>
                                {/* Заголовок с основной информацией */}
                                <div style={{
                                    display:'grid',
                                    gridTemplateColumns:'repeat(auto-fit, minmax(280px, 1fr))',
                                    gap:'20px',
                                    marginBottom:'8px'
                                }}>
                                    <div style={{
                                        background:'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                        borderRadius:'16px',
                                        padding:'20px',
                                        color:'white',
                                        display:'flex',
                                        alignItems:'center',
                                        gap:'16px',
                                        boxShadow:'0 4px 16px rgba(102,126,234,0.3)'
                                    }}>
                                        <i className="fas fa-calendar-alt" style={{fontSize:'28px',opacity:0.9}}></i>
                                        <div>
                                            <div style={{fontSize:'1.3em',fontWeight:'700',marginBottom:'4px'}}>
                                                {new Date(report.shift_date).toLocaleDateString('ru-RU')}
                                            </div>
                                            <div style={{fontSize:'0.95em',opacity:0.8}}>
                                                <i className={report.shift_type==='morning' ? 'fas fa-sun' : 'fas fa-moon'} style={{marginRight:'6px'}}></i>
                                                {report.shift_type === 'morning' ? 'Утренняя' : 'Вечерняя'} смена
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div style={{
                                        background:'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                                        borderRadius:'16px',
                                        padding:'20px',
                                        color:'white',
                                        display:'flex',
                                        alignItems:'center',
                                        gap:'16px',
                                        boxShadow:'0 4px 16px rgba(240,147,251,0.3)'
                                    }}>
                                        <i className="fas fa-user-circle" style={{fontSize:'28px',opacity:0.9}}></i>
                                        <div>
                                            <div style={{fontSize:'1.3em',fontWeight:'700',marginBottom:'4px'}}>
                                                {employee ? employee.name : 'Неизвестно'}
                                            </div>
                                            <div style={{fontSize:'0.95em',opacity:0.8}}>
                                                Сотрудник смены
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                {/* Основные финансовые показатели */}
                                <div style={{
                                    display:'grid',
                                    gridTemplateColumns:'repeat(auto-fit, minmax(200px, 1fr))',
                                    gap:'16px',
                                    marginBottom:'24px'
                                }}>
                                    {/* Продажи */}
                                    <div style={{
                                        background:'linear-gradient(135deg, #e74c3c 0%, #c0392b 100%)',
                                        borderRadius:'16px',
                                        padding:'24px',
                                        color:'white',
                                        textAlign:'center',
                                        boxShadow:'0 4px 16px rgba(231,76,60,0.3)',
                                        position:'relative',
                                        overflow:'hidden'
                                    }}>
                                        <div style={{
                                            position:'absolute',
                                            top:'-10px',
                                            right:'-10px',
                                            fontSize:'60px',
                                            opacity:0.1
                                        }}>
                                            <i className="fas fa-arrow-up"></i>
                                        </div>
                                        <div style={{fontSize:'0.9em',opacity:0.8,marginBottom:'8px'}}>ОБЩАЯ СУММА ПРОДАЖ (с переводами)</div>
                                        <div style={{fontSize:'1.8em',fontWeight:'700',marginBottom:'4px'}}>
                                            {(report.total_sales_rub?.toFixed(2)) || '0.00'} ₽
                                        </div>
                                        <div style={{fontSize:'1.2em',fontWeight:'500',opacity:0.9}}>
                                            {(report.total_sales_usdt?.toFixed(2)) || '0.00'} USDT
                                        </div>
                                    </div>
                                    
                                    {/* Покупки */}
                                    <div style={{
                                        background:'linear-gradient(135deg, #2ecc71 0%, #27ae60 100%)',
                                        borderRadius:'16px',
                                        padding:'24px',
                                        color:'white',
                                        textAlign:'center',
                                        boxShadow:'0 4px 16px rgba(46,204,113,0.3)',
                                        position:'relative',
                                        overflow:'hidden'
                                    }}>
                                        <div style={{
                                            position:'absolute',
                                            top:'-10px',
                                            right:'-10px',
                                            fontSize:'60px',
                                            opacity:0.1
                                        }}>
                                            <i className="fas fa-arrow-down"></i>
                                        </div>
                                        <div style={{fontSize:'0.9em',opacity:0.8,marginBottom:'8px'}}>ОБЩАЯ СУММА ПОКУПОК</div>
                                        <div style={{fontSize:'1.8em',fontWeight:'700',marginBottom:'4px'}}>
                                            {(report.total_purchases_rub?.toFixed(2)) || '0.00'} ₽
                                        </div>
                                        <div style={{fontSize:'1.2em',fontWeight:'500',opacity:0.9}}>
                                            {(report.total_purchases_usdt?.toFixed(2)) || '0.00'} USDT
                                        </div>
                                    </div>
                                    
                                    {/* Прибыль */}
                                    <div style={{
                                        background:'linear-gradient(135deg, #3498db 0%, #2980b9 100%)',
                                        borderRadius:'16px',
                                        padding:'24px',
                                        color:'white',
                                        textAlign:'center',
                                        boxShadow:'0 4px 16px rgba(52,152,219,0.3)',
                                        position:'relative',
                                        overflow:'hidden'
                                    }}>
                                        <div style={{
                                            position:'absolute',
                                            top:'-10px',
                                            right:'-10px',
                                            fontSize:'60px',
                                            opacity:0.1
                                        }}>
                                            <i className="fas fa-chart-line"></i>
                                        </div>
                                        <div style={{fontSize:'0.9em',opacity:0.8,marginBottom:'8px'}}>ПРИБЫЛЬ</div>
                                        <div style={{fontSize:'1.8em',fontWeight:'700',marginBottom:'4px'}}>
                                            {(() => {
                                                let profit = report.total_profit_usdt || 0;
                                                // Если аппеляция должна быть вычтена из прибыли
                                                if (report.appeal_deducted && report.appeal_amount) {
                                                    profit -= parseFloat(report.appeal_amount);
                                                }
                                                return `${profit >= 0 ? '+' : ''}${profit.toFixed(2)} USDT`;
                                            })()}
                                        </div>
                                    </div>
                                    
                                    {/* Средняя цена продажи */}
                                    <div style={{
                                        background:'linear-gradient(135deg, #f1c40f 0%, #f39c12 100%)',
                                        borderRadius:'16px',
                                        padding:'24px',
                                        color:'white',
                                        textAlign:'center',
                                        boxShadow:'0 4px 16px rgba(241,196,15,0.3)',
                                        position:'relative',
                                        overflow:'hidden'
                                    }}>
                                        <div style={{
                                            position:'absolute',
                                            top:'-10px',
                                            right:'-10px',
                                            fontSize:'60px',
                                            opacity:0.1
                                        }}>
                                            <i className="fas fa-tag"></i>
                                        </div>
                                        <div style={{fontSize:'0.9em',opacity:0.8,marginBottom:'8px'}}>СРЕДНЯЯ ЦЕНА ПРОДАЖИ</div>
                                        <div style={{fontSize:'1.8em',fontWeight:'700',marginBottom:'4px'}}>
                                            {(report.avg_sale_price?.toFixed(2)) || '0.00'} ₽/USDT
                                        </div>
                                    </div>
                                    
                                    {/* Средняя цена покупки */}
                                    <div style={{
                                        background:'linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%)',
                                        borderRadius:'16px',
                                        padding:'24px',
                                        color:'white',
                                        textAlign:'center',
                                        boxShadow:'0 4px 16px rgba(155,89,182,0.3)',
                                        position:'relative',
                                        overflow:'hidden'
                                    }}>
                                        <div style={{
                                            position:'absolute',
                                            top:'-10px',
                                            right:'-10px',
                                            fontSize:'60px',
                                            opacity:0.1
                                        }}>
                                            <i className="fas fa-tags"></i>
                                        </div>
                                        <div style={{fontSize:'0.9em',opacity:0.8,marginBottom:'8px'}}>СРЕДНЯЯ ЦЕНА ПОКУПКИ</div>
                                        <div style={{fontSize:'1.8em',fontWeight:'700',marginBottom:'4px'}}>
                                            {(report.avg_purchase_price?.toFixed(2)) || '0.00'} ₽/USDT
                                        </div>
                                    </div>
                                </div>
                                

                                {/* Информация о смене */}
                                <div style={{
                                    display:'grid',
                                    gridTemplateColumns:'repeat(auto-fit, minmax(300px, 1fr))',
                                    gap:'24px',
                                    marginBottom:'24px'
                                }}>
                                    {/* Фотографии */}
                                    <div style={{
                                        background:'#ffffff',
                                    borderRadius:'16px',
                                        padding:'24px',
                                        boxShadow:'0 4px 16px rgba(0,0,0,0.1)'
                                }}>
                                    <div style={{
                                            fontSize:'1.2em',
                                            fontWeight:'700',
                                            marginBottom:'16px',
                                            color:'#2c3e50',
                                        display:'flex',
                                        alignItems:'center',
                                            gap:'8px'
                                    }}>
                                            <i className="fas fa-images"></i>
                                            Фотографии
                                    </div>
                                    <div style={{
                                        display:'grid',
                                            gridTemplateColumns:'repeat(auto-fit, minmax(150px, 1fr))',
                                            gap:'16px'
                                        }}>
                                            {report.start_photo || report.end_photo ? (
                                                <>
                                                    {report.start_photo && (
                                                        <div style={{textAlign:'center'}}>
                                                            <div style={{marginBottom:'8px',color:'#7f8c8d',fontSize:'0.9em'}}>
                                                                Начало смены
                                                            </div>
                                                            <img 
                                                                src={`/uploads/${report.start_photo}`} 
                                                                alt="Фото начала смены"
                                                                style={{
                                                                    width:'100%',
                                                                    height:'150px',
                                                                    objectFit:'cover',
                                                                    borderRadius:'8px',
                                                                    cursor:'pointer',
                                                                    boxShadow:'0 2px 8px rgba(0,0,0,0.1)'
                                                                }}
                                                                onClick={() => setZoomedImage(`/uploads/${report.start_photo}`)}
                                                            />
                                                        </div>
                                                    )}
                                                    {report.end_photo && (
                                                        <div style={{textAlign:'center'}}>
                                                            <div style={{marginBottom:'8px',color:'#7f8c8d',fontSize:'0.9em'}}>
                                                                Конец смены
                                                            </div>
                                                            <img 
                                                                src={`/uploads/${report.end_photo}`} 
                                                                alt="Фото конца смены"
                                                                style={{
                                                                    width:'100%',
                                                                    height:'150px',
                                                                    objectFit:'cover',
                                                                    borderRadius:'8px',
                                                                    cursor:'pointer',
                                                                    boxShadow:'0 2px 8px rgba(0,0,0,0.1)'
                                                                }}
                                                                onClick={() => setZoomedImage(`/uploads/${report.end_photo}`)}
                                                            />
                                                        </div>
                                                    )}
                                                </>
                                            ) : (
                                                <div style={{
                                                textAlign:'center',
                                                    padding:'24px',
                                                    color:'#95a5a6',
                                                    fontStyle:'italic',
                                                    gridColumn:'1/-1'
                                                }}>
                                                    Нет загруженных фотографий
                                                </div>
                                            )}
                                                </div>
                                    </div>
                                </div>
                                

                                
                                {/* Балансы по аккаунтам */}
                                <div style={{
                                    background:'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
                                    borderRadius:'16px',
                                    padding:'20px',
                                    boxShadow:'0 4px 16px rgba(168,237,234,0.4)'
                                }}>
                                    <div style={{
                                        display:'flex',
                                        alignItems:'center',
                                        gap:'12px',
                                        marginBottom:'16px',
                                        color:'#2c5282'
                                    }}>
                                        <i className="fas fa-wallet" style={{fontSize:'20px'}}></i>
                                        <span style={{fontSize:'1.2em',fontWeight:'700'}}>Балансы по аккаунтам</span>
                                    </div>
                                    <div style={{
                                        background:'rgba(255,255,255,0.9)',
                                        borderRadius:'12px',
                                        padding:'16px',
                                        overflowX:'auto'
                                    }}>
                                        <table style={{
                                            width:'100%',
                                            borderCollapse:'collapse',
                                            fontSize:'0.95em'
                                        }}>
                                            <thead>
                                                <tr style={{borderBottom:'2px solid #e2e8f0'}}>
                                                    <th style={{textAlign:'left',padding:'12px 8px',color:'#1a202c',fontWeight:'700'}}>Платформа</th>
                                                    <th style={{textAlign:'left',padding:'12px 8px',color:'#1a202c',fontWeight:'700'}}>Аккаунт</th>
                                                    <th style={{textAlign:'right',padding:'12px 8px',color:'#1a202c',fontWeight:'700'}}>Начальный</th>
                                                    <th style={{textAlign:'right',padding:'12px 8px',color:'#1a202c',fontWeight:'700'}}>Конечный</th>
                                                    <th style={{textAlign:'right',padding:'12px 8px',color:'#1a202c',fontWeight:'700'}}>Изменение</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {['bybit','htx','bliss','gate'].flatMap(platform =>
                                                    (balances[platform]||[]).map(acc => {
                                                        const start = acc.start_balance !== '' && !isNaN(acc.start_balance) ? parseFloat(acc.start_balance) : 0;
                                                        const end = acc.end_balance !== '' && !isNaN(acc.end_balance) ? parseFloat(acc.end_balance) : 0;
                                                        const diff = end - start;
                                                        const platformColors = {
                                                            bybit: '#f7b731',
                                                            htx: '#27ae60',
                                                            bliss: '#e74c3c',
                                                            gate: '#764ba2'
                                                        };
                                                        return (
                                                            <tr key={platform+'-'+(acc.account_id||acc.id)} style={{
                                                                borderBottom:'1px solid #e2e8f0',
                                                                background: diff > 0 ? 'rgba(72,187,120,0.1)' : diff < 0 ? 'rgba(245,101,101,0.1)' : 'transparent'
                                                            }}>
                                                                <td style={{padding:'12px 8px'}}>
                                                                    <span style={{
                                                                        background: platformColors[platform],
                                                                        color:'white',
                                                                        padding:'4px 8px',
                                                                        borderRadius:'6px',
                                                                        fontSize:'0.8em',
                                                                        fontWeight:'600'
                                                                    }}>
                                                                        {platform.toUpperCase()}
                                                                    </span>
                                                                </td>
                                                                <td style={{padding:'12px 8px',fontWeight:'500'}}>{acc.account_name}</td>
                                                                <td style={{textAlign:'right',padding:'12px 8px',color:'#4a5568'}}>{start.toFixed(2)} USDT</td>
                                                                <td style={{textAlign:'right',padding:'12px 8px',color:'#4a5568'}}>{end.toFixed(2)} USDT</td>
                                                                <td style={{
                                                                    textAlign:'right',
                                                                    padding:'12px 8px',
                                                                    color: diff > 0 ? '#38a169' : diff < 0 ? '#e53e3e' : '#4a5568',
                                                                    fontWeight:'600'
                                                                }}>
                                                                    {diff > 0 ? '+' : ''}{diff.toFixed(2)} USDT
                                                                </td>
                                                            </tr>
                                                        );
                                                    })
                                                )}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                {/* Дополнительные финансовые показатели */}
                                <div style={{
                                    display:'grid',
                                    gridTemplateColumns:'repeat(auto-fit, minmax(180px, 1fr))',
                                    gap:'16px'
                                }}>
                                    {[
                                        {
                                            title: 'СКАМ',
                                            value: report.scam_amount,
                                            comment: report.scam_comment,
                                            color: '#e74c3c',
                                            icon: 'fas fa-exclamation-triangle',
                                            gradient: 'linear-gradient(135deg, #fc4a1a 0%, #f7b733 100%)'
                                        },
                                        {
                                            title: 'Докидка',
                                            value: report.dokidka_amount,
                                            comment: report.dokidka_comment,
                                            color: '#f7b731',
                                            icon: 'fas fa-arrow-down',
                                            gradient: 'linear-gradient(135deg, #f7b733 0%, #fc4a1a 100%)'
                                        },
                                        {
                                            title: 'Внутренний перевод',
                                            value: report.internal_transfer_amount,
                                            comment: report.internal_transfer_comment,
                                            color: '#667eea',
                                            icon: 'fas fa-exchange-alt',
                                            gradient: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
                                        },
                                        {
                                            title: 'Аппеляции',
                                            value: report.appeal_amount,
                                            comment: report.appeal_comment,
                                            color: '#764ba2',
                                            icon: 'fas fa-gavel',
                                            gradient: 'linear-gradient(135deg, #764ba2 0%, #667eea 100%)'
                                        }
                                    ].map(({title, value, comment, color, icon, gradient}) => {
                                        let numValue = 0;
                                        if (typeof value === 'string' && value.trim() !== '') numValue = parseFloat(value);
                                        else if (typeof value === 'number') numValue = value;
                                        if (isNaN(numValue)) numValue = 0;
                                        
                                        return (
                                            <div key={title} style={{
                                                background: gradient,
                                                borderRadius:'12px',
                                                padding:'16px',
                                                color:'white',
                                                position:'relative',
                                                overflow:'hidden',
                                                boxShadow:'0 4px 16px rgba(0,0,0,0.1)'
                                            }}>
                                                <div style={{
                                                    position:'absolute',
                                                    top:'-5px',
                                                    right:'-5px',
                                                    fontSize:'40px',
                                                    opacity:0.1
                                                }}>
                                                    <i className={icon}></i>
                                                </div>
                                                <div style={{fontSize:'0.85em',opacity:0.8,marginBottom:'8px'}}>
                                                    {title.toUpperCase()}
                                                </div>
                                                <div style={{fontSize:'1.3em',fontWeight:'700',marginBottom:'4px'}}>
                                                    {numValue !== 0 ? (
                                                        numValue < 0 ? `+${Math.abs(numValue).toFixed(2)}` : `${numValue.toFixed(2)}`
                                                    ) : '—'}
                                                    {numValue !== 0 && <span style={{fontSize:'0.7em',opacity:0.8,marginLeft:'4px'}}>USDT</span>}
                                                </div>
                                                {comment && (
                                                    <div style={{fontSize:'0.75em',opacity:0.7,marginTop:'4px'}}>
                                                        {comment}
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                                

                            </div>
                        </div>
                    </td>
                </tr>
            );
        }

        // --- ДОБАВЛЯЮ КОМПОНЕНТ AccountBalancesTable ---
        function AccountBalancesTable({ balances, reports, report, accounts }) {
            function findPrevBalance(account_id, platform) {
                const prev = reports
                    .filter(r => {
                        if (r.id === report.id) return false;
                        if (compareShifts(r.shift_date, r.shift_type, report.shift_date, report.shift_type) >= 0) return false;
                        let b = {};
                        try { b = JSON.parse(r.balances_json || '{}'); } catch { b = {}; }
                        return b[platform] && b[platform].some(a => (a.account_id || a.id) == account_id);
                    })
                    .sort((a, b) => {
                        if (compareShifts(a.shift_date, a.shift_type, b.shift_date, b.shift_type) > 0) return -1;
                        if (compareShifts(a.shift_date, a.shift_type, b.shift_date, b.shift_type) < 0) return 1;
                        return 0;
                    });
                if (prev.length > 0) {
                    let b = {};
                    try { b = JSON.parse(prev[0].balances_json || '{}'); } catch { b = {}; }
                    const acc = b[platform].find(a => (a.account_id || a.id) == account_id);
                    if (acc) {
                        // Сначала проверяем end_balance (новая структура)
                        if (acc.end_balance !== undefined && acc.end_balance !== '' && !isNaN(acc.end_balance)) {
                            return parseFloat(acc.end_balance);
                        }
                        // Затем проверяем balance (старая структура)
                        if (acc.balance !== undefined && acc.balance !== '' && !isNaN(acc.balance)) {
                            return parseFloat(acc.balance);
                        }
                    }
                }
                if (window.settingsInitialBalances) {
                    const acc = window.settingsInitialBalances.find(b => b.platform === platform && (b.account_id == account_id || b.account_name == (accounts.find(a => a.id == account_id)?.account_name)));
                    return acc && acc.balance !== undefined ? parseFloat(acc.balance) : 0;
                }
                return 0;
            }
            return (
                <div style={{
                    display: 'flex',
                    flexDirection: 'column',
                    gap: '16px',
                    marginTop: '12px',
                    marginBottom: '20px',
                    width: '100%'
                }}>
                    {['bybit','htx','bliss','gate'].map(platform => {
                        const platformColors = {
                            bybit: '#f7b731',
                            htx: '#27ae60',
                            bliss: '#e74c3c',
                            gate: '#764ba2'
                        };
                        const platformIcons = {
                            bybit: 'fab fa-btc',
                            htx: 'fab fa-hubspot',
                            bliss: 'fas fa-bolt',
                            gate: 'fas fa-circle'
                        };
                        
                        if (!balances[platform] || balances[platform].length === 0) {
                            return null;
                        }
                        
                        return (
                            <div key={platform} style={{
                                background: '#ffffff',
                                borderRadius: '12px',
                                padding: '16px',
                                boxShadow: '0 2px 8px rgba(0,0,0,0.1)',
                                border: `1px solid ${platformColors[platform]}20`
                            }}>
                                <div style={{
                                    fontWeight: 600,
                                    color: platformColors[platform],
                                    marginBottom: '16px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '8px',
                                    fontSize: '1.1em'
                                }}>
                                    <i className={platformIcons[platform]}></i>
                                    {platform.toUpperCase()}
                                </div>
                                <div style={{display: 'flex', flexDirection: 'column', gap: '12px'}}>
                                        {balances[platform].map(acc => {
                                            const start = acc.start_balance !== '' && !isNaN(acc.start_balance) ? parseFloat(acc.start_balance) : 0;
                                            const end = acc.end_balance !== '' && !isNaN(acc.end_balance) ? parseFloat(acc.end_balance) : 0;
                                            const diff = end - start;
                                        const diffPercentage = start !== 0 ? ((diff / start) * 100).toFixed(1) : '0.0';
                                        
                                            return (
                                            <div key={acc.account_id || acc.id} style={{
                                                background: '#f8f9fa',
                                                borderRadius: '10px',
                                                padding: '12px 16px',
                                                display: 'flex',
                                                flexDirection: 'column',
                                                gap: '8px'
                                            }}>
                                                <div style={{
                                                    display: 'flex',
                                                    justifyContent: 'space-between',
                                                    alignItems: 'center',
                                                    borderBottom: '1px solid #e1e8ed',
                                                    paddingBottom: '8px'
                                                }}>
                                                    <div style={{fontWeight: 600, color: '#2c3e50'}}>{acc.account_name}</div>
                                                    <div style={{
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        gap: '8px',
                                                        color: diff >= 0 ? '#27ae60' : '#e74c3c',
                                                        fontWeight: 600
                                                    }}>
                                                        <span>{diff >= 0 ? '+' : ''}{diff.toFixed(2)} USDT</span>
                                                        <span style={{
                                                            fontSize: '0.85em',
                                                            padding: '2px 6px',
                                                            background: diff >= 0 ? '#27ae6020' : '#e74c3c20',
                                                            borderRadius: '4px'
                                                        }}>
                                                            {diff >= 0 ? '↑' : '↓'} {diffPercentage}%
                                                        </span>
                                                    </div>
                                                </div>
                                                <div style={{
                                                    display: 'flex',
                                                    justifyContent: 'space-between',
                                                    fontSize: '0.95em',
                                                    color: '#666'
                                                }}>
                                                    <div>
                                                        <span style={{marginRight: '8px'}}>Начальный:</span>
                                                        <span style={{fontWeight: 500, color: '#2c3e50'}}>{start.toFixed(2)} USDT</span>
                                                    </div>
                                                    <div>
                                                        <span style={{marginRight: '8px'}}>Конечный:</span>
                                                        <span style={{fontWeight: 500, color: '#2c3e50'}}>{end.toFixed(2)} USDT</span>
                                                    </div>
                                                </div>
                                            </div>
                                    );
                                })}
                        </div>
                            </div>
                        );
                    }).filter(Boolean)}
                </div>
            );
        }

        // --- ДОБАВЛЯЮ КОМПОНЕНТ ReportFilesSection ---
        function ReportFilesSection({ report, setZoomedImage }) {
            // Состояния для ошибок загрузки фото
            const [startPhotoError, setStartPhotoError] = React.useState(false);
            const [endPhotoError, setEndPhotoError] = React.useState(false);

            return (
                <>
                    <div style={{margin:'24px 0 10px 0',display:'flex',alignItems:'center',gap:16}}>
                        <i className="fas fa-camera" style={{color:'#764ba2',fontSize:20}}></i>
                        <span style={{fontWeight:700,fontSize:'1.1em',color:'#764ba2'}}>Фотографии:</span>
                    </div>
                    <div style={{display:'flex',gap:24,flexWrap:'wrap',alignItems:'flex-start',marginTop:8}}>
                            {report.start_photo && !startPhotoError ? (
                            <div>
                                <b>Фото начала смены:</b><br/>
                                <img 
                                    src={`/uploads/${report.start_photo}`} 
                                    alt="Фото начала" 
                                    style={{
                                        maxWidth:200, 
                                        borderRadius:12, 
                                        marginTop:8, 
                                        cursor:'zoom-in',
                                        boxShadow:'0 2px 8px rgba(118,75,162,0.2)',
                                        border:'2px solid #764ba2'
                                    }} 
                                    onClick={() => setZoomedImage(`/uploads/${report.start_photo}`)} 
                                    onError={() => setStartPhotoError(true)} 
                                />
                                </div>
                            ) : report.start_photo ? (
                                <div style={{color:'#e74c3c',marginTop:12}}><b>Фото начала не найдено</b></div>
                        ) : (
                            <div style={{color:'#aaa',marginTop:12}}><b>Фото начала смены не загружено</b></div>
                        )}
                        
                            {report.end_photo && !endPhotoError ? (
                            <div>
                                <b>Фото конца смены:</b><br/>
                                <img 
                                    src={`/uploads/${report.end_photo}`} 
                                    alt="Фото конца" 
                                    style={{
                                        maxWidth:200, 
                                        borderRadius:12, 
                                        marginTop:8, 
                                        cursor:'zoom-in',
                                        boxShadow:'0 2px 8px rgba(118,75,162,0.2)',
                                        border:'2px solid #764ba2'
                                    }} 
                                    onClick={() => setZoomedImage(`/uploads/${report.end_photo}`)} 
                                    onError={() => setEndPhotoError(true)} 
                                />
                                </div>
                            ) : report.end_photo ? (
                                <div style={{color:'#e74c3c',marginTop:12}}><b>Фото конца не найдено</b></div>
                        ) : (
                            <div style={{color:'#aaa',marginTop:12}}><b>Фото конца смены не загружено</b></div>
                        )}
                    </div>
                </>
            );
        }

        function Settings({ authed, setAuthed, password, setPassword, initialBalances, setInitialBalances, accounts, loading }) {
            const [saving, setSaving] = useState(false);
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');
            const [activeTab, setActiveTab] = React.useState('salary');
            const [formData, setFormData] = useState({
                base_percent: 30,
                min_daily_profit: 100.0,
                bonus_percent: 5,
                bonus_profit_threshold: 150.0
            });

            // Загружаем настройки зарплаты при монтировании
            useEffect(() => {
                if (authed) {
                    fetch('/api/settings/salary')
                        .then(r => r.json())
                        .then(data => {
                            if (!data.error) {
                                setFormData(data);
                            }
                        })
                        .catch(err => {
                            console.error('Error loading salary settings:', err);
                            setError('Ошибка загрузки настроек зарплаты');
                        });
                }
            }, [authed]);

            // Группируем аккаунты по платформам
            const platforms = [
                { value: 'bybit', label: 'Bybit' },
                { value: 'htx', label: 'HTX' },
                { value: 'bliss', label: 'Bliss' },
                { value: 'gate', label: 'Gate' }
            ];
            const grouped = {};
            platforms.forEach(p => grouped[p.value] = []);
            accounts.forEach(acc => {
                if (grouped[acc.platform]) grouped[acc.platform].push(acc);
            });
            // Сопоставляем балансы с аккаунтами
            const getBalance = (platform, account_name) => {
                const found = initialBalances.find(b => b.platform === platform && b.account_name === account_name);
                return found ? found.balance : '';
            };
            const handleBalanceChange = (platform, account_name, value) => {
                setInitialBalances(balances => {
                    const idx = balances.findIndex(b => b.platform === platform && b.account_name === account_name);
                    if (idx >= 0) {
                        const updated = [...balances];
                        updated[idx] = { ...updated[idx], balance: value };
                        return updated;
                    } else {
                        return [...balances, { platform, account_name, balance: value }];
                    }
                });
            };
            const handleSave = async () => {
                setSaving(true); setError(''); setSuccess('');
                try {
                    // Сохраняем балансы
                    if (activeTab === 'balances') {
                    const response = await fetch('/api/settings/balances', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password: password, balances: initialBalances })
                    });
                        if (!response.ok) {
                        const data = await response.json();
                            throw new Error(data.error || 'Ошибка сохранения балансов');
                        }
                    }
                    
                    // Сохраняем настройки зарплаты
                    if (activeTab === 'salary') {
                        const response = await fetch('/api/settings/salary', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                password: password,
                                base_percent: formData.base_percent,
                                min_daily_profit: formData.min_daily_profit,
                                bonus_percent: formData.bonus_percent,
                                bonus_profit_threshold: formData.bonus_profit_threshold
                            })
                        });
                        if (!response.ok) {
                            const data = await response.json();
                            throw new Error(data.error || 'Ошибка сохранения настроек зарплаты');
                        }
                    }
                    
                    setSuccess('Сохранено!');
                } catch (e) {
                    console.error('Save error:', e);
                    setError(e.message || 'Ошибка сохранения');
                }
                setSaving(false);
            };
            if (!authed) {
                return (
                    <div className="card" style={{maxWidth:400,margin:'40px auto',textAlign:'center'}}>
                        <h3><i className="fas fa-lock"></i> Вход в настройки</h3>
                        <input type="password" className="form-control" placeholder="Пароль администратора" value={password} onChange={e => setPassword(e.target.value)} style={{margin:'20px 0'}} />
                        <button className="btn" onClick={() => { 
                            fetch('/api/auth/admin', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ password: password })
                            })
                            .then(r => r.json())
                            .then(data => {
                                if (data.success) {
                                    setAuthed(true);
                                    setError('');
                                } else {
                                    setError('Неверный пароль');
                                }
                            })
                            .catch(err => {
                                console.error('Admin login error:', err);
                                setError('Ошибка при входе');
                            });
                        }}>Войти</button>
                        {error && <div style={{color:'#e74c3c',marginTop:10}}>{error}</div>}
                    </div>
                );
            }
            if (loading) return <div className="loading">Загрузка...</div>;
            
            return (
                <div className="card">
                    <div style={{display:'flex',gap:16,marginBottom:24}}>
                        <button 
                            onClick={() => setActiveTab('salary')}
                            className={`btn ${activeTab === 'salary' ? 'btn-primary' : ''}`}
                            style={{
                                flex: 1,
                                background: activeTab === 'salary' ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : '#fff',
                                color: activeTab === 'salary' ? '#fff' : '#333',
                                border: activeTab === 'salary' ? 'none' : '1px solid #ddd',
                                padding: '12px 20px',
                                borderRadius: '8px',
                                fontSize: '14px',
                                fontWeight: 600,
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                gap: 8
                            }}
                        >
                            <i className="fas fa-money-bill-wave"></i>
                            Расчет зарплаты
                        </button>
                        <button 
                            onClick={() => setActiveTab('percent')}
                            className={`btn ${activeTab === 'percent' ? 'btn-primary' : ''}`}
                            style={{
                                flex: 1,
                                background: activeTab === 'percent' ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : '#fff',
                                color: activeTab === 'percent' ? '#fff' : '#333',
                                border: activeTab === 'percent' ? 'none' : '1px solid #ddd',
                                padding: '12px 20px',
                                borderRadius: '8px',
                                fontSize: '14px',
                                fontWeight: 600,
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                gap: 8
                            }}
                        >
                            <i className="fas fa-percent"></i>
                            Проценты сотрудникам
                        </button>
                        <button 
                            onClick={() => setActiveTab('balances')}
                            className={`btn ${activeTab === 'balances' ? 'btn-primary' : ''}`}
                            style={{
                                flex: 1,
                                background: activeTab === 'balances' ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : '#fff',
                                color: activeTab === 'balances' ? '#fff' : '#333',
                                border: activeTab === 'balances' ? 'none' : '1px solid #ddd',
                                padding: '12px 20px',
                                borderRadius: '8px',
                                fontSize: '14px',
                                fontWeight: 600,
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                gap: 8
                            }}
                        >
                            <i className="fas fa-wallet"></i>
                            Балансы аккаунтов
                        </button>
                    </div>
                    
                    <div className="form-group" style={{maxWidth:300,margin:'0 0 24px 0'}}>
                        <label>Пароль администратора для сохранения</label>
                        <input type="password" className="form-control" value={password} onChange={e => setPassword(e.target.value)} placeholder="Пароль администратора" />
                    </div>
                    
                    {/* Расчет зарплаты */}
                    {activeTab === 'salary' && (
                        <div>
                            <div style={{marginBottom:24,padding:'24px',background:'#fff',borderRadius:16,boxShadow:'0 2px 8px #e1e8ed'}}>
                                <h3 style={{marginBottom:16,display:'flex',alignItems:'center',gap:8}}>
                                    <i className="fas fa-money-bill-wave" style={{color:'#27ae60'}}></i>
                                    Настройки расчета зарплаты
                                </h3>
                                <div style={{color:'#666',marginBottom:16}}>
                                    Настройте параметры расчета зарплаты на основе средней ежедневной прибыли сотрудников
                                </div>
                                                                                <div style={{display:'flex',flexDirection:'column',gap:16}}>
                                                    <div>
                                                        <label style={{display:'block',marginBottom:8}}>Базовый процент от прибыли</label>
                                                        <input 
                                                            type="number" 
                                                            className="form-control" 
                                                            style={{maxWidth:200}} 
                                                            value={formData.base_percent || ''} 
                                                            onChange={e => setFormData({...formData, base_percent: parseInt(e.target.value) || 0})}
                                                            onWheel={e => e.target.blur()}
                                                        />
                                                        <div style={{fontSize:'0.9em',color:'#666',marginTop:4}}>
                                                            Процент от прибыли, который получает сотрудник за смену
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <label style={{display:'block',marginBottom:8}}>Минимальная средняя ежедневная прибыль (USDT)</label>
                                                        <input 
                                                            type="number" 
                                                            step="0.01"
                                                            className="form-control" 
                                                            style={{maxWidth:200}} 
                                                            value={formData.min_daily_profit || ''} 
                                                            onChange={e => setFormData({...formData, min_daily_profit: parseFloat(e.target.value) || 0})}
                                                            onWheel={e => e.target.blur()}
                                                        />
                                                        <div style={{fontSize:'0.9em',color:'#666',marginTop:4}}>
                                                            Минимальная средняя прибыль за день для получения базового процента
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <label style={{display:'block',marginBottom:8}}>Бонус за превышение плана</label>
                                                        <input 
                                                            type="number" 
                                                            className="form-control" 
                                                            style={{maxWidth:200}} 
                                                            value={formData.bonus_percent || ''} 
                                                            onChange={e => setFormData({...formData, bonus_percent: parseInt(e.target.value) || 0})}
                                                            onWheel={e => e.target.blur()}
                                                        />
                                                        <div style={{fontSize:'0.9em',color:'#666',marginTop:4}}>
                                                            Дополнительный процент при превышении {formData.bonus_profit_threshold || 150} USDT средней прибыли в день
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <label style={{display:'block',marginBottom:8}}>Порог прибыли для получения бонуса (USDT)</label>
                                                        <input 
                                                            type="number" 
                                                            step="0.01"
                                                            className="form-control" 
                                                            style={{maxWidth:200}} 
                                                            value={formData.bonus_profit_threshold || ''} 
                                                            onChange={e => setFormData({...formData, bonus_profit_threshold: parseFloat(e.target.value) || 0})}
                                                            onWheel={e => e.target.blur()}
                                                        />
                                                        <div style={{fontSize:'0.9em',color:'#666',marginTop:4}}>
                                                            Средняя прибыль в день для получения бонуса
                                                        </div>
                                                    </div>
                                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Проценты сотрудникам */}
                    {activeTab === 'percent' && (
                        <div style={{padding:'24px',background:'#fff',borderRadius:16,boxShadow:'0 2px 8px #e1e8ed'}}>
                            <h3 style={{marginBottom:16}}><i className="fas fa-percent" style={{color:'#764ba2',marginRight:8}}></i> Проценты сотрудников</h3>
                            <EmployeePercentSettings />
                        </div>
                    )}
                    
                    {/* Балансы аккаунтов */}
                    {activeTab === 'balances' && (
                        <div>
                            <h3 style={{marginBottom:16}}><i className="fas fa-wallet" style={{color:'#f7b731',marginRight:8}}></i> Начальные балансы аккаунтов</h3>
                            <p style={{color:'#666',marginBottom:24}}>Эти значения будут использоваться как стартовые для расчета дельт и первой статистики.</p>
                            
                    {platforms.map(p => (
                        <div key={p.value} style={{marginBottom:20}}>
                                    <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:12}}>
                                        <i className={`fas fa-${p.value === 'bybit' ? 'chart-line' : p.value === 'htx' ? 'chart-bar' : 'exchange-alt'}`} style={{color:p.value === 'bybit' ? '#ffa500' : p.value === 'htx' ? '#00d4aa' : '#ff6b6b'}}></i>
                            <b>{p.label}</b>
                                    </div>
                                    {grouped[p.value].length === 0 ? (
                                        <div style={{color:'#aaa',padding:'12px',background:'#f8f9fa',borderRadius:8}}>Нет аккаунтов</div>
                                    ) : (
                                <table className="table" style={{marginTop:8}}>
                                            <thead>
                                                <tr>
                                                    <th>Аккаунт</th>
                                                    <th>Начальный баланс</th>
                                                </tr>
                                            </thead>
                                    <tbody>
                                        {grouped[p.value].map(acc => (
                                            <tr key={acc.id}>
                                                <td>{acc.account_name}</td>
                                                <td>
                                                    <input
                                                        type="number"
                                                        onWheel={e => e.target.blur()}
                                                        className="form-control"
                                                        style={{maxWidth:120}}
                                                        value={getBalance(p.value, acc.account_name)}
                                                        onChange={e => handleBalanceChange(p.value, acc.account_name, e.target.value)}
                                                    />
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            )}
                        </div>
                    ))}
                    </div>
                    )}
                    
                    <div style={{marginTop:24,paddingTop:24,borderTop:'1px solid #eee'}}>
                        <button 
                            className="btn" 
                            onClick={handleSave} 
                            disabled={saving}
                            style={{
                                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                color: '#fff',
                                border: 'none',
                                padding: '12px 24px',
                                borderRadius: '8px',
                                fontSize: '14px',
                                fontWeight: 600
                            }}
                        >
                            {saving ? 'Сохранение...' : 'Сохранить изменения'}
                        </button>
                    {(!password || password.length < 3) && <div style={{color:'#e74c3c',marginTop:10}}>Введите пароль администратора для сохранения изменений</div>}
                    {success && <div style={{color:'#27ae60',marginTop:10}}>{success}</div>}
                    {error && <div style={{color:'#e74c3c',marginTop:10}}>{error}</div>}
                    </div>
                </div>
            );
        }

        function Statistics({ stats, start, end, setStart, setEnd, loading }) {
            return (
                <div className="card">
                    <h3><i className="fas fa-chart-pie"></i> Подробная статистика по сотрудникам</h3>
                    <div style={{display:'flex',gap:16,alignItems:'end',margin:'18px 0 28px 0',flexWrap:'wrap'}}>
                        <div>
                            <label>Период с</label>
                            <input type="date" className="form-control" value={start} onChange={e => setStart(e.target.value)} style={{minWidth:140}} />
                        </div>
                        <div>
                            <label>по</label>
                            <input type="date" className="form-control" value={end} onChange={e => setEnd(e.target.value)} style={{minWidth:140}} />
                        </div>
                    </div>
                    
                    {loading ? <div className="loading">Загрузка...</div> : (
                        <div style={{overflowX:'auto'}}>
                            <table className="table" style={{minWidth:900}}>
                                <thead>
                                    <tr>
                                        <th>Сотрудник</th>
                                        <th>Смен</th>
                                        <th>Дней</th>
                                        <th>Заявок (всего)</th>
                                        <th>Bybit</th>
                                        <th>HTX</th>
                                        <th>Bliss</th>
                                        <th>Сред. заявок/день</th>
                                        <th><span title="Суммарная прибыль за все смены"><i className='fas fa-coins' style={{color:'#27ae60'}}></i> Прибыль за смены</span></th>
                                        <th><span title="30% от прибыли за смены"><i className='fas fa-money-bill-wave' style={{color:'#27ae60'}}></i> Зарплата</span></th>
                                        <th><span title="Сумма скама"><i className='fas fa-skull-crossbones' style={{color:'#e74c3c'}}></i> Скам</span></th>
                                        <th><span title="Сумма переводов"><i className='fas fa-exchange-alt' style={{color:'#f7b731'}}></i> Переводы</span></th>
                                        <th><span title="Средняя прибыль за смену"><i className='fas fa-chart-line' style={{color:'#3c78d8'}}></i> Сред. прибыль/смену</span></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {stats.map(emp => (
                                        <tr key={emp.id} style={{background: emp.salary > 0 ? '#f8fff8' : emp.salary < 0 ? '#fff8f8' : undefined}}>
                                            <td><b>{emp.name}</b><br/><span style={{color:'#888',fontSize:'0.95em'}}>{emp.telegram}</span></td>
                                            <td>{emp.total_shifts}</td>
                                            <td>{emp.total_days}</td>
                                            <td>{emp.total_requests}</td>
                                            <td>{emp.total_bybit}</td>
                                            <td>{emp.total_htx}</td>
                                            <td>{emp.total_bliss}</td>
                                            <td>{emp.avg_requests_per_day}</td>
                                            <td style={{color:'#27ae60',fontWeight:700,fontSize:'1.1em'}}>{emp.net_profit >= 0 ? '+' : ''}{emp.net_profit} <span style={{fontSize:'0.95em',color:'#888'}}>USDT</span></td>
                                            <td style={{color:'#27ae60',fontWeight:700}}>{emp.salary} <span style={{fontSize:'0.95em',color:'#888'}}>USDT</span></td>
                                            <td style={{color:'#e74c3c',fontWeight:700}}>{emp.total_scam} <span style={{fontSize:'0.95em',color:'#888'}}>USDT</span></td>
                                            <td style={{color:'#f7b731',fontWeight:700}}>{emp.total_transfer} <span style={{fontSize:'0.95em',color:'#888'}}>USDT</span></td>
                                            <td style={{color:'#3c78d8',fontWeight:700}}>{emp.avg_profit_per_shift} <span style={{fontSize:'0.95em',color:'#888'}}>USDT</span></td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            );
        }

        // --- Модальное окно профиля сотрудника ---
        function EmployeeProfileModal({ employeeId, startDate, endDate, onClose }) {
            const [profile, setProfile] = React.useState(null);
            const [loading, setLoading] = React.useState(true);
            const [error, setError] = React.useState('');
            const [activeTab, setActiveTab] = React.useState('summary');

            React.useEffect(() => {
                if (employeeId) {
                    setLoading(true);
                    const url = `/api/employee-profile/${employeeId}?start_date=${startDate}&end_date=${endDate}`;
                    fetch(url)
                        .then(r => r.json())
                        .then(data => {
                            if (data.error) {
                                setError(data.error);
                            } else {
                                setProfile(data);
                            }
                            setLoading(false);
                        })
                        .catch(err => {
                            setError('Ошибка загрузки профиля');
                            setLoading(false);
                        });
                }
            }, [employeeId, startDate, endDate]);

            if (!employeeId) return null;

            return (
                <div className="modal" style={{display:'block',position:'fixed',top:0,left:0,right:0,bottom:0,backgroundColor:'rgba(0,0,0,0.8)',zIndex:1000}}>
                    <div className="modal-dialog" style={{maxWidth:'95vw',width:'1200px',margin:'10px auto',height:'calc(100vh - 20px)'}}>
                        <div className="modal-content" style={{height:'100%',display:'flex',flexDirection:'column',borderRadius:'12px',overflow:'hidden',backgroundColor:'#ffffff',boxShadow:'0 10px 30px rgba(0,0,0,0.3)'}}>
                            <div className="modal-header" style={{borderBottom:'1px solid #e0e0e0',padding:'16px 20px',background:'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',color:'white',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                                <h4 style={{margin:0,display:'flex',alignItems:'center',gap:12,fontSize:'18px'}}>
                                    <i className="fas fa-user-circle"></i>
                                    {profile ? `Профиль: ${profile.employee.name}` : 'Загрузка...'}
                                </h4>
                                <button onClick={onClose} style={{background:'none',border:'none',color:'white',fontSize:'24px',cursor:'pointer',padding:'0 8px'}}>&times;</button>
                            </div>
                            
                            <div className="modal-body" style={{flex:1,padding:0,overflow:'hidden',display:'flex',flexDirection:'column'}}>
                                {loading && (
                                    <div style={{padding:40,textAlign:'center'}}>
                                        <div className="loading">Загрузка профиля...</div>
                                    </div>
                                )}
                                
                                {error && (
                                    <div style={{padding:20,color:'#e74c3c',textAlign:'center'}}>
                                        <i className="fas fa-exclamation-triangle"></i> {error}
                                    </div>
                                )}
                                
                                {profile && (
                                    <>
                                        {/* Вкладки */}
                                        <div style={{display:'flex',borderBottom:'1px solid #e0e0e0',padding:'0 20px',overflowX:'auto'}}>
                                            {[
                                                {key: 'summary', label: 'Общие', icon: 'fas fa-chart-bar'},
                                                {key: 'reports', label: 'Смены', icon: 'fas fa-calendar-alt'},
                                                {key: 'orders', label: 'Ордеры', icon: 'fas fa-exchange-alt'},
                                                {key: 'scams', label: 'Скамы', icon: 'fas fa-skull-crossbones'},
                                                {key: 'performance', label: 'Производительность', icon: 'fas fa-trophy'},
                                                {key: 'analytics', label: 'Аналитика', icon: 'fas fa-chart-line'}
                                            ].map(tab => (
                                                <button
                                                    key={tab.key}
                                                    onClick={() => setActiveTab(tab.key)}
                                                    style={{
                                                        padding: '12px 16px',
                                                        border: 'none',
                                                        background: activeTab === tab.key ? '#667eea' : 'transparent',
                                                        color: activeTab === tab.key ? 'white' : '#666',
                                                        cursor: 'pointer',
                                                        borderRadius: '8px 8px 0 0',
                                                        margin: '4px 2px 0 0',
                                                        fontSize: '14px',
                                                        whiteSpace: 'nowrap',
                                                        transition: 'all 0.3s ease'
                                                    }}
                                                >
                                                    <i className={tab.icon}></i> {tab.label}
                                                </button>
                                            ))}
                                        </div>
                                        
                                        {/* Контент вкладок */}
                                        <div style={{flex:1,overflow:'auto',padding:'20px'}}>
                                            {activeTab === 'summary' && (
                                                <div>
                                                    <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:20}}>
                                                        <i className="fas fa-chart-bar" style={{color:'#667eea',fontSize:20}}></i>
                                                        <h5 style={{margin:0,color:'#667eea',fontSize:18}}>Общие показатели</h5>
                                                    </div>
                                                    
                                                    {/* Основные карточки */}
                                                    <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(280px, 1fr))',gap:16,marginBottom:24}}>
                                                        <div style={{background:'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',padding:20,borderRadius:12,color:'white',boxShadow:'0 4px 15px rgba(102, 126, 234, 0.3)'}}>
                                                            <div style={{display:'flex',alignItems:'center',gap:12,marginBottom:8}}>
                                                                <i className="fas fa-calendar-check" style={{fontSize:24}}></i>
                                                                <div>
                                                                    <div style={{fontSize:28,fontWeight:700}}>{profile.basic_stats.total_shifts}</div>
                                                                    <div style={{fontSize:14,opacity:0.9}}>Всего смен</div>
                                                                </div>
                                                            </div>
                                                            <div style={{fontSize:12,opacity:0.8}}>За {profile.basic_stats.total_days} дней</div>
                                                        </div>
                                                        
                                                        <div style={{background:'linear-gradient(135deg, #00b894 0%, #00a085 100%)',padding:20,borderRadius:12,color:'white',boxShadow:'0 4px 15px rgba(0, 184, 148, 0.3)'}}>
                                                            <div style={{display:'flex',alignItems:'center',gap:12,marginBottom:8}}>
                                                                <i className="fas fa-coins" style={{fontSize:24}}></i>
                                                                <div>
                                                                    <div style={{fontSize:28,fontWeight:700}}>{profile.basic_stats.net_profit >= 0 ? '+' : ''}{profile.basic_stats.net_profit}</div>
                                                                    <div style={{fontSize:14,opacity:0.9}}>Прибыль (USDT)</div>
                                                                </div>
                                                            </div>
                                                            <div style={{fontSize:12,opacity:0.8}}>Зарплата: {profile.basic_stats.salary} USDT</div>
                                                        </div>
                                                        
                                                        <div style={{background:'linear-gradient(135deg, #3742fa 0%, #2f3542 100%)',padding:20,borderRadius:12,color:'white',boxShadow:'0 4px 15px rgba(55, 66, 250, 0.3)'}}>
                                                            <div style={{display:'flex',alignItems:'center',gap:12,marginBottom:8}}>
                                                                <i className="fas fa-tasks" style={{fontSize:24}}></i>
                                                                <div>
                                                                    <div style={{fontSize:28,fontWeight:700}}>{profile.basic_stats.total_requests}</div>
                                                                    <div style={{fontSize:14,opacity:0.9}}>Всего заявок</div>
                                                                </div>
                                                            </div>
                                                            <div style={{fontSize:12,opacity:0.8}}>Среднее: {profile.basic_stats.avg_requests_per_day}/день</div>
                                                        </div>
                                                    </div>
                                                    
                                                    {/* Разбивка по платформам */}
                                                    <div style={{marginBottom:24}}>
                                                        <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:16}}>
                                                            <i className="fas fa-exchange-alt" style={{color:'#667eea',fontSize:16}}></i>
                                                            <h6 style={{margin:0,color:'#667eea',fontSize:16}}>Заявки по платформам</h6>
                                                        </div>
                                                        <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(180px, 1fr))',gap:12}}>
                                                            <div style={{background:'#fff8e1',padding:16,borderRadius:10,border:'1px solid #ffeaa7',boxShadow:'0 2px 8px rgba(255, 165, 0, 0.1)'}}>
                                                                <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:8}}>
                                                                    <i className="fas fa-chart-line" style={{color:'#ffa500'}}></i>
                                                                    <span style={{fontWeight:600}}>Bybit</span>
                                                                </div>
                                                                <div style={{fontSize:24,fontWeight:700,color:'#ffa500'}}>{profile.basic_stats.total_bybit}</div>
                                                                <div style={{fontSize:12,color:'#666'}}>заявок</div>
                                                            </div>
                                                            
                                                            <div style={{background:'#e8f5e8',padding:16,borderRadius:10,border:'1px solid #c8e6c9',boxShadow:'0 2px 8px rgba(0, 212, 170, 0.1)'}}>
                                                                <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:8}}>
                                                                    <i className="fas fa-chart-line" style={{color:'#00d4aa'}}></i>
                                                                    <span style={{fontWeight:600}}>HTX</span>
                                                                </div>
                                                                <div style={{fontSize:24,fontWeight:700,color:'#00d4aa'}}>{profile.basic_stats.total_htx}</div>
                                                                <div style={{fontSize:12,color:'#666'}}>заявок</div>
                                                            </div>
                                                            
                                                            <div style={{background:'#ffe8e8',padding:16,borderRadius:10,border:'1px solid #ffb8b8',boxShadow:'0 2px 8px rgba(255, 107, 107, 0.1)'}}>
                                                                <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:8}}>
                                                                    <i className="fas fa-chart-line" style={{color:'#ff6b6b'}}></i>
                                                                    <span style={{fontWeight:600}}>Bliss</span>
                                                                </div>
                                                                <div style={{fontSize:24,fontWeight:700,color:'#ff6b6b'}}>{profile.basic_stats.total_bliss}</div>
                                                                <div style={{fontSize:12,color:'#666'}}>заявок</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    {/* Дополнительные показатели */}
                                                    <div>
                                                        <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:16}}>
                                                            <i className="fas fa-info-circle" style={{color:'#667eea',fontSize:16}}></i>
                                                            <h6 style={{margin:0,color:'#667eea',fontSize:16}}>Дополнительные показатели</h6>
                                                        </div>
                                                        <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(200px, 1fr))',gap:12}}>
                                                            <div style={{background:'#fff5f5',padding:16,borderRadius:10,border:'1px solid #fed7d7',boxShadow:'0 2px 8px rgba(231, 76, 60, 0.1)'}}>
                                                                <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:8}}>
                                                                    <i className="fas fa-skull-crossbones" style={{color:'#e74c3c'}}></i>
                                                                    <span style={{fontWeight:600}}>Скам</span>
                                                                </div>
                                                                <div style={{fontSize:20,fontWeight:700,color:'#e74c3c'}}>{profile.basic_stats.total_scam} USDT</div>
                                                            </div>
                                                            
                                                            <div style={{background:'#fff8e1',padding:16,borderRadius:10,border:'1px solid #ffecb3',boxShadow:'0 2px 8px rgba(247, 183, 49, 0.1)'}}>
                                                                <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:8}}>
                                                                    <i className="fas fa-exchange-alt" style={{color:'#f7b731'}}></i>
                                                                    <span style={{fontWeight:600}}>Переводы</span>
                                                                </div>
                                                                <div style={{fontSize:20,fontWeight:700,color:'#f7b731'}}>{profile.basic_stats.total_transfer} USDT</div>
                                                            </div>
                                                            
                                                            <div style={{background:'#e8f5e8',padding:16,borderRadius:10,border:'1px solid #c8e6c9',boxShadow:'0 2px 8px rgba(60, 120, 216, 0.1)'}}>
                                                                <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:8}}>
                                                                    <i className="fas fa-chart-line" style={{color:'#3c78d8'}}></i>
                                                                    <span style={{fontWeight:600}}>Сред./смену</span>
                                                                </div>
                                                                <div style={{fontSize:20,fontWeight:700,color:'#3c78d8'}}>{profile.basic_stats.avg_profit_per_shift} USDT</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            )}
                                            
                                            {activeTab === 'reports' && (
                                                <div>
                                                    <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:20}}>
                                                        <i className="fas fa-calendar-alt" style={{color:'#667eea',fontSize:20}}></i>
                                                        <h5 style={{margin:0,color:'#667eea',fontSize:18}}>История смен</h5>
                                                    </div>
                                                    <div style={{overflowX:'auto',borderRadius:12,border:'1px solid #e0e0e0'}}>
                                                        <table className="table" style={{minWidth:800,margin:0}}>
                                                            <thead style={{background:'linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)'}}>
                                                                <tr>
                                                                    <th style={{padding:'12px 16px',borderBottom:'2px solid #e0e0e0',fontWeight:600,color:'#495057'}}>Дата</th>
                                                                    <th style={{padding:'12px 16px',borderBottom:'2px solid #e0e0e0',fontWeight:600,color:'#495057'}}>Смена</th>
                                                                    <th style={{padding:'12px 16px',borderBottom:'2px solid #e0e0e0',fontWeight:600,color:'#495057'}}>Заявки</th>
                                                                    <th style={{padding:'12px 16px',borderBottom:'2px solid #e0e0e0',fontWeight:600,color:'#495057'}}>Прибыль проекта</th>
                                                                    <th style={{padding:'12px 16px',borderBottom:'2px solid #e0e0e0',fontWeight:600,color:'#495057'}}>Прибыль сотрудника</th>
                                                                    <th style={{padding:'12px 16px',borderBottom:'2px solid #e0e0e0',fontWeight:600,color:'#495057'}}>Скам</th>
                                                                    <th style={{padding:'12px 16px',borderBottom:'2px solid #e0e0e0',fontWeight:600,color:'#495057'}}>Переводы</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                {profile.report_details.map((report, index) => (
                                                                    <tr key={report.id} style={{backgroundColor: index % 2 === 0 ? '#ffffff' : '#f8f9fa'}}>
                                                                        <td style={{padding:'12px 16px',borderBottom:'1px solid #e0e0e0'}}>
                                                    {report.shift_start_date && report.shift_end_date && report.shift_start_date !== report.shift_end_date ? (
                                                        <div>
                                                            <div style={{fontWeight:600}}>
                                                                {new Date(report.shift_start_date).toLocaleDateString()} - {new Date(report.shift_end_date).toLocaleDateString()}
                                                            </div>
                                                            <div style={{fontSize:'0.8em',color:'#666'}}>
                                                                Диапазон дат
                                                            </div>
                                                        </div>
                                                    ) : (
                                                        <div>{new Date(report.date).toLocaleDateString()}</div>
                                                    )}
                                                </td>
                                                                        <td style={{padding:'12px 16px',borderBottom:'1px solid #e0e0e0'}}>
                                                                            <span style={{
                                                                                padding:'4px 8px',
                                                                                borderRadius:6,
                                                                                fontSize:12,
                                                                                fontWeight:600,
                                                                                background: report.shift_type === 'morning' ? '#fff3cd' : '#d1ecf1',
                                                                                color: report.shift_type === 'morning' ? '#856404' : '#0c5460'
                                                                            }}>
                                                                                {report.shift_type === 'morning' ? 'Утренняя' : 'Вечерняя'}
                                                                            </span>
                                                                        </td>
                                                                        <td style={{padding:'12px 16px',borderBottom:'1px solid #e0e0e0',fontWeight:600}}>{report.total_requests}</td>
                                                                        <td style={{padding:'12px 16px',borderBottom:'1px solid #e0e0e0',color: report.project_profit >= 0 ? '#27ae60' : '#e74c3c', fontWeight: 600}}>
                                                                            {report.project_profit >= 0 ? '+' : ''}{report.project_profit} USDT
                                                                        </td>
                                                                        <td style={{padding:'12px 16px',borderBottom:'1px solid #e0e0e0',color: report.salary_profit >= 0 ? '#27ae60' : '#e74c3c', fontWeight: 600}}>
                                                                            {report.salary_profit >= 0 ? '+' : ''}{report.salary_profit} USDT
                                                                        </td>
                                                                        <td style={{padding:'12px 16px',borderBottom:'1px solid #e0e0e0',color: '#e74c3c',fontWeight:600}}>{report.scam_amount} USDT</td>
                                                                        <td style={{padding:'12px 16px',borderBottom:'1px solid #e0e0e0',color: '#f7b731',fontWeight:600}}>{report.dokidka_amount} USDT</td>
                                                                    </tr>
                                                                ))}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            )}
                                            
                                            {activeTab === 'scams' && (
                                                <div>
                                                    <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:20}}>
                                                        <i className="fas fa-skull-crossbones" style={{color:'#e74c3c',fontSize:20}}></i>
                                                        <h5 style={{margin:0,color:'#e74c3c',fontSize:18}}>История скамов</h5>
                                                    </div>
                                                    
                                                    {/* Загружаем историю скамов */}
                                                    {(() => {
                                                        const [scams, setScams] = React.useState(null);
                                                        
                                                        React.useEffect(() => {
                                                            fetch(`/api/employee-scams/${employeeId}`)
                                                                .then(response => response.json())
                                                                .then(data => {
                                                                    if (!data.error) {
                                                                        setScams(data);
                                                                    }
                                                                });
                                                        }, [employeeId]);
                                                        
                                                        if (!scams) return <div>Загрузка истории скамов...</div>;
                                                        if (!scams.scams.length) return <div>Нет записей о скамах</div>;
                                                        
                                                        return (
                                                            <>
                                                                <div style={{background:'#fff5f5',padding:16,borderRadius:10,marginBottom:20,border:'1px solid #fed7d7',boxShadow:'0 2px 8px rgba(231, 76, 60, 0.1)'}}>
                                                                    <div style={{fontSize:20,fontWeight:700,color:'#e74c3c',marginBottom:4}}>
                                                                        Общая сумма скамов: {scams.total_amount} USDT
                                                                    </div>
                                                                    <div style={{fontSize:14,color:'#666'}}>
                                                                        Всего случаев: {scams.scams.length}
                                                                    </div>
                                                                </div>
                                                                
                                                                <div style={{overflowX:'auto',borderRadius:12,border:'1px solid #e0e0e0'}}>
                                                                    <table className="table" style={{minWidth:800,margin:0}}>
                                                                        <thead style={{background:'linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)'}}>
                                                                            <tr>
                                                                                <th style={{padding:'12px 16px',borderBottom:'2px solid #e0e0e0',fontWeight:600,color:'#495057'}}>Дата</th>
                                                                                <th style={{padding:'12px 16px',borderBottom:'2px solid #e0e0e0',fontWeight:600,color:'#495057'}}>Сумма</th>
                                                                                <th style={{padding:'12px 16px',borderBottom:'2px solid #e0e0e0',fontWeight:600,color:'#495057'}}>Комментарий</th>
                                                                            </tr>
                                                                        </thead>
                                                                        <tbody>
                                                                            {scams.scams.map((scam, index) => (
                                                                                <tr key={scam.id} style={{backgroundColor: index % 2 === 0 ? '#ffffff' : '#fff5f5'}}>
                                                                                    <td style={{padding:'12px 16px',borderBottom:'1px solid #e0e0e0'}}>{scam.date}</td>
                                                                                    <td style={{padding:'12px 16px',borderBottom:'1px solid #e0e0e0',color:'#e74c3c',fontWeight:600}}>{scam.amount} USDT</td>
                                                                                    <td style={{padding:'12px 16px',borderBottom:'1px solid #e0e0e0'}}>{scam.comment}</td>
                                                                                </tr>
                                                                            ))}
                                                                        </tbody>
                                                                    </table>
                                                                </div>
                                                            </>
                                                        );
                                                    })()}
                                                </div>
                                            )}
                                            
                                            {activeTab === 'orders' && (
                                                <div>
                                                    <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:20}}>
                                                        <i className="fas fa-exchange-alt" style={{color:'#667eea',fontSize:20}}></i>
                                                        <h5 style={{margin:0,color:'#667eea',fontSize:18}}>Статистика ордеров</h5>
                                                    </div>
                                                    
                                                    {/* Основные показатели ордеров - как в истории ордеров */}
                                                    <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:16,marginBottom:24}}>
                                                        {/* Продажи */}
                                                        <div style={{background:'linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%)',padding:20,borderRadius:12,color:'white',boxShadow:'0 4px 15px rgba(255, 107, 107, 0.3)'}}>
                                                            <div style={{display:'flex',alignItems:'center',gap:12,marginBottom:12}}>
                                                                <i className="fas fa-chart-line" style={{fontSize:20}}></i>
                                                                <div style={{fontSize:16,fontWeight:600}}>ПРОДАЖИ</div>
                                                            </div>
                                                            <div style={{fontSize:20,fontWeight:700,marginBottom:4}}>
                                                                {profile.order_stats.sell_volume.toFixed(2)} RUB
                                                            </div>
                                                            <div style={{fontSize:16,opacity:0.9}}>
                                                                {profile.order_stats.sell_volume_usdt.toFixed(2)} USDT
                                                            </div>
                                                        </div>
                                                        
                                                        {/* Прибыль */}
                                                        <div style={{background:`linear-gradient(135deg, ${profile.order_stats.profit_usdt >= 0 ? '#2ed573' : '#ff6b6b'} 0%, ${profile.order_stats.profit_usdt >= 0 ? '#7bed9f' : '#ee5a52'} 100%)`,padding:20,borderRadius:12,color:'white',boxShadow:`0 4px 15px rgba(${profile.order_stats.profit_usdt >= 0 ? '46, 213, 115' : '255, 107, 107'}, 0.3)`}}>
                                                            <div style={{display:'flex',alignItems:'center',gap:12,marginBottom:12}}>
                                                                <i className="fas fa-coins" style={{fontSize:20}}></i>
                                                                <div style={{fontSize:16,fontWeight:600}}>ПРИБЫЛЬ</div>
                                                            </div>
                                                            <div style={{fontSize:24,fontWeight:700,marginBottom:4}}>
                                                                {profile.order_stats.profit_usdt >= 0 ? '+' : ''}{profile.order_stats.profit_usdt.toFixed(2)} USDT
                                                            </div>
                                                            <div style={{fontSize:14,opacity:0.9}}>
                                                                Покупки - Продажи
                                                            </div>
                                                        </div>
                                                        
                                                        {/* Покупки */}
                                                        <div style={{background:'linear-gradient(135deg, #2ed573 0%, #7bed9f 100%)',padding:20,borderRadius:12,color:'white',boxShadow:'0 4px 15px rgba(46, 213, 115, 0.3)'}}>
                                                            <div style={{display:'flex',alignItems:'center',gap:12,marginBottom:12}}>
                                                                <i className="fas fa-shopping-cart" style={{fontSize:20}}></i>
                                                                <div style={{fontSize:16,fontWeight:600}}>ПОКУПКИ</div>
                                                            </div>
                                                            <div style={{fontSize:20,fontWeight:700,marginBottom:4}}>
                                                                {profile.order_stats.buy_volume.toFixed(2)} RUB
                                                            </div>
                                                            <div style={{fontSize:16,opacity:0.9}}>
                                                                {profile.order_stats.buy_volume_usdt.toFixed(2)} USDT
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    {/* Дополнительные показатели */}
                                                    <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(200px, 1fr))',gap:16,marginBottom:24}}>
                                                        <div style={{background:'linear-gradient(135deg, #3742fa 0%, #2f3542 100%)',padding:20,borderRadius:12,color:'white',boxShadow:'0 4px 15px rgba(55, 66, 250, 0.3)'}}>
                                                            <div style={{display:'flex',alignItems:'center',gap:12,marginBottom:8}}>
                                                                <i className="fas fa-list" style={{fontSize:20}}></i>
                                                                <div>
                                                                    <div style={{fontSize:24,fontWeight:700}}>{profile.order_stats.total_orders}</div>
                                                                    <div style={{fontSize:14,opacity:0.9}}>Всего ордеров</div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        
                                                        <div style={{background:'linear-gradient(135deg, #70a1ff 0%, #5352ed 100%)',padding:20,borderRadius:12,color:'white',boxShadow:'0 4px 15px rgba(112, 161, 255, 0.3)'}}>
                                                            <div style={{display:'flex',alignItems:'center',gap:12,marginBottom:8}}>
                                                                <i className="fas fa-chart-bar" style={{fontSize:20}}></i>
                                                                <div>
                                                                    <div style={{fontSize:24,fontWeight:700}}>{profile.order_stats.avg_buy_rate.toFixed(2)}</div>
                                                                    <div style={{fontSize:14,opacity:0.9}}>Средний курс покупки</div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        
                                                        <div style={{background:'linear-gradient(135deg, #ff9ff3 0%, #f368e0 100%)',padding:20,borderRadius:12,color:'white',boxShadow:'0 4px 15px rgba(255, 159, 243, 0.3)'}}>
                                                            <div style={{display:'flex',alignItems:'center',gap:12,marginBottom:8}}>
                                                                <i className="fas fa-chart-line" style={{fontSize:20}}></i>
                                                                <div>
                                                                    <div style={{fontSize:24,fontWeight:700}}>{profile.order_stats.avg_sell_rate.toFixed(2)}</div>
                                                                    <div style={{fontSize:14,opacity:0.9}}>Средний курс продажи</div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    {/* Разбивка по платформам */}
                                                    <div style={{marginBottom:24}}>
                                                        <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:16}}>
                                                            <i className="fas fa-chart-line" style={{color:'#667eea',fontSize:16}}></i>
                                                            <h6 style={{margin:0,color:'#667eea',fontSize:16}}>По платформам</h6>
                                                        </div>
                                                        <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(150px, 1fr))',gap:12}}>
                                                            {Object.entries(profile.order_stats.platform_statistics).map(([platform, count]) => (
                                                                <div key={platform} style={{background:'#f8f9fa',padding:16,borderRadius:10,border:'1px solid #e0e0e0',boxShadow:'0 2px 8px rgba(0, 0, 0, 0.1)'}}>
                                                                    <div style={{fontWeight:600,textTransform:'uppercase',fontSize:14,color:'#667eea'}}>{platform}</div>
                                                                    <div style={{fontSize:20,fontWeight:700,color:'#3742fa'}}>{count}</div>
                                                                    <div style={{fontSize:12,color:'#666'}}>ордеров</div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                    
                                                    {/* Разбивка по статусам */}
                                                    <div>
                                                        <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:16}}>
                                                            <i className="fas fa-info-circle" style={{color:'#667eea',fontSize:16}}></i>
                                                            <h6 style={{margin:0,color:'#667eea',fontSize:16}}>По статусам</h6>
                                                        </div>
                                                        <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(120px, 1fr))',gap:12}}>
                                                            {Object.entries(profile.order_stats.status_statistics).map(([status, count]) => (
                                                                <div key={status} style={{background:'#f8f9fa',padding:16,borderRadius:10,border:'1px solid #e0e0e0',boxShadow:'0 2px 8px rgba(0, 0, 0, 0.1)'}}>
                                                                    <div style={{fontWeight:600,textTransform:'capitalize',fontSize:14,color:'#667eea'}}>{status}</div>
                                                                    <div style={{fontSize:20,fontWeight:700,color:'#3742fa'}}>{count}</div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                </div>
                                            )}
                                            
                                            {activeTab === 'performance' && (
                                                <div>
                                                    <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:20}}>
                                                        <i className="fas fa-trophy" style={{color:'#667eea',fontSize:20}}></i>
                                                        <h5 style={{margin:0,color:'#667eea',fontSize:18}}>Производительность</h5>
                                                    </div>
                                                    
                                                    {/* Лучшие показатели */}
                                                    <div style={{marginBottom:24}}>
                                                        <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:16}}>
                                                            <i className="fas fa-medal" style={{color:'#667eea',fontSize:16}}></i>
                                                            <h6 style={{margin:0,color:'#667eea',fontSize:16}}>Лучшие достижения</h6>
                                                        </div>
                                                        <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(280px, 1fr))',gap:16}}>
                                                            <div style={{background:'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',padding:20,borderRadius:12,color:'white',boxShadow:'0 4px 15px rgba(240, 147, 251, 0.3)'}}>
                                                                <div style={{display:'flex',alignItems:'center',gap:12,marginBottom:8}}>
                                                                    <i className="fas fa-trophy" style={{fontSize:24}}></i>
                                                                    <div>
                                                                        <div style={{fontSize:24,fontWeight:700}}>+{(profile.best_worst.best_profit?.amount || 0).toFixed(2)} USDT</div>
                                                                        <div style={{fontSize:14,opacity:0.9}}>Лучшая прибыль</div>
                                                                    </div>
                                                                </div>
                                                                <div style={{fontSize:12,opacity:0.8}}>
                                                                    {profile.best_worst.best_profit?.date} ({profile.best_worst.best_profit?.shift_type === 'morning' ? 'утро' : 'вечер'})
                                                                </div>
                                                            </div>
                                                            
                                                            <div style={{background:'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',padding:20,borderRadius:12,color:'white',boxShadow:'0 4px 15px rgba(250, 112, 154, 0.3)'}}>
                                                                <div style={{display:'flex',alignItems:'center',gap:12,marginBottom:8}}>
                                                                    <i className="fas fa-chart-line" style={{fontSize:24}}></i>
                                                                    <div>
                                                                        <div style={{fontSize:24,fontWeight:700}}>{profile.best_worst.most_requests?.count || 0}</div>
                                                                        <div style={{fontSize:14,opacity:0.9}}>Макс. заявок</div>
                                                                    </div>
                                                                </div>
                                                                <div style={{fontSize:12,opacity:0.8}}>
                                                                    {profile.best_worst.most_requests?.date}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    {/* Средние показатели */}
                                                    <div>
                                                        <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:16}}>
                                                            <i className="fas fa-chart-bar" style={{color:'#667eea',fontSize:16}}></i>
                                                            <h6 style={{margin:0,color:'#667eea',fontSize:16}}>Средние показатели</h6>
                                                        </div>
                                                        <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(200px, 1fr))',gap:16}}>
                                                            {profile.avg_stats && Object.entries(profile.avg_stats).map(([key, value]) => (
                                                                <div key={key} style={{background:'#f8f9fa',padding:16,borderRadius:10,border:'1px solid #e0e0e0',boxShadow:'0 2px 8px rgba(0, 0, 0, 0.1)'}}>
                                                                    <div style={{fontSize:20,fontWeight:700,color:'#3742fa'}}>{value.toFixed(2)}</div>
                                                                    <div style={{fontSize:14,color:'#666'}}>
                                                                        {key === 'avg_requests_per_shift' ? 'Заявок/смену' :
                                                                         key === 'avg_profit_per_shift' ? 'Прибыль/смену' :
                                                                         key === 'avg_bybit_per_shift' ? 'Bybit/смену' :
                                                                         key === 'avg_htx_per_shift' ? 'HTX/смену' :
                                                                         key === 'avg_bliss_per_shift' ? 'Bliss/смену' : key}
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                </div>
                                            )}
                                            
                                            {activeTab === 'analytics' && (
                                                <div>
                                                    <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:20}}>
                                                        <i className="fas fa-chart-line" style={{color:'#667eea',fontSize:20}}></i>
                                                        <h5 style={{margin:0,color:'#667eea',fontSize:18}}>Аналитика</h5>
                                                    </div>
                                                    
                                                    {/* Временная статистика */}
                                                    <div style={{marginBottom:24}}>
                                                        <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:16}}>
                                                            <i className="fas fa-clock" style={{color:'#667eea',fontSize:16}}></i>
                                                            <h6 style={{margin:0,color:'#667eea',fontSize:16}}>Временная активность</h6>
                                                        </div>
                                                        <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(200px, 1fr))',gap:16}}>
                                                            {profile.time_stats && Object.entries(profile.time_stats).map(([key, value]) => (
                                                                <div key={key} style={{background:'#f8f9fa',padding:16,borderRadius:10,border:'1px solid #e0e0e0',boxShadow:'0 2px 8px rgba(0, 0, 0, 0.1)'}}>
                                                                    <div style={{fontSize:20,fontWeight:700,color:'#3742fa'}}>
                                                                        {key === 'activity_ratio' ? (value * 100).toFixed(1) + '%' : value}
                                                                    </div>
                                                                    <div style={{fontSize:14,color:'#666'}}>
                                                                        {key === 'first_report_date' ? 'Первый отчет' :
                                                                         key === 'last_report_date' ? 'Последний отчет' :
                                                                         key === 'total_period_days' ? 'Дней в периоде' :
                                                                         key === 'active_days' ? 'Активных дней' :
                                                                         key === 'activity_ratio' ? 'Коэф. активности' : key}
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                    
                                                    {/* Статистика по сменам */}
                                                    <div style={{marginBottom:24}}>
                                                        <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:16}}>
                                                            <i className="fas fa-clock" style={{color:'#667eea',fontSize:16}}></i>
                                                            <h6 style={{margin:0,color:'#667eea',fontSize:16}}>По типам смен</h6>
                                                        </div>
                                                        <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(220px, 1fr))',gap:16}}>
                                                            <div style={{background:'linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%)',padding:20,borderRadius:12,border:'1px solid #ffeaa7',boxShadow:'0 4px 15px rgba(243, 156, 18, 0.2)'}}>
                                                                <div style={{display:'flex',alignItems:'center',gap:12,marginBottom:8}}>
                                                                    <i className="fas fa-sun" style={{fontSize:24,color:'#f39c12'}}></i>
                                                                    <div>
                                                                        <div style={{fontSize:24,fontWeight:700,color:'#f39c12'}}>{profile.shift_stats.morning_shifts}</div>
                                                                        <div style={{fontSize:14,color:'#856404'}}>Утренних смен</div>
                                                                    </div>
                                                                </div>
                                                                <div style={{fontSize:12,color:'#856404'}}>
                                                                    Прибыль: {profile.shift_stats.morning_profit.toFixed(2)} USDT
                                                                </div>
                                                            </div>
                                                            
                                                            <div style={{background:'linear-gradient(135deg, #d1ecf1 0%, #74b9ff 100%)',padding:20,borderRadius:12,border:'1px solid #74b9ff',boxShadow:'0 4px 15px rgba(116, 185, 255, 0.2)'}}>
                                                                <div style={{display:'flex',alignItems:'center',gap:12,marginBottom:8}}>
                                                                    <i className="fas fa-moon" style={{fontSize:24,color:'#0984e3'}}></i>
                                                                    <div>
                                                                        <div style={{fontSize:24,fontWeight:700,color:'#0984e3'}}>{profile.shift_stats.evening_shifts}</div>
                                                                        <div style={{fontSize:14,color:'#0c5460'}}>Вечерних смен</div>
                                                                    </div>
                                                                </div>
                                                                <div style={{fontSize:12,color:'#0c5460'}}>
                                                                    Прибыль: {profile.shift_stats.evening_profit.toFixed(2)} USDT
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    {/* Прибыль по платформам */}
                                                    <div>
                                                        <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:16}}>
                                                            <i className="fas fa-chart-pie" style={{color:'#667eea',fontSize:16}}></i>
                                                            <h6 style={{margin:0,color:'#667eea',fontSize:16}}>Прибыль по платформам</h6>
                                                        </div>
                                                        <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(150px, 1fr))',gap:12}}>
                                                            {Object.entries(profile.platform_profits).map(([platform, profit]) => (
                                                                <div key={platform} style={{background:'#f8f9fa',padding:16,borderRadius:10,border:'1px solid #e0e0e0',boxShadow:'0 2px 8px rgba(0, 0, 0, 0.1)'}}>
                                                                    <div style={{fontWeight:600,textTransform:'uppercase',fontSize:14,color:'#667eea'}}>{platform}</div>
                                                                    <div style={{fontSize:18,fontWeight:700,color: profit >= 0 ? '#27ae60' : '#e74c3c'}}>
                                                                        {profit >= 0 ? '+' : ''}{profit.toFixed(2)} USDT
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    </>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // --- UI-раздел для истории балансов ---
        function AccountBalanceHistoryViewer({ accounts, employees }) {
            const [history, setHistory] = React.useState([]);
            const [filters, setFilters] = React.useState({ account_id: '', platform: '', employee_id: '', date_from: '', date_to: '', department: '' });
            const [page, setPage] = React.useState(1);
            const rowsPerPage = 20;
            React.useEffect(() => {
                let url = '/api/account-balance-history?';
                if (filters.account_id) url += `account_id=${filters.account_id}&`;
                if (filters.platform) url += `platform=${filters.platform}&`;
                if (filters.employee_id) url += `employee_id=${filters.employee_id}&`;
                if (filters.date_from) url += `start_date=${filters.date_from}&`;
                if (filters.date_to) url += `end_date=${filters.date_to}`;
                if (filters.department) url += `department=${filters.department}&`;
                fetch(url).then(r => r.json()).then(data => { 
                    setHistory(data); 
                    setPage(1); 
                });
            }, [filters]);
            const filtered = history.filter(h =>
                (!filters.account_id || String(h.account_id) === String(filters.account_id)) &&
                (!filters.platform || h.platform === filters.platform) &&
                (!filters.employee_id || String(h.employee_id) === String(filters.employee_id)) &&
                (!filters.date_from || h.shift_date >= filters.date_from) &&
                (!filters.date_to || h.shift_date <= filters.date_to) &&
                (!filters.department || h.department === filters.department)
            );
            // Пагинация
            const totalPages = Math.ceil(filtered.length / rowsPerPage) || 1;
            const paginated = filtered.slice((page-1)*rowsPerPage, page*rowsPerPage);
            const handlePageChange = (newPage) => {
                if (newPage >= 1 && newPage <= totalPages) setPage(newPage);
            };
            return (
                <div className="card">
                    <h3><i className="fas fa-database"></i> История балансов аккаунтов</h3>
                    <div style={{display:'flex',gap:12,marginBottom:16,flexWrap:'wrap'}}>
                        <select className="form-control" value={filters.account_id} onChange={e => setFilters(f => ({...f, account_id: e.target.value}))} style={{maxWidth:180}}>
                            <option value="">Все аккаунты</option>
                            {[...new Set(history.map(h => h.account_id))].map(id => (
                                <option key={id} value={id}>{accounts.find(a => a.id == id)?.account_name || id}</option>
                            ))}
                        </select>
                        <select className="form-control" value={filters.platform} onChange={e => setFilters(f => ({...f, platform: e.target.value}))} style={{maxWidth:140}}>
                            <option value="">Все платформы</option>
                            {[...new Set(history.map(h => h.platform))].map(p => (
                                <option key={p} value={p}>{p.toUpperCase()}</option>
                            ))}
                        </select>
                        <select className="form-control" value={filters.employee_id} onChange={e => setFilters(f => ({...f, employee_id: e.target.value}))} style={{maxWidth:180}}>
                            <option value="">Все сотрудники</option>
                            {[...new Set(history.map(h => h.employee_id))].map(id => (
                                <option key={id} value={id}>{employees.find(e => e.id == id)?.name || id}</option>
                            ))}
                        </select>
                        <select className="form-control" value={filters.department} onChange={e => setFilters(f => ({...f, department: e.target.value}))} style={{maxWidth:140}}>
                            <option value="">Все отделы</option>
                            <option value="first">Первый отдел</option>
                            <option value="second">Второй отдел</option>
                        </select>
                        <input type="date" className="form-control" value={filters.date_from} onChange={e => setFilters(f => ({...f, date_from: e.target.value}))} style={{maxWidth:160}} placeholder="С даты" />
                        <input type="date" className="form-control" value={filters.date_to} onChange={e => setFilters(f => ({...f, date_to: e.target.value}))} style={{maxWidth:160}} placeholder="По дату" />
                    </div>
                    <div style={{overflowX:'auto'}}>
                        <table className="table" style={{minWidth:900}}>
                            <thead>
                                <tr>
                                    <th>Платформа</th>
                                    <th>Название аккаунта</th>
                                    <th>Дата</th>
                                    <th>Смена</th>
                                    <th>Начальный баланс</th>
                                    <th>Конечный баланс</th>
                                    <th>Сотрудник</th>
                                </tr>
                            </thead>
                            <tbody>
                                {(() => {
                                  // Группируем по account_id, platform, shift_date, shift_type, employee_id
                                  const grouped = {};
                                  history.forEach(h => {
                                    const key = [h.account_id, h.platform, h.shift_date, h.shift_type, h.employee_id].join('|');
                                    if (!grouped[key]) {
                                        grouped[key] = { ...h, start: null, end: null };
                                    }
                                    if (h.balance_type === 'start') {
                                        grouped[key].start = h.balance;
                                    } else if (h.balance_type === 'end') {
                                        grouped[key].end = h.balance;
                                    }
                                  });
                                  return Object.values(grouped).map((h, idx) => (
                                    <tr key={idx}>
                                        <td>{h.platform.toUpperCase()}</td>
                                      <td>{h.account_name}</td>
                                        <td>{h.shift_date}</td>
                                        <td>{h.shift_type === 'morning' ? 'Утренняя' : 'Вечерняя'}</td>
                                      <td>{h.start !== null && h.start !== undefined ? h.start : '—'}</td>
                                      <td>{h.end !== null && h.end !== undefined ? h.end : '—'}</td>
                                      <td>{h.employee_name || h.employee_id}</td>
                                    </tr>
                                  ));
                                })()}
                            </tbody>
                        </table>
                    </div>
                    {/* Пагинация */}
                    <div style={{display:'flex',justifyContent:'center',alignItems:'center',gap:8,marginTop:18}}>
                        <button className="btn btn-secondary" onClick={() => handlePageChange(page-1)} disabled={page<=1}>Назад</button>
                        <span style={{fontWeight:600}}>{page} / {totalPages}</span>
                        <button className="btn btn-secondary" onClick={() => handlePageChange(page+1)} disabled={page>=totalPages}>Вперёд</button>
                    </div>
                </div>
            );
        }

        // --- Компонент для загрузки файлов с ордерами ---
        function OrderUploadModal({ employees, onClose, onSuccess }) {
            const [formData, setFormData] = React.useState({
                employee_id: '',
                platform: '',
                account_name: '',
                file: null,
                start_date: '',
                end_date: '',
                department: ''
            });
            const [uploading, setUploading] = React.useState(false);
            const [error, setError] = React.useState('');
            const [success, setSuccess] = React.useState('');
            const [accounts, setAccounts] = React.useState([]);

            // Загружаем список аккаунтов
            React.useEffect(() => {
                fetch('/api/accounts')
                    .then(r => r.json())
                    .then(setAccounts)
                    .catch(() => setAccounts([]));
            }, []);

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    // Проверяем тип файла
                    const allowedTypes = [
                        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', // .xlsx
                        'application/vnd.ms-excel', // .xls
                        'text/csv' // .csv
                    ];
                    
                    if (!allowedTypes.includes(file.type) && !file.name.match(/\.(xlsx|xls|csv)$/i)) {
                        setError('Поддерживаются только файлы Excel (.xlsx, .xls) и CSV');
                        return;
                    }
                    
                    setFormData(prev => ({...prev, file}));
                    setError('');
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                
                if (!formData.employee_id || !formData.platform || !formData.account_name || !formData.file || !formData.department) {
                    setError('Заполните все поля и выберите файл');
                    return;
                }
                
                if (filteredAccounts.length === 0) {
                    setError('Для выбранной платформы нет доступных аккаунтов');
                    return;
                }

                setUploading(true);
                setError('');
                setSuccess('');

                try {
                    const formDataToSend = new FormData();
                    formDataToSend.append('employee_id', formData.employee_id);
                    formDataToSend.append('platform', formData.platform);
                    formDataToSend.append('account_name', formData.account_name);
                    formDataToSend.append('file', formData.file);
                    formDataToSend.append('department', formData.department);
                    
                    // Добавляем параметры фильтрации по времени
                    if (formData.start_date) {
                        formDataToSend.append('start_date', formData.start_date);
                    }
                    if (formData.end_date) {
                        formDataToSend.append('end_date', formData.end_date);
                    }

                    const response = await fetch('/api/orders/upload', {
                        method: 'POST',
                        body: formDataToSend
                    });

                    const result = await response.json();

                    if (response.ok) {
                        setSuccess(`Успешно загружено ${result.count} ордеров`);
                        setTimeout(() => {
                            onSuccess();
                        }, 2000);
                    } else {
                        setError(result.error || 'Ошибка загрузки файла');
                    }
                } catch (err) {
                    setError('Ошибка соединения с сервером');
                } finally {
                    setUploading(false);
                }
            };

            const filteredAccounts = accounts.filter(acc => 
                acc.platform === formData.platform
            );

            return (
                <div style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    backgroundColor: 'rgba(0, 0, 0, 0.5)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    zIndex: 1000
                }}>
                    <div style={{
                        backgroundColor: 'white',
                        borderRadius: '15px',
                        padding: '30px',
                        maxWidth: '500px',
                        width: '90%',
                        maxHeight: '90vh',
                        overflowY: 'auto',
                        boxShadow: '0 20px 40px rgba(0, 0, 0, 0.2)'
                    }}>
                        <div style={{
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center',
                            marginBottom: '20px'
                        }}>
                            <h3 style={{margin: 0, color: '#333'}}>
                                <i className="fas fa-upload"></i> Загрузить выгрузку ордеров
                            </h3>
                            <button
                                onClick={onClose}
                                style={{
                                    background: 'none',
                                    border: 'none',
                                    fontSize: '20px',
                                    color: '#666',
                                    cursor: 'pointer'
                                }}
                            >
                                <i className="fas fa-times"></i>
                            </button>
                        </div>

                        <form onSubmit={handleSubmit}>
                            <div style={{marginBottom: '20px'}}>
                                <label style={{display: 'block', marginBottom: '5px', fontWeight: 'bold'}}>
                                    Сотрудник:
                                </label>
                                <select
                                    className="form-control"
                                    value={formData.employee_id}
                                    onChange={(e) => setFormData(prev => ({...prev, employee_id: e.target.value, account_name: ''}))}
                                    required
                                >
                                    <option value="">Выберите сотрудника</option>
                                    {employees.map(emp => (
                                        <option key={emp.id} value={emp.id}>{emp.name}</option>
                                    ))}
                                </select>
                            </div>

                            {/* --- ВЫБОР ОТДЕЛА --- */}
                            <div style={{marginBottom: '20px'}}>
                                <label style={{display: 'block', marginBottom: '8px', fontWeight: 'bold'}}>Отдел:</label>
                                <div style={{display:'flex',gap:12}}>
                                    <label style={{
                                        flex:1,
                                        padding:'10px',
                                        border:'2px solid ' + (formData.department === 'first' ? '#667eea' : '#e1e8ed'),
                                        borderRadius:'8px',
                                        cursor:'pointer',
                                        display:'flex',
                                        alignItems:'center',
                                        justifyContent:'center',
                                        gap:'8px',
                                        background: formData.department === 'first' ? '#667eea10' : '#fff'
                                    }}>
                                        <input
                                            type="radio"
                                            name="department"
                                            value="first"
                                            checked={formData.department === 'first'}
                                            onChange={e => setFormData(prev => ({...prev, department: e.target.value}))}
                                            style={{display:'none'}}
                                        />
                                        <i className="fas fa-building" style={{color: formData.department === 'first' ? '#667eea' : '#495057'}}></i>
                                        <span style={{color: formData.department === 'first' ? '#667eea' : '#495057'}}>Первый отдел</span>
                                    </label>
                                    <label style={{
                                        flex:1,
                                        padding:'10px',
                                        border:'2px solid ' + (formData.department === 'second' ? '#667eea' : '#e1e8ed'),
                                        borderRadius:'8px',
                                        cursor:'pointer',
                                        display:'flex',
                                        alignItems:'center',
                                        justifyContent:'center',
                                        gap:'8px',
                                        background: formData.department === 'second' ? '#667eea10' : '#fff'
                                    }}>
                                        <input
                                            type="radio"
                                            name="department"
                                            value="second"
                                            checked={formData.department === 'second'}
                                            onChange={e => setFormData(prev => ({...prev, department: e.target.value}))}
                                            style={{display:'none'}}
                                        />
                                        <i className="fas fa-building" style={{color: formData.department === 'second' ? '#667eea' : '#495057'}}></i>
                                        <span style={{color: formData.department === 'second' ? '#667eea' : '#495057'}}>Второй отдел</span>
                                    </label>
                                </div>
                            </div>

                            <div style={{marginBottom: '20px'}}>
                                <label style={{display: 'block', marginBottom: '5px', fontWeight: 'bold'}}>
                                    Платформа:
                                </label>
                                <select
                                    className="form-control"
                                    value={formData.platform}
                                    onChange={(e) => setFormData(prev => ({...prev, platform: e.target.value, account_name: ''}))}
                                    required
                                >
                                    <option value="">Выберите платформу</option>
                                    <option value="bybit">Bybit</option>
                                    <option value="bliss">Bliss</option>
                                    <option value="htx">HTX</option>
                                </select>
                            </div>

                            <div style={{marginBottom: '20px'}}>
                                <label style={{display: 'block', marginBottom: '5px', fontWeight: 'bold'}}>
                                    Аккаунт:
                                </label>
                                {!formData.platform ? (
                                    <div style={{
                                        padding: '10px',
                                        backgroundColor: '#f8f9fa',
                                        border: '1px solid #dee2e6',
                                        borderRadius: '4px',
                                        color: '#6c757d',
                                        fontSize: '14px'
                                    }}>
                                        <i className="fas fa-info-circle"></i> Выберите платформу.
                                    </div>
                                ) : filteredAccounts.length > 0 ? (
                                    <select
                                        className="form-control"
                                        value={formData.account_name}
                                        onChange={(e) => setFormData(prev => ({...prev, account_name: e.target.value}))}
                                        required
                                    >
                                        <option value="">Выберите аккаунт</option>
                                        {filteredAccounts.map(acc => (
                                            <option key={acc.id} value={acc.account_name}>{acc.account_name}</option>
                                        ))}
                                    </select>
                                ) : (
                                    <div style={{
                                        padding: '15px',
                                        backgroundColor: '#fff3cd',
                                        border: '1px solid #ffeaa7',
                                        borderRadius: '4px',
                                        color: '#856404'
                                    }}>
                                        <div style={{marginBottom: '10px'}}>
                                            <i className="fas fa-exclamation-triangle"></i> 
                                            <strong> Нет доступных аккаунтов</strong>
                                        </div>
                                        <div style={{fontSize: '14px', marginBottom: '10px'}}>
                                            Для выбранной платформы нет зарегистрированных аккаунтов.
                                        </div>
                                        <div style={{fontSize: '12px', color: '#6c757d'}}>
                                            Обратитесь к администратору для добавления аккаунта в разделе "Управление аккаунтами".
                                        </div>
                                    </div>
                                )}
                            </div>

                            <div style={{marginBottom: '20px'}}>
                                <label style={{display: 'block', marginBottom: '5px', fontWeight: 'bold'}}>
                                    Файл выгрузки:
                                </label>
                                <input
                                    type="file"
                                    accept=".xlsx,.xls,.csv"
                                    onChange={handleFileChange}
                                    style={{
                                        width: '100%',
                                        padding: '8px',
                                        border: '2px dashed #ddd',
                                        borderRadius: '8px',
                                        background: '#f9f9f9'
                                    }}
                                    required
                                />
                                <small style={{color: '#666', fontSize: '12px'}}>
                                    Поддерживаются файлы: .xlsx, .xls, .csv
                                </small>
                            </div>

                            <div style={{marginBottom: '20px'}}>
                                <label style={{display: 'block', marginBottom: '10px', fontWeight: 'bold'}}>
                                    <i className="fas fa-clock"></i> Временной интервал (необязательно):
                                </label>
                                <div style={{
                                    display: 'grid',
                                    gridTemplateColumns: '1fr 1fr',
                                    gap: '10px'
                                }}>
                                    <div>
                                        <label style={{display: 'block', marginBottom: '5px', fontSize: '14px', color: '#666'}}>
                                            С (дата и время):
                                        </label>
                                        <input
                                            type="datetime-local"
                                            className="form-control"
                                            value={formData.start_date}
                                            onChange={(e) => setFormData(prev => ({...prev, start_date: e.target.value}))}
                                            style={{fontSize: '14px'}}
                                        />
                                    </div>
                                    <div>
                                        <label style={{display: 'block', marginBottom: '5px', fontSize: '14px', color: '#666'}}>
                                            По (дата и время):
                                        </label>
                                        <input
                                            type="datetime-local"
                                            className="form-control"
                                            value={formData.end_date}
                                            onChange={(e) => setFormData(prev => ({...prev, end_date: e.target.value}))}
                                            style={{fontSize: '14px'}}
                                        />
                                    </div>
                                </div>
                                <div style={{
                                    fontSize: '12px',
                                    color: '#666',
                                    marginTop: '5px'
                                }}>
                                    Если не указано, будут загружены все ордера из файла
                                </div>
                            </div>

                            {error && (
                                <div style={{
                                    color: '#e74c3c',
                                    background: '#fdf2f2',
                                    padding: '10px',
                                    borderRadius: '5px',
                                    marginBottom: '15px'
                                }}>
                                    <i className="fas fa-exclamation-circle"></i> {error}
                                </div>
                            )}

                            {success && (
                                <div style={{
                                    color: '#27ae60',
                                    background: '#f0f9f0',
                                    padding: '10px',
                                    borderRadius: '5px',
                                    marginBottom: '15px'
                                }}>
                                    <i className="fas fa-check-circle"></i> {success}
                                </div>
                            )}

                            <div style={{display: 'flex', gap: '10px', justifyContent: 'flex-end'}}>
                                <button
                                    type="button"
                                    onClick={onClose}
                                    className="btn btn-secondary"
                                    disabled={uploading}
                                >
                                    Отмена
                                </button>
                                <button
                                    type="submit"
                                    className="btn btn-primary"
                                    disabled={uploading || !formData.employee_id || !formData.platform || filteredAccounts.length === 0 || !formData.account_name || !formData.file}
                                >
                                    {uploading ? (
                                        <>
                                            <i className="fas fa-spinner fa-spin"></i> Загрузка...
                                        </>
                                    ) : (
                                        <>
                                            <i className="fas fa-upload"></i> Загрузить
                                        </>
                                    )}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // --- Компонент для добавления ордера вручную ---
        function AddOrderModal({ employees, onClose, onSuccess }) {
            const [formData, setFormData] = React.useState({
                order_id: '',
                employee_id: '',
                platform: '',
                account_name: '',
                symbol: 'USDT',
                side: 'buy',
                quantity: '',
                price: '',
                total_usdt: '',
                fees_usdt: '0',
                status: 'filled',
                executed_at: new Date().toISOString().slice(0, 16), // YYYY-MM-DDTHH:MM
                count_in_sales: false, // новое поле
                count_in_purchases: false // новое поле
            });
            const [creating, setCreating] = React.useState(false);
            const [error, setError] = React.useState('');
            const [success, setSuccess] = React.useState('');
            const [accounts, setAccounts] = React.useState([]);

            // Загружаем список аккаунтов
            React.useEffect(() => {
                fetch('/api/accounts')
                    .then(r => r.json())
                    .then(setAccounts)
                    .catch(() => setAccounts([]));
            }, []);

            const handleSubmit = async (e) => {
                e.preventDefault();
                
                if (!formData.order_id || !formData.employee_id || !formData.platform || 
                    !formData.account_name || !formData.quantity || !formData.price || 
                    !formData.total_usdt) {
                    setError('Заполните все обязательные поля');
                    return;
                }

                setCreating(true);
                setError('');
                setSuccess('');

                try {
                    const response = await fetch('/api/orders', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            order_id: formData.order_id,
                            employee_id: parseInt(formData.employee_id),
                            platform: formData.platform,
                            account_name: formData.account_name,
                            symbol: formData.symbol,
                            side: formData.side,
                            quantity: parseFloat(formData.quantity),
                            price: parseFloat(formData.price),
                            total_usdt: parseFloat(formData.total_usdt),
                            fees_usdt: parseFloat(formData.fees_usdt),
                            status: formData.status,
                            executed_at: formData.executed_at,
                            count_in_sales: formData.count_in_sales || false,
                            count_in_purchases: formData.count_in_purchases || false
                        }),
                    });

                    const result = await response.json();

                    if (response.ok) {
                        setSuccess('Ордер успешно добавлен');
                        setTimeout(() => {
                            onSuccess();
                        }, 1500);
                    } else {
                        setError(result.error || 'Ошибка добавления ордера');
                    }
                } catch (err) {
                    setError('Ошибка соединения с сервером');
                } finally {
                    setCreating(false);
                }
            };

            const filteredAccounts = accounts.filter(acc => 
                acc.platform === formData.platform
            );

            return (
                <div style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    backgroundColor: 'rgba(0, 0, 0, 0.5)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    zIndex: 1000
                }}>
                    <div style={{
                        backgroundColor: 'white',
                        borderRadius: '15px',
                        padding: '30px',
                        maxWidth: '600px',
                        width: '90%',
                        maxHeight: '90vh',
                        overflowY: 'auto',
                        boxShadow: '0 20px 40px rgba(0, 0, 0, 0.2)'
                    }}>
                        <div style={{
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center',
                            marginBottom: '20px'
                        }}>
                            <h3 style={{margin: 0, color: '#333'}}>
                                <i className="fas fa-plus"></i> Добавить ордер
                            </h3>
                            <button
                                onClick={onClose}
                                style={{
                                    background: 'none',
                                    border: 'none',
                                    fontSize: '20px',
                                    color: '#666',
                                    cursor: 'pointer'
                                }}
                            >
                                <i className="fas fa-times"></i>
                            </button>
                        </div>

                        <form onSubmit={handleSubmit}>
                            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '15px', marginBottom: '20px'}}>
                                <div>
                                    <label style={{display: 'block', marginBottom: '5px', fontWeight: 'bold'}}>
                                        ID ордера *:
                                    </label>
                                    <input
                                        type="text"
                                        className="form-control"
                                        value={formData.order_id}
                                        onChange={(e) => setFormData(prev => ({...prev, order_id: e.target.value}))}
                                        placeholder="Например: DOC001"
                                        required
                                    />
                                </div>

                                <div>
                                    <label style={{display: 'block', marginBottom: '5px', fontWeight: 'bold'}}>
                                        Сотрудник *:
                                    </label>
                                    <select
                                        className="form-control"
                                        value={formData.employee_id}
                                        onChange={(e) => setFormData(prev => ({...prev, employee_id: e.target.value}))}
                                        required
                                    >
                                        <option value="">Выберите сотрудника</option>
                                        {employees.map(emp => (
                                            <option key={emp.id} value={emp.id}>{emp.name}</option>
                                        ))}
                                    </select>
                                </div>
                            </div>

                            {/* --- ВЫБОР ОТДЕЛА --- */}
                            <div style={{marginBottom: '20px'}}>
                                <label style={{display: 'block', marginBottom: '8px', fontWeight: 'bold'}}>Отдел:</label>
                                <div style={{display:'flex',gap:12}}>
                                    <label style={{
                                        flex:1,
                                        padding:'10px',
                                        border:'2px solid ' + (formData.department === 'first' ? '#667eea' : '#e1e8ed'),
                                        borderRadius:'8px',
                                        cursor:'pointer',
                                        display:'flex',
                                        alignItems:'center',
                                        justifyContent:'center',
                                        gap:'8px',
                                        background: formData.department === 'first' ? '#667eea10' : '#fff'
                                    }}>
                                        <input
                                            type="radio"
                                            name="department"
                                            value="first"
                                            checked={formData.department === 'first'}
                                            onChange={e => setFormData(prev => ({...prev, department: e.target.value}))}
                                            style={{display:'none'}}
                                        />
                                        <i className="fas fa-building" style={{color: formData.department === 'first' ? '#667eea' : '#495057'}}></i>
                                        <span style={{color: formData.department === 'first' ? '#667eea' : '#495057'}}>Первый отдел</span>
                                    </label>
                                    <label style={{
                                        flex:1,
                                        padding:'10px',
                                        border:'2px solid ' + (formData.department === 'second' ? '#667eea' : '#e1e8ed'),
                                        borderRadius:'8px',
                                        cursor:'pointer',
                                        display:'flex',
                                        alignItems:'center',
                                        justifyContent:'center',
                                        gap:'8px',
                                        background: formData.department === 'second' ? '#667eea10' : '#fff'
                                    }}>
                                        <input
                                            type="radio"
                                            name="department"
                                            value="second"
                                            checked={formData.department === 'second'}
                                            onChange={e => setFormData(prev => ({...prev, department: e.target.value}))}
                                            style={{display:'none'}}
                                        />
                                        <i className="fas fa-building" style={{color: formData.department === 'second' ? '#667eea' : '#495057'}}></i>
                                        <span style={{color: formData.department === 'second' ? '#667eea' : '#495057'}}>Второй отдел</span>
                                    </label>
                                </div>
                            </div>

                            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '15px', marginBottom: '20px'}}>
                                <div>
                                    <label style={{display: 'block', marginBottom: '5px', fontWeight: 'bold'}}>
                                        Платформа *:
                                    </label>
                                    <select
                                        className="form-control"
                                        value={formData.platform}
                                        onChange={(e) => setFormData(prev => ({...prev, platform: e.target.value, account_name: ''}))}
                                        required
                                    >
                                        <option value="">Выберите платформу</option>
                                        <option value="bybit">Bybit</option>
                                        <option value="bliss">Bliss</option>
                                        <option value="htx">HTX</option>
                                        <option value="gate">Gate</option>
                                    </select>
                                </div>

                                <div>
                                    <label style={{display: 'block', marginBottom: '5px', fontWeight: 'bold'}}>
                                        Аккаунт *:
                                    </label>
                                    {!formData.platform ? (
                                        <div style={{
                                            padding: '8px 12px',
                                            backgroundColor: '#f8f9fa',
                                            border: '1px solid #dee2e6',
                                            borderRadius: '4px',
                                            color: '#6c757d',
                                            fontSize: '14px'
                                        }}>
                                            Выберите платформу
                                        </div>
                                    ) : filteredAccounts.length > 0 ? (
                                        <select
                                            className="form-control"
                                            value={formData.account_name}
                                            onChange={(e) => setFormData(prev => ({...prev, account_name: e.target.value}))}
                                            required
                                        >
                                            <option value="">Выберите аккаунт</option>
                                            {filteredAccounts.map(acc => (
                                                <option key={acc.id} value={acc.account_name}>{acc.account_name}</option>
                                            ))}
                                        </select>
                                    ) : (
                                        <input
                                            type="text"
                                            className="form-control"
                                            value={formData.account_name}
                                            onChange={(e) => setFormData(prev => ({...prev, account_name: e.target.value}))}
                                            placeholder="Введите название аккаунта"
                                            required
                                        />
                                    )}
                                </div>
                            </div>

                            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '15px', marginBottom: '20px'}}>
                                <div>
                                    <label style={{display: 'block', marginBottom: '5px', fontWeight: 'bold'}}>
                                        Пара:
                                    </label>
                                    <input
                                        type="text"
                                        className="form-control"
                                        value={formData.symbol}
                                        onChange={(e) => setFormData(prev => ({...prev, symbol: e.target.value}))}
                                        placeholder="USDT"
                                    />
                                </div>

                                <div>
                                    <label style={{display: 'block', marginBottom: '5px', fontWeight: 'bold'}}>
                                        Сторона:
                                    </label>
                                    <select
                                        className="form-control"
                                        value={formData.side}
                                        onChange={(e) => setFormData(prev => ({...prev, side: e.target.value}))}
                                    >
                                        <option value="buy">Покупка</option>
                                        <option value="sell">Продажа</option>
                                    </select>
                                </div>

                                <div>
                                    <label style={{display: 'block', marginBottom: '5px', fontWeight: 'bold'}}>
                                        Статус:
                                    </label>
                                    <select
                                        className="form-control"
                                        value={formData.status}
                                        onChange={(e) => setFormData(prev => ({...prev, status: e.target.value}))}
                                    >
                                        <option value="filled">Завершен</option>
                                        <option value="canceled">Отменен</option>
                                        <option value="pending">В ожидании</option>
                                        <option value="appealed">Апелляция</option>
                                        <option value="dokidka">Докидка</option>
                                        <option value="internal_transfer">Внутренний перевод</option>
                                        <option value="scam">Скам</option>
                                    </select>
                                </div>
                            </div>

                            {/* Чекбоксы для учета в статистике - показываются только для специальных статусов */}
                            {(formData.status === 'appealed' || formData.status === 'dokidka' || formData.status === 'internal_transfer' || formData.status === 'scam') && (
                                <div style={{background: '#f8f9fa', padding: '15px', borderRadius: '8px', marginBottom: '20px', border: '1px solid #dee2e6'}}>
                                    <div style={{fontWeight: 'bold', marginBottom: '10px', color: '#495057'}}>
                                        <i className="fas fa-cog"></i> Настройки учета в статистике
                                    </div>
                                    <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '15px'}}>
                                        <div style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
                                            <input
                                                type="checkbox"
                                                id="count_in_sales"
                                                checked={formData.count_in_sales || false}
                                                onChange={(e) => setFormData(prev => ({...prev, count_in_sales: e.target.checked}))}
                                                style={{margin: 0}}
                                            />
                                            <label htmlFor="count_in_sales" style={{margin: 0, fontWeight: '500', color: '#495057'}}>
                                                Учитывать в продажах
                                            </label>
                                        </div>
                                        <div style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
                                            <input
                                                type="checkbox"
                                                id="count_in_purchases"
                                                checked={formData.count_in_purchases || false}
                                                onChange={(e) => setFormData(prev => ({...prev, count_in_purchases: e.target.checked}))}
                                                style={{margin: 0}}
                                            />
                                            <label htmlFor="count_in_purchases" style={{margin: 0, fontWeight: '500', color: '#495057'}}>
                                                Учитывать в покупках
                                            </label>
                                        </div>
                                    </div>
                                    <div style={{fontSize: '0.85em', color: '#6c757d', marginTop: '8px'}}>
                                        <i className="fas fa-info-circle"></i> Эти настройки влияют на расчет прибыли в отчетах
                                    </div>
                                </div>
                            )}

                            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '15px', marginBottom: '20px'}}>
                                <div>
                                    <label style={{display: 'block', marginBottom: '5px', fontWeight: 'bold'}}>
                                        Объем (USDT) *:
                                    </label>
                                    <input
                                        type="number"
                                        step="0.01"
                                        className="form-control"
                                        value={formData.quantity}
                                        onChange={(e) => setFormData(prev => ({...prev, quantity: e.target.value}))}
                                        placeholder="100.00"
                                        required
                                    />
                                </div>

                                <div>
                                    <label style={{display: 'block', marginBottom: '5px', fontWeight: 'bold'}}>
                                        Цена (RUB/USDT) *:
                                    </label>
                                    <input
                                        type="number"
                                        step="0.01"
                                        className="form-control"
                                        value={formData.price}
                                        onChange={(e) => setFormData(prev => ({...prev, price: e.target.value}))}
                                        placeholder="75.50"
                                        required
                                    />
                                </div>

                                <div>
                                    <label style={{display: 'block', marginBottom: '5px', fontWeight: 'bold'}}>
                                        Комиссия (USDT):
                                    </label>
                                    <input
                                        type="number"
                                        step="0.01"
                                        className="form-control"
                                        value={formData.fees_usdt}
                                        onChange={(e) => setFormData(prev => ({...prev, fees_usdt: e.target.value}))}
                                        placeholder="0.00"
                                    />
                                </div>
                            </div>

                            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '15px', marginBottom: '20px'}}>
                                <div>
                                    <label style={{display: 'block', marginBottom: '5px', fontWeight: 'bold'}}>
                                        Общая сумма (RUB) *:
                                    </label>
                                    <input
                                        type="number"
                                        step="0.01"
                                        className="form-control"
                                        value={formData.total_usdt}
                                        onChange={(e) => setFormData(prev => ({...prev, total_usdt: e.target.value}))}
                                        placeholder="7550.00"
                                        required
                                    />
                                </div>

                                <div>
                                    <label style={{display: 'block', marginBottom: '5px', fontWeight: 'bold'}}>
                                        Дата выполнения *:
                                    </label>
                                    <input
                                        type="datetime-local"
                                        className="form-control"
                                        value={formData.executed_at}
                                        onChange={(e) => setFormData(prev => ({...prev, executed_at: e.target.value}))}
                                        required
                                    />
                                </div>
                            </div>

                            {error && (
                                <div style={{
                                    color: '#e74c3c',
                                    background: '#fdf2f2',
                                    padding: '10px',
                                    borderRadius: '5px',
                                    marginBottom: '15px'
                                }}>
                                    <i className="fas fa-exclamation-circle"></i> {error}
                                </div>
                            )}

                            {success && (
                                <div style={{
                                    color: '#27ae60',
                                    background: '#f0f9f0',
                                    padding: '10px',
                                    borderRadius: '5px',
                                    marginBottom: '15px'
                                }}>
                                    <i className="fas fa-check-circle"></i> {success}
                                </div>
                            )}

                            <div style={{display: 'flex', gap: '10px', justifyContent: 'flex-end'}}>
                                <button
                                    type="button"
                                    onClick={onClose}
                                    className="btn btn-secondary"
                                    disabled={creating}
                                >
                                    Отмена
                                </button>
                                <button
                                    type="submit"
                                    className="btn btn-success"
                                    disabled={creating}
                                >
                                    {creating ? (
                                        <>
                                            <i className="fas fa-spinner fa-spin"></i> Добавление...
                                        </>
                                    ) : (
                                        <>
                                            <i className="fas fa-plus"></i> Добавить ордер
                                        </>
                                    )}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // --- Компонент для редактирования ордера ---
        function EditOrderModal({ order, employees, onClose, onSuccess }) {
            const [formData, setFormData] = React.useState({
                order_id: order.order_id,
                employee_id: order.employee_id,
                platform: order.platform,
                account_name: order.account_name,
                symbol: order.symbol,
                side: order.side,
                quantity: order.quantity,
                price: order.price,
                total_usdt: order.total_usdt,
                fees_usdt: order.fees_usdt,
                status: order.status,
                executed_at: new Date(order.executed_at).toISOString().slice(0, 16), // YYYY-MM-DDTHH:MM
                count_in_sales: order.count_in_sales || false,
                count_in_purchases: order.count_in_purchases || false
            });
            const [updating, setUpdating] = React.useState(false);
            const [error, setError] = React.useState('');
            const [success, setSuccess] = React.useState('');
            const [accounts, setAccounts] = React.useState([]);

            // Загружаем список аккаунтов
            React.useEffect(() => {
                fetch('/api/accounts')
                    .then(r => r.json())
                    .then(setAccounts)
                    .catch(() => setAccounts([]));
            }, []);

            const handleSubmit = async (e) => {
                e.preventDefault();
                
                if (!formData.order_id || !formData.employee_id || !formData.platform || 
                    !formData.account_name || !formData.quantity || !formData.price || 
                    !formData.total_usdt) {
                    setError('Заполните все обязательные поля');
                    return;
                }

                setUpdating(true);
                setError('');
                setSuccess('');

                try {
                    const response = await fetch(`/api/orders/${order.id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            order_id: formData.order_id,
                            employee_id: parseInt(formData.employee_id),
                            platform: formData.platform,
                            account_name: formData.account_name,
                            symbol: formData.symbol,
                            side: formData.side,
                            quantity: parseFloat(formData.quantity),
                            price: parseFloat(formData.price),
                            total_usdt: parseFloat(formData.total_usdt),
                            fees_usdt: parseFloat(formData.fees_usdt),
                            status: formData.status,
                            executed_at: formData.executed_at,
                            count_in_sales: formData.count_in_sales || false,
                            count_in_purchases: formData.count_in_purchases || false
                        }),
                    });

                    const result = await response.json();

                    if (response.ok) {
                        setSuccess('Ордер успешно обновлен');
                        setTimeout(() => {
                            onSuccess();
                        }, 1500);
                    } else {
                        setError(result.error || 'Ошибка обновления ордера');
                    }
                } catch (err) {
                    setError('Ошибка соединения с сервером');
                } finally {
                    setUpdating(false);
                }
            };

            const filteredAccounts = accounts.filter(acc => 
                acc.platform === formData.platform
            );

            return (
                <div style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    backgroundColor: 'rgba(0, 0, 0, 0.5)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    zIndex: 1000
                }}>
                    <div style={{
                        backgroundColor: 'white',
                        borderRadius: '15px',
                        padding: '30px',
                        maxWidth: '600px',
                        width: '90%',
                        maxHeight: '90vh',
                        overflowY: 'auto',
                        boxShadow: '0 20px 40px rgba(0, 0, 0, 0.2)'
                    }}>
                        <div style={{
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center',
                            marginBottom: '20px'
                        }}>
                            <h3 style={{margin: 0, color: '#333'}}>
                                <i className="fas fa-edit"></i> Редактировать ордер
                            </h3>
                            <button
                                onClick={onClose}
                                style={{
                                    background: 'none',
                                    border: 'none',
                                    fontSize: '20px',
                                    color: '#666',
                                    cursor: 'pointer'
                                }}
                            >
                                <i className="fas fa-times"></i>
                            </button>
                        </div>

                        <form onSubmit={handleSubmit}>
                            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '15px', marginBottom: '20px'}}>
                                <div>
                                    <label style={{display: 'block', marginBottom: '5px', fontWeight: 'bold'}}>
                                        ID ордера *:
                                    </label>
                                    <input
                                        type="text"
                                        className="form-control"
                                        value={formData.order_id}
                                        onChange={(e) => setFormData(prev => ({...prev, order_id: e.target.value}))}
                                        placeholder="Например: DOC001"
                                        required
                                    />
                                </div>

                                <div>
                                    <label style={{display: 'block', marginBottom: '5px', fontWeight: 'bold'}}>
                                        Сотрудник *:
                                    </label>
                                    <select
                                        className="form-control"
                                        value={formData.employee_id}
                                        onChange={(e) => setFormData(prev => ({...prev, employee_id: e.target.value}))}
                                        required
                                    >
                                        <option value="">Выберите сотрудника</option>
                                        {employees.map(emp => (
                                            <option key={emp.id} value={emp.id}>{emp.name}</option>
                                        ))}
                                    </select>
                                </div>
                            </div>

                            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '15px', marginBottom: '20px'}}>
                                <div>
                                    <label style={{display: 'block', marginBottom: '5px', fontWeight: 'bold'}}>
                                        Платформа *:
                                    </label>
                                    <select
                                        className="form-control"
                                        value={formData.platform}
                                        onChange={(e) => setFormData(prev => ({...prev, platform: e.target.value, account_name: ''}))}
                                        required
                                    >
                                        <option value="">Выберите платформу</option>
                                        <option value="bybit">Bybit</option>
                                        <option value="bliss">Bliss</option>
                                        <option value="htx">HTX</option>
                                        <option value="gate">Gate</option>
                                    </select>
                                </div>

                                <div>
                                    <label style={{display: 'block', marginBottom: '5px', fontWeight: 'bold'}}>
                                        Аккаунт *:
                                    </label>
                                    {!formData.platform ? (
                                        <div style={{
                                            padding: '8px 12px',
                                            backgroundColor: '#f8f9fa',
                                            border: '1px solid #dee2e6',
                                            borderRadius: '4px',
                                            color: '#6c757d',
                                            fontSize: '14px'
                                        }}>
                                            Выберите платформу
                                        </div>
                                    ) : (
                                        <select
                                            className="form-control"
                                            value={formData.account_name}
                                            onChange={(e) => setFormData(prev => ({...prev, account_name: e.target.value}))}
                                            required
                                        >
                                            <option value="">Выберите аккаунт</option>
                                            {filteredAccounts.map(acc => (
                                                <option key={acc.id} value={acc.account_name}>{acc.account_name}</option>
                                            ))}
                                            <option value="custom">Другой аккаунт</option>
                                        </select>
                                    )}
                                </div>
                            </div>

                            {formData.account_name === 'custom' && (
                                <div style={{marginBottom: '20px'}}>
                                    <label style={{display: 'block', marginBottom: '5px', fontWeight: 'bold'}}>
                                        Название аккаунта:
                                    </label>
                                    <input
                                        type="text"
                                        className="form-control"
                                        value={formData.account_name === 'custom' ? '' : formData.account_name}
                                        onChange={(e) => setFormData(prev => ({...prev, account_name: e.target.value}))}
                                        placeholder="Введите название аккаунта"
                                        required
                                    />
                                </div>
                            )}

                            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '15px', marginBottom: '20px'}}>
                                <div>
                                    <label style={{display: 'block', marginBottom: '5px', fontWeight: 'bold'}}>
                                        Пара *:
                                    </label>
                                    <input
                                        type="text"
                                        className="form-control"
                                        value={formData.symbol}
                                        onChange={(e) => setFormData(prev => ({...prev, symbol: e.target.value}))}
                                        placeholder="Например: BTC/USDT"
                                        required
                                    />
                                </div>

                                <div>
                                    <label style={{display: 'block', marginBottom: '5px', fontWeight: 'bold'}}>
                                        Сторона *:
                                    </label>
                                    <select
                                        className="form-control"
                                        value={formData.side}
                                        onChange={(e) => setFormData(prev => ({...prev, side: e.target.value}))}
                                        required
                                    >
                                        <option value="buy">Покупка</option>
                                        <option value="sell">Продажа</option>
                                    </select>
                                </div>
                            </div>

                            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '15px', marginBottom: '20px'}}>
                                <div>
                                    <label style={{display: 'block', marginBottom: '5px', fontWeight: 'bold'}}>
                                        Количество (USDT) *:
                                    </label>
                                    <input
                                        type="number"
                                        step="0.00000001"
                                        className="form-control"
                                        value={formData.quantity}
                                        onChange={(e) => setFormData(prev => ({...prev, quantity: e.target.value}))}
                                        placeholder="0.00000000"
                                        required
                                    />
                                </div>

                                <div>
                                    <label style={{display: 'block', marginBottom: '5px', fontWeight: 'bold'}}>
                                        Цена (RUB) *:
                                    </label>
                                    <input
                                        type="number"
                                        step="0.01"
                                        className="form-control"
                                        value={formData.price}
                                        onChange={(e) => setFormData(prev => ({...prev, price: e.target.value}))}
                                        placeholder="0.00"
                                        required
                                    />
                                </div>
                            </div>

                            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '15px', marginBottom: '20px'}}>
                                <div>
                                    <label style={{display: 'block', marginBottom: '5px', fontWeight: 'bold'}}>
                                        Объем (RUB) *:
                                    </label>
                                    <input
                                        type="number"
                                        step="0.01"
                                        className="form-control"
                                        value={formData.total_usdt}
                                        onChange={(e) => setFormData(prev => ({...prev, total_usdt: e.target.value}))}
                                        placeholder="0.00"
                                        required
                                    />
                                </div>

                                <div>
                                    <label style={{display: 'block', marginBottom: '5px', fontWeight: 'bold'}}>
                                        Комиссия (USDT):
                                    </label>
                                    <input
                                        type="number"
                                        step="0.01"
                                        className="form-control"
                                        value={formData.fees_usdt}
                                        onChange={(e) => setFormData(prev => ({...prev, fees_usdt: e.target.value}))}
                                        placeholder="0.00"
                                    />
                                </div>
                            </div>

                            <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '15px', marginBottom: '20px'}}>
                                <div>
                                    <label style={{display: 'block', marginBottom: '5px', fontWeight: 'bold'}}>
                                        Статус *:
                                    </label>
                                    <select
                                        className="form-control"
                                        value={formData.status}
                                        onChange={(e) => setFormData(prev => ({...prev, status: e.target.value}))}
                                        required
                                    >
                                        <option value="filled">Завершен</option>
                                        <option value="pending">В ожидании</option>
                                        <option value="canceled">Отменен</option>
                                        <option value="appealed">Апелляция</option>
                                        <option value="dokidka">Докидка</option>
                                        <option value="internal_transfer">Внутренний перевод</option>
                                        <option value="scam">Скам</option>
                                    </select>
                                </div>

                                <div>
                                    <label style={{display: 'block', marginBottom: '5px', fontWeight: 'bold'}}>
                                        Дата выполнения *:
                                    </label>
                                    <input
                                        type="datetime-local"
                                        className="form-control"
                                        value={formData.executed_at}
                                        onChange={(e) => setFormData(prev => ({...prev, executed_at: e.target.value}))}
                                        required
                                    />
                                </div>
                            </div>

                            {/* Чекбоксы для учета в статистике - показываются только для специальных статусов */}
                            {(formData.status === 'appealed' || formData.status === 'dokidka' || formData.status === 'internal_transfer' || formData.status === 'scam') && (
                                <div style={{background: '#f8f9fa', padding: '15px', borderRadius: '8px', marginBottom: '20px', border: '1px solid #dee2e6'}}>
                                    <div style={{fontWeight: 'bold', marginBottom: '10px', color: '#495057'}}>
                                        <i className="fas fa-cog"></i> Настройки учета в статистике
                                    </div>
                                    <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '15px'}}>
                                        <div style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
                                            <input
                                                type="checkbox"
                                                id="edit_count_in_sales"
                                                checked={formData.count_in_sales || false}
                                                onChange={(e) => setFormData(prev => ({...prev, count_in_sales: e.target.checked}))}
                                                style={{margin: 0}}
                                            />
                                            <label htmlFor="edit_count_in_sales" style={{margin: 0, fontWeight: '500', color: '#495057'}}>
                                                Учитывать в продажах
                                            </label>
                                        </div>
                                        <div style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
                                            <input
                                                type="checkbox"
                                                id="edit_count_in_purchases"
                                                checked={formData.count_in_purchases || false}
                                                onChange={(e) => setFormData(prev => ({...prev, count_in_purchases: e.target.checked}))}
                                                style={{margin: 0}}
                                            />
                                            <label htmlFor="edit_count_in_purchases" style={{margin: 0, fontWeight: '500', color: '#495057'}}>
                                                Учитывать в покупках
                                            </label>
                                        </div>
                                    </div>
                                    <div style={{fontSize: '0.85em', color: '#6c757d', marginTop: '8px'}}>
                                        <i className="fas fa-info-circle"></i> Эти настройки влияют на расчет прибыли в отчетах
                                    </div>
                                </div>
                            )}

                            {error && (
                                <div style={{
                                    color: '#e74c3c',
                                    background: '#fdf2f2',
                                    padding: '10px',
                                    borderRadius: '5px',
                                    marginBottom: '15px'
                                }}>
                                    <i className="fas fa-exclamation-circle"></i> {error}
                                </div>
                            )}

                            {success && (
                                <div style={{
                                    color: '#27ae60',
                                    background: '#f0f9f0',
                                    padding: '10px',
                                    borderRadius: '5px',
                                    marginBottom: '15px'
                                }}>
                                    <i className="fas fa-check-circle"></i> {success}
                                </div>
                            )}

                            <div style={{display: 'flex', gap: '10px', justifyContent: 'flex-end'}}>
                                <button
                                    type="button"
                                    onClick={onClose}
                                    className="btn btn-secondary"
                                    disabled={updating}
                                >
                                    Отмена
                                </button>
                                <button
                                    type="submit"
                                    className="btn btn-primary"
                                    disabled={updating}
                                >
                                    {updating ? (
                                        <>
                                            <i className="fas fa-spinner fa-spin"></i> Обновление...
                                        </>
                                    ) : (
                                        <>
                                            <i className="fas fa-save"></i> Сохранить изменения
                                        </>
                                    )}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // Функция для форматирования чисел с разделителями тысяч
        function formatNumber(num) {
            if (num === null || num === undefined) return '0.00';
            return Number(num).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, " ");
        }

        // --- UI-раздел для истории ордеров ---
        function OrdersHistory({ employees }) {
            const [orders, setOrders] = React.useState([]);
            
            // Устанавливаем фильтр по умолчанию на последнюю неделю
            const getDefaultDates = () => {
                const today = new Date();
                const weekAgo = new Date(today.getTime() - (7 * 24 * 60 * 60 * 1000));
                
                // Форматируем даты для input[type="date"] в формате YYYY-MM-DD
                const formatDate = (date) => {
                    return date.toISOString().slice(0, 10);
                };
                
                return {
                    start_date: formatDate(weekAgo),
                    end_date: formatDate(today)
                };
            };
            
            const [filters, setFilters] = React.useState({ 
                employee_id: '', 
                platform: 'bybit', // По умолчанию bybit
                status: '', 
                department: '', // новый фильтр
                ...getDefaultDates() // Устанавливаем даты по умолчанию
            });
            const [page, setPage] = React.useState(1);
            const [loading, setLoading] = React.useState(false);
            const [statistics, setStatistics] = React.useState(null);
            const [showUploadModal, setShowUploadModal] = React.useState(false);
            const [showUploadBTCModal, setShowUploadBTCModal] = React.useState(false);
            const [showAddOrderModal, setShowAddOrderModal] = React.useState(false);
            const [showEditOrderModal, setShowEditOrderModal] = React.useState(false);
            const [editingOrder, setEditingOrder] = React.useState(null);
            const [activeTab, setActiveTab] = React.useState('bybit'); // Активная подвкладка
            const rowsPerPage = 20;
            
            // Состояние для массового удаления
            const [selectedOrders, setSelectedOrders] = React.useState([]);
            const [selectAll, setSelectAll] = React.useState(false);
            const [deleting, setDeleting] = React.useState(false);

            // Состояние для удаления одного ордера
            const [deletingOrder, setDeletingOrder] = React.useState(null);
            const [showDeletePasswordModal, setShowDeletePasswordModal] = React.useState(false);
            const [deletePassword, setDeletePassword] = React.useState('');

            // Функция для смены подвкладки
            const handleTabChange = (tab) => {
                setActiveTab(tab);
                setFilters(prev => ({ ...prev, platform: tab }));
                setPage(1);
            };

            // Загрузка ордеров
            React.useEffect(() => {
                setLoading(true);
                let url = activeTab === 'btc' ? '/api/orders/btc?' : '/api/orders?';
                if (filters.employee_id) url += `employee_id=${filters.employee_id}&`;
                if (filters.platform && activeTab !== 'btc') url += `platform=${filters.platform}&`;
                if (filters.status) url += `status=${filters.status}&`;
                if (filters.start_date) url += `start_date=${filters.start_date}&`;
                if (filters.end_date) url += `end_date=${filters.end_date}`;
                if (filters.department) url += `department=${filters.department}&`;
                
                fetch(url)
                    .then(r => r.json())
                    .then(data => { 
                        setOrders(data); 
                        setPage(1); 
                        setLoading(false);
                    })
                    .catch(() => setLoading(false));
            }, [filters, activeTab]);

            // Загрузка статистики (по всем платформам, исключая отмененные ордера)
            React.useEffect(() => {
                let url = '/api/orders/statistics?';
                if (filters.employee_id) url += `employee_id=${filters.employee_id}&`;
                
                // Если выбран конкретный статус, используем его
                // Иначе исключаем отмененные ордера (по умолчанию)
                if (filters.status) {
                    url += `status=${filters.status}&`;
                } else {
                    url += `exclude_canceled=true&`;
                }
                
                // Передаем platform для корректной загрузки статистики
                if (activeTab === 'btc') {
                    url += `platform=bybit_btc&`;
                } else if (activeTab === 'bybit') {
                    url += `platform=bybit&`;
                } else if (activeTab === 'bliss') {
                    url += `platform=bliss&`;
                } else if (activeTab === 'htx') {
                    url += `platform=htx&`;
                } else if (activeTab === 'gate') {
                    url += `platform=gate&`;
                }
                // Иначе показываем статистику по всем платформам (кроме BTC)
                
                if (filters.start_date) url += `start_date=${filters.start_date}&`;
                if (filters.end_date) url += `end_date=${filters.end_date}`;
                if (filters.department) url += `department=${filters.department}&`;
                
                console.log('🔍 Загружаем статистику для вкладки:', activeTab, 'URL:', url);
                fetch(url)
                    .then(r => r.json())
                    .then(data => {
                        console.log('📊 Получена статистика:', data);
                        setStatistics(data);
                    })
                    .catch(error => {
                        console.error('❌ Ошибка загрузки статистики:', error);
                        setStatistics(null);
                    });
            }, [filters, activeTab]);

            // Пагинация
            const totalPages = Math.ceil(orders.length / rowsPerPage) || 1;
            const paginated = orders.slice((page-1)*rowsPerPage, page*rowsPerPage);
            
            const handlePageChange = (newPage) => {
                if (newPage >= 1 && newPage <= totalPages) setPage(newPage);
            };

            const getStatusColor = (status) => {
                switch(status.toLowerCase()) {
                    case 'filled': return '#27ae60';
                    case 'completed': return '#27ae60';
                    case 'canceled': return '#e74c3c';
                    case 'cancelled': return '#e74c3c';
                    case 'pending': return '#f39c12';
                    case 'appealed': return '#9b59b6';
                    case 'dokidka': return '#3498db';
                    case 'internal_transfer': return '#e67e22';
                    default: return '#7f8c8d';
                }
            };

            const getStatusText = (status) => {
                switch(status.toLowerCase()) {
                    case 'filled': return 'Завершен';
                    case 'completed': return 'Завершен';
                    case 'canceled': return 'Отменен';
                    case 'cancelled': return 'Отменен';
                    case 'pending': return 'В ожидании';
                    case 'appealed': return 'Апелляция';
                    case 'dokidka': return 'Докидка';
                    case 'internal_transfer': return 'Внутренний перевод';
                    default: return status;
                }
            };

            const getSideText = (side) => {
                return side.toLowerCase() === 'buy' ? 'Покупка' : 'Продажа';
            };

            const getSideColor = (side) => {
                return side.toLowerCase() === 'buy' ? '#27ae60' : '#e74c3c';
            };

            // Функции для массового удаления
            const toggleSelectAll = () => {
                if (selectAll) {
                    setSelectedOrders([]);
                } else {
                    setSelectedOrders(paginated.map(order => order.id));
                }
                setSelectAll(!selectAll);
            };

            const toggleSelectOrder = (orderId) => {
                if (selectedOrders.includes(orderId)) {
                    setSelectedOrders(selectedOrders.filter(id => id !== orderId));
                } else {
                    setSelectedOrders([...selectedOrders, orderId]);
                }
            };

            const deleteSelectedOrders = async () => {
                if (selectedOrders.length === 0) return;
                
                if (!confirm(`Вы уверены, что хотите удалить ${selectedOrders.length} ордеров?`)) {
                    return;
                }

                // Запрашиваем пароль для массового удаления
                const password = prompt('Введите пароль администратора для удаления ордеров:');
                if (!password) {
                    return;
                }
                
                setDeleting(true);
                
                try {
                    const response = await fetch('/api/orders/bulk-delete', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ 
                            order_ids: selectedOrders,
                            password: password 
                        }),
                    });
                    
                    if (response.ok) {
                        // Обновляем список ордеров
                        setOrders(orders.filter(order => !selectedOrders.includes(order.id)));
                        setSelectedOrders([]);
                        setSelectAll(false);
                        alert('Ордеры успешно удалены');
                    } else {
                        const error = await response.json();
                        alert(`Ошибка удаления: ${error.error}`);
                    }
                } catch (error) {
                    alert('Ошибка при удалении ордеров');
                } finally {
                    setDeleting(false);
                }
            };

            // Функция для редактирования ордера
            const handleEditOrder = (order) => {
                setEditingOrder(order);
                setShowEditOrderModal(true);
            };

            // Функция для удаления ордера
            const handleDeleteOrder = (order) => {
                setDeletingOrder(order);
                setShowDeletePasswordModal(true);
            };

            // Функция для подтверждения удаления ордера
            const confirmDeleteOrder = async () => {
                if (!deletePassword) {
                    alert('Введите пароль администратора');
                    return;
                }

                setDeleting(true);
                
                try {
                    const response = await fetch(`/api/orders/${deletingOrder.id}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ password: deletePassword }),
                    });
                    
                    if (response.ok) {
                        // Обновляем список ордеров
                        setOrders(orders.filter(order => order.id !== deletingOrder.id));
                        setShowDeletePasswordModal(false);
                        setDeletingOrder(null);
                        setDeletePassword('');
                        alert('Ордер успешно удален');
                    } else {
                        const error = await response.json();
                        alert(`Ошибка удаления: ${error.error}`);
                    }
                } catch (error) {
                    alert('Ошибка при удалении ордера');
                } finally {
                    setDeleting(false);
                }
            };

            // Сбрасываем выделение при смене страницы или фильтров
            React.useEffect(() => {
                setSelectedOrders([]);
                setSelectAll(false);
            }, [page, filters]);

            return (
                <div className="card">
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px'}}>
                        <div style={{display: 'flex', alignItems: 'center', gap: '12px'}}>
                            <h3><i className="fas fa-list-alt"></i> История ордеров</h3>
                            <span style={{
                                padding: '4px 12px',
                                borderRadius: '20px',
                                background: activeTab === 'bybit' ? '#f7931a' : 
                                           activeTab === 'btc' ? '#f7931a' :
                                           activeTab === 'bliss' ? '#9c27b0' : 
                                           activeTab === 'htx' ? '#00d4aa' : '#764ba2',
                                color: 'white',
                                fontSize: '12px',
                                fontWeight: '600',
                                textTransform: 'uppercase'
                            }}>
                                {activeTab === 'bybit' ? 'Bybit' : 
                                 activeTab === 'btc' ? 'BTC' :
                                 activeTab === 'bliss' ? 'Bliss' : 
                                 activeTab === 'htx' ? 'HTX' : 'Gate'}
                            </span>
                        </div>
                        <div style={{display: 'flex', gap: '10px'}}>
                            {selectedOrders.length > 0 && (
                                <button 
                                    className="btn btn-danger"
                                    onClick={deleteSelectedOrders}
                                    disabled={deleting}
                                    style={{
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '8px',
                                        padding: '10px 20px',
                                        borderRadius: '8px',
                                        fontWeight: '600'
                                    }}
                                >
                                    <i className={deleting ? "fas fa-spinner fa-spin" : "fas fa-trash"}></i>
                                    {deleting ? 'Удаление...' : `Удалить (${selectedOrders.length})`}
                                </button>
                            )}
                            <button 
                                className="btn btn-success"
                                onClick={() => setShowAddOrderModal(true)}
                                style={{
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '8px',
                                    padding: '10px 20px',
                                    borderRadius: '8px',
                                    fontWeight: '600'
                                }}
                            >
                                <i className="fas fa-plus"></i>
                                Добавить ордер
                            </button>
                            <button 
                                className="btn btn-primary"
                                onClick={() => setShowUploadModal(true)}
                                style={{
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '8px',
                                    padding: '10px 20px',
                                    borderRadius: '8px',
                                    fontWeight: '600'
                                }}
                            >
                                <i className="fas fa-upload"></i>
                                Загрузить выгрузку
                            </button>
                            {activeTab === 'bybit' && (
                                <button 
                                    className="btn btn-warning"
                                    onClick={() => setShowUploadBTCModal(true)}
                                    style={{
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '8px',
                                        padding: '10px 20px',
                                        borderRadius: '8px',
                                        fontWeight: '600',
                                        marginLeft: '8px',
                                        background: '#f7931a',
                                        color: '#fff',
                                        border: 'none',
                                        boxShadow: '0 2px 8px rgba(247,147,26,0.12)'
                                    }}
                                >
                                    <i className="fas fa-bitcoin"></i>
                                    Загрузить BTC-выгрузку
                                </button>
                            )}
                        </div>
                    </div>
                    
                    {/* Подвкладки платформ */}
                    <div style={{
                        display: 'flex',
                        borderBottom: '1px solid #dee2e6',
                        marginBottom: '20px',
                        backgroundColor: '#f8f9fa',
                        borderRadius: '8px 8px 0 0'
                    }}>
                        {[
                            { id: 'bybit', name: 'Bybit', icon: 'fab fa-bitcoin', color: '#f7931a' },
                            { id: 'btc', name: 'BTC', icon: 'fas fa-bitcoin', color: '#f7931a' },
                            { id: 'bliss', name: 'Bliss', icon: 'fas fa-star', color: '#9c27b0' },
                            { id: 'htx', name: 'HTX', icon: 'fas fa-exchange-alt', color: '#00d4aa' },
                            { id: 'gate', name: 'Gate', icon: 'fas fa-exchange-alt', color: '#764ba2' }
                        ].map(tab => (
                            <button
                                key={tab.id}
                                onClick={() => handleTabChange(tab.id)}
                                style={{
                                    padding: '12px 24px',
                                    border: 'none',
                                    background: activeTab === tab.id ? 'white' : 'transparent',
                                    color: activeTab === tab.id ? tab.color : '#6c757d',
                                    borderBottom: activeTab === tab.id ? `3px solid ${tab.color}` : '3px solid transparent',
                                    cursor: 'pointer',
                                    fontSize: '14px',
                                    fontWeight: activeTab === tab.id ? '700' : '600',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '8px',
                                    transition: 'all 0.3s ease',
                                    borderRadius: '8px 8px 0 0',
                                    boxShadow: activeTab === tab.id ? '0 2px 4px rgba(0,0,0,0.1)' : 'none'
                                }}
                                onMouseOver={e => {
                                    if (activeTab !== tab.id) {
                                        e.target.style.background = '#e9ecef';
                                        e.target.style.color = tab.color;
                                    }
                                }}
                                onMouseOut={e => {
                                    if (activeTab !== tab.id) {
                                        e.target.style.background = 'transparent';
                                        e.target.style.color = '#6c757d';
                                    }
                                }}
                            >
                                <i className={tab.icon}></i>
                                {tab.name}
                            </button>
                        ))}
                    </div>
                    
                    {/* Статистика */}
                    {statistics && (
                        <div style={{marginBottom: '20px'}}>
                            {/* Специальный блок для BTC */}
                            {activeTab === 'btc' && (() => {
                                console.log('🔍 Проверяем отображение BTC блока:', {
                                    activeTab,
                                    statistics: statistics,
                                    btc_total_usdt: statistics?.btc_total_usdt
                                });
                                return true;
                            })() && (
                                <div style={{
                                    background: 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)',
                                    padding: '25px',
                                    borderRadius: '15px',
                                    border: '3px solid #f59e0b',
                                    textAlign: 'center',
                                    marginBottom: '20px',
                                    boxShadow: '0 8px 25px rgba(245, 158, 11, 0.2)'
                                }}>
                                    <div style={{
                                        fontSize: '16px', 
                                        fontWeight: '700', 
                                        color: '#d97706', 
                                        marginBottom: '12px',
                                        textTransform: 'uppercase',
                                        letterSpacing: '1px'
                                    }}>
                                        🪙 ОБЩАЯ СУММА USDT ПО BTC-ОРДЕРАМ
                                    </div>
                                    <div style={{
                                        fontSize: '36px', 
                                        fontWeight: 'bold', 
                                        color: '#b45309',
                                        marginBottom: '8px',
                                        textShadow: '0 2px 4px rgba(0,0,0,0.1)'
                                    }}>
                                        {formatNumber(statistics.btc_total_usdt || 0)}
                                    </div>
                                    <div style={{
                                        fontSize: '14px', 
                                        color: '#92400e', 
                                        fontWeight: '600',
                                        opacity: '0.8'
                                    }}>
                                        Всего USDT в BTC-ордерах
                                    </div>
                                </div>
                            )}
                            
                            {/* Основные показатели - объемы (скрыты для BTC) */}
                            {activeTab !== 'btc' && (
                                <div style={{
                                    display: 'grid',
                                    gridTemplateColumns: 'repeat(auto-fit, minmax(180px, 1fr))',
                                    gap: '20px',
                                    marginBottom: '15px'
                                }}>
                                    {/* Продажи */}
                                    <div style={{
                                        background: 'linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)',
                                        padding: '20px',
                                        borderRadius: '12px',
                                        border: '2px solid #ef4444',
                                        textAlign: 'center'
                                    }}>
                                        <div style={{fontSize: '14px', fontWeight: '600', color: '#dc2626', marginBottom: '8px'}}>
                                            📊 ПРОДАЖИ (с переводами)
                                        </div>
                                        <div style={{fontSize: '28px', fontWeight: 'bold', color: '#b91c1c', marginBottom: '4px'}}>
                                            {formatNumber(statistics?.sell_volume || 0)}
                                        </div>
                                        <div style={{fontSize: '12px', color: '#7f1d1d', marginBottom: '8px'}}>RUB</div>
                                        <div style={{fontSize: '20px', fontWeight: 'bold', color: '#dc2626'}}>
                                            {formatNumber(statistics?.sell_volume_usdt || 0)}
                                        </div>
                                        <div style={{fontSize: '11px', color: '#7f1d1d'}}>USDT (включая докидки)</div>
                                    </div>
                                    
                                    {/* Прибыль */}
                                    <div style={{
                                        background: 'linear-gradient(135deg, #f0f9ff 0%, #bae6fd 100%)',
                                        padding: '20px',
                                        borderRadius: '12px',
                                        border: '3px solid #0369a1',
                                        textAlign: 'center',
                                        boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)'
                                    }}>
                                        <div style={{fontSize: '14px', fontWeight: '600', color: '#0369a1', marginBottom: '8px'}}>
                                            💰 ПРИБЫЛЬ
                                        </div>
                                        <div style={{
                                            fontSize: '28px', 
                                            fontWeight: 'bold', 
                                            color: (statistics?.profit_usdt || 0) >= 0 ? '#065f46' : '#991b1b',
                                            marginBottom: '4px'
                                        }}>
                                            {(statistics?.profit_usdt || 0) >= 0 ? '+' : ''}{formatNumber(statistics?.profit_usdt || 0)}
                                        </div>
                                        <div style={{fontSize: '12px', color: '#0c4a6e', fontWeight: '600'}}>USDT</div>
                                        <div style={{
                                            fontSize: '20px', 
                                            fontWeight: 'bold', 
                                            color: (statistics?.profit_rub || 0) >= 0 ? '#065f46' : '#991b1b',
                                            marginTop: '8px',
                                            marginBottom: '4px'
                                        }}>
                                            {(statistics?.profit_rub || 0) >= 0 ? '+' : ''}{formatNumber(statistics?.profit_rub || 0)}
                                        </div>
                                        <div style={{fontSize: '11px', color: '#0c4a6e', fontWeight: '600'}}>RUB</div>
                                        <div style={{fontSize: '10px', color: '#64748b', marginTop: '4px'}}>
                                            Покупки - Продажи
                                        </div>
                                    </div>
                                    
                                    {/* Покупки */}
                                    <div style={{
                                        background: 'linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%)',
                                        padding: '20px',
                                        borderRadius: '12px',
                                        border: '2px solid #22c55e',
                                        textAlign: 'center'
                                    }}>
                                        <div style={{fontSize: '14px', fontWeight: '600', color: '#16a34a', marginBottom: '8px'}}>
                                            📈 ПОКУПКИ
                                        </div>
                                        <div style={{fontSize: '28px', fontWeight: 'bold', color: '#15803d', marginBottom: '4px'}}>
                                            {formatNumber(statistics?.buy_volume || 0)}
                                        </div>
                                        <div style={{fontSize: '12px', color: '#14532d', marginBottom: '8px'}}>RUB</div>
                                        <div style={{fontSize: '20px', fontWeight: 'bold', color: '#16a34a'}}>
                                            {formatNumber(statistics?.buy_volume_usdt || 0)}
                                        </div>
                                        <div style={{fontSize: '11px', color: '#14532d'}}>USDT</div>
                                    </div>
                                </div>
                            )}

                            {/* Средние курсы (скрыты для BTC) */}
                            {activeTab !== 'btc' && (
                                <div style={{
                                    display: 'grid',
                                    gridTemplateColumns: 'repeat(auto-fit, minmax(180px, 1fr))',
                                    gap: '15px',
                                    marginBottom: '15px'
                                }}>
                                    <div style={{
                                        background: 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)',
                                        padding: '15px',
                                        borderRadius: '10px',
                                        border: '1px solid #f59e0b',
                                        textAlign: 'center'
                                    }}>
                                        <div style={{fontSize: '24px', fontWeight: 'bold', color: '#d97706'}}>
                                            {formatNumber(statistics?.avg_sell_rate || 0)}
                                        </div>
                                        <div style={{fontSize: '12px', color: '#92400e', fontWeight: '600'}}>
                                            💰 Средний курс продажи
                                        </div>
                                    </div>
                                    
                                    <div style={{
                                        background: 'linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%)',
                                        padding: '15px',
                                        borderRadius: '10px',
                                        border: '1px solid #3b82f6',
                                        textAlign: 'center'
                                    }}>
                                        <div style={{fontSize: '24px', fontWeight: 'bold', color: '#2563eb'}}>
                                            {formatNumber(statistics?.avg_buy_rate || 0)}
                                        </div>
                                        <div style={{fontSize: '12px', color: '#1e40af', fontWeight: '600'}}>
                                            💎 Средний курс покупки
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Дополнительная статистика (скрыта для BTC) */}
                            {activeTab !== 'btc' && (
                                <div style={{
                                    display: 'grid',
                                    gridTemplateColumns: 'repeat(auto-fit, minmax(120px, 1fr))',
                                    gap: '12px',
                                    padding: '12px',
                                    background: 'linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%)',
                                    borderRadius: '8px'
                                }}>
                                <div style={{textAlign: 'center'}}>
                                    <div style={{fontSize: '18px', fontWeight: 'bold', color: '#475569'}}>
                                        {statistics?.total_orders || 0}
                                    </div>
                                    <div style={{fontSize: '11px', color: '#64748b'}}>Всего ордеров</div>
                                </div>
                                <div style={{textAlign: 'center'}}>
                                    <div style={{fontSize: '18px', fontWeight: 'bold', color: '#475569'}}>
                                        {formatNumber(statistics?.buy_volume_usdt || 0)} / {formatNumber(statistics?.sell_volume_usdt || 0)}
                                    </div>
                                    <div style={{fontSize: '11px', color: '#64748b'}}>Покупки / Продажи с переводами (USDT)</div>
                                </div>
                                <div style={{textAlign: 'center'}}>
                                    <div style={{fontSize: '18px', fontWeight: 'bold', color: (statistics?.profit_usdt || 0) >= 0 ? '#27ae60' : '#e74c3c'}}>
                                        {(statistics?.profit_usdt || 0) >= 0 ? '+' : ''}{formatNumber(statistics?.profit_usdt || 0)}
                                    </div>
                                    <div style={{fontSize: '11px', color: '#64748b'}}>Прибыль (USDT)</div>
                                </div>
                                <div style={{textAlign: 'center'}}>
                                    <div style={{fontSize: '18px', fontWeight: 'bold', color: (statistics?.profit_rub || 0) >= 0 ? '#27ae60' : '#e74c3c'}}>
                                        {(statistics?.profit_rub || 0) >= 0 ? '+' : ''}{formatNumber(statistics?.profit_rub || 0)}
                                    </div>
                                    <div style={{fontSize: '11px', color: '#64748b'}}>Прибыль (RUB)</div>
                                </div>
                                <div style={{textAlign: 'center'}}>
                                    <div style={{fontSize: '18px', fontWeight: 'bold', color: '#475569'}}>
                                        {formatNumber(statistics?.dokidka_amount || 0)}
                                    </div>
                                    <div style={{fontSize: '11px', color: '#64748b'}}>Докидка</div>
                                </div>
                                <div style={{textAlign: 'center'}}>
                                    <div style={{fontSize: '18px', fontWeight: 'bold', color: '#475569'}}>
                                        {formatNumber(statistics?.internal_transfer_amount || 0)}
                                    </div>
                                    <div style={{fontSize: '11px', color: '#64748b'}}>Внутренний перевод</div>
                                </div>
                                <div style={{textAlign: 'center'}}>
                                    <div style={{fontSize: '18px', fontWeight: 'bold', color: '#475569'}}>
                                        {formatNumber(statistics?.scam_amount || 0)}
                                    </div>
                                    <div style={{fontSize: '11px', color: '#64748b'}}>Скам</div>
                                </div>
                            </div>
                            )}
                        </div>
                    )}

                    {/* Информационное сообщение */}
                    <div style={{
                        marginBottom: '15px',
                        padding: '10px 15px',
                        backgroundColor: '#e3f2fd',
                        borderLeft: '4px solid #2196f3',
                        borderRadius: '4px',
                        fontSize: '14px',
                        color: '#0d47a1'
                    }}>
                        <i className="fas fa-info-circle" style={{marginRight: '8px'}}></i>
                        По умолчанию показываются ордера за последнюю неделю. Используйте фильтр дат для изменения периода или кнопку "Сбросить" для отображения всех ордеров.
                    </div>

                    {/* Фильтры */}
                    <div style={{display:'flex',gap:12,marginBottom:16,flexWrap:'wrap',alignItems:'center'}}>
                        <select className="form-control" value={filters.employee_id} onChange={e => setFilters(f => ({...f, employee_id: e.target.value}))} style={{maxWidth:180}}>
                            <option value="">Все сотрудники</option>
                            {employees.map(emp => (
                                <option key={emp.id} value={emp.id}>{emp.name}</option>
                            ))}
                        </select>
                        <select className="form-control" value={filters.status} onChange={e => setFilters(f => ({...f, status: e.target.value}))} style={{maxWidth:140}}>
                            <option value="">Все статусы</option>
                            <option value="filled">Завершен</option>
                            <option value="canceled">Отменен</option>
                            <option value="pending">В ожидании</option>
                            <option value="appealed">Апелляция</option>
                            <option value="dokidka">Докидка</option>
                            <option value="internal_transfer">Внутренний перевод</option>
                        </select>
                        <input type="date" className="form-control" value={filters.start_date} onChange={e => setFilters(f => ({...f, start_date: e.target.value}))} style={{maxWidth:160}} placeholder="С даты" />
                        <input type="date" className="form-control" value={filters.end_date} onChange={e => setFilters(f => ({...f, end_date: e.target.value}))} style={{maxWidth:160}} placeholder="По дату" />
                        <button 
                            className="btn btn-outline-secondary" 
                            onClick={() => setFilters(f => ({...f, employee_id: '', status: '', start_date: '', end_date: ''}))}
                            style={{height:'38px',padding:'0 12px',fontSize:'14px'}}
                            title="Сбросить все фильтры"
                        >
                            <i className="fas fa-times"></i> Сбросить
                        </button>
                    </div>

                    {/* Таблица ордеров */}
                    <div style={{overflowX:'auto'}}>
                        <table className="table" style={{minWidth:1000}}>
                            <thead>
                                <tr>
                                    <th style={{width: '40px'}}>
                                        <input 
                                            type="checkbox" 
                                            checked={selectAll}
                                            onChange={toggleSelectAll}
                                            style={{cursor: 'pointer'}}
                                        />
                                    </th>
                                    <th>ID ордера</th>
                                    <th>Сотрудник</th>
                                    <th>Платформа</th>
                                    <th>Аккаунт</th>
                                    <th>Пара</th>
                                    <th>Сторона</th>
                                    <th>Цена</th>
                                    <th>Объем (RUB)</th>
                                    <th>Объем (USDT)</th>
                                    <th>Статус</th>
                                    <th>Дата выполнения</th>
                                    <th style={{width: '100px'}}>Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                {loading ? (
                                    <tr>
                                        <td colSpan="13" style={{textAlign: 'center', padding: '20px'}}>
                                            <i className="fas fa-spinner fa-spin"></i> Загрузка...
                                        </td>
                                    </tr>
                                ) : paginated.length === 0 ? (
                                    <tr>
                                        <td colSpan="13" style={{textAlign: 'center', padding: '20px', color: '#666'}}>
                                            Ордеры не найдены
                                        </td>
                                    </tr>
                                ) : (
                                    paginated.map((order, idx) => (
                                        <tr key={order.id}>
                                            <td style={{textAlign: 'center'}}>
                                                <input 
                                                    type="checkbox" 
                                                    checked={selectedOrders.includes(order.id)}
                                                    onChange={() => toggleSelectOrder(order.id)}
                                                    style={{cursor: 'pointer'}}
                                                />
                                            </td>
                                            <td style={{fontFamily: 'monospace', fontSize: '12px'}}>{order.order_id}</td>
                                            <td>{order.employee_name}</td>
                                            <td style={{textTransform: 'uppercase', fontWeight: 'bold'}}>
                                                {order.platform === 'bybit_btc' ? 'BTC' : order.platform}
                                            </td>
                                            <td>{order.account_name}</td>
                                            <td style={{fontWeight: 'bold'}}>{order.symbol}</td>
                                            <td>
                                                <span style={{
                                                    color: getSideColor(order.side),
                                                    fontWeight: 'bold',
                                                    padding: '2px 8px',
                                                    borderRadius: '4px',
                                                    background: getSideColor(order.side) + '20'
                                                }}>
                                                    {getSideText(order.side)}
                                                </span>
                                            </td>
                                            <td style={{fontWeight: 'bold', color: '#3498db'}}>
                                                {parseFloat(order.price).toFixed(2)}
                                            </td>
                                            <td style={{fontWeight: 'bold', color: '#27ae60'}}>
                                                {order.platform === 'bybit_btc' ? '-' : parseFloat(order.total_usdt).toFixed(2)}
                                            </td>
                                            <td style={{fontWeight: 'bold', color: '#e74c3c'}}>
                                                {parseFloat(order.quantity).toFixed(2)}
                                            </td>
                                            <td>
                                                <span style={{
                                                    color: getStatusColor(order.status),
                                                    fontWeight: 'bold',
                                                    padding: '2px 8px',
                                                    borderRadius: '4px',
                                                    background: getStatusColor(order.status) + '20'
                                                }}>
                                                    {getStatusText(order.status)}
                                                </span>
                                            </td>
                                            <td style={{fontSize: '12px'}}>
                                                {new Date(order.executed_at).toLocaleString('ru-RU')}
                                            </td>
                                            <td style={{textAlign: 'center'}}>
                                                <div style={{display: 'flex', gap: '4px', justifyContent: 'center'}}>
                                                <button 
                                                    className="btn btn-sm btn-outline-primary"
                                                    onClick={() => handleEditOrder(order)}
                                                    style={{
                                                        padding: '4px 8px',
                                                        fontSize: '12px',
                                                        borderRadius: '4px',
                                                        border: '1px solid #007bff',
                                                        background: 'transparent',
                                                        color: '#007bff',
                                                        cursor: 'pointer'
                                                    }}
                                                    title="Редактировать ордер"
                                                >
                                                    <i className="fas fa-edit"></i>
                                                </button>
                                                    <button 
                                                        className="btn btn-sm btn-outline-danger"
                                                        onClick={() => handleDeleteOrder(order)}
                                                        style={{
                                                            padding: '4px 8px',
                                                            fontSize: '12px',
                                                            borderRadius: '4px',
                                                            border: '1px solid #dc3545',
                                                            background: 'transparent',
                                                            color: '#dc3545',
                                                            cursor: 'pointer'
                                                        }}
                                                        title="Удалить ордер"
                                                    >
                                                        <i className="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    </div>

                    {/* Пагинация */}
                    <div style={{display:'flex',justifyContent:'center',alignItems:'center',gap:8,marginTop:18}}>
                        <button className="btn btn-secondary" onClick={() => handlePageChange(page-1)} disabled={page<=1}>
                            <i className="fas fa-chevron-left"></i> Назад
                        </button>
                        <span style={{fontWeight:600}}>{page} / {totalPages}</span>
                        <button className="btn btn-secondary" onClick={() => handlePageChange(page+1)} disabled={page>=totalPages}>
                            Вперёд <i className="fas fa-chevron-right"></i>
                        </button>
                    </div>

                    {/* Модальное окно загрузки файлов */}
                    {showUploadModal && (
                        <OrderUploadModal 
                            employees={employees}
                            onClose={() => setShowUploadModal(false)}
                            onSuccess={() => {
                                setShowUploadModal(false);
                                // Обновляем список ордеров
                                setFilters(prev => ({...prev}));
                            }}
                        />
                    )}

                    {/* Модальное окно загрузки BTC-файлов */}
                    {showUploadBTCModal && (
                        <BTCUploadModal 
                            employees={employees}
                            onClose={() => setShowUploadBTCModal(false)}
                            onSuccess={() => {
                                setShowUploadBTCModal(false);
                                // Обновляем список ордеров
                                setFilters(prev => ({...prev}));
                            }}
                        />
                    )}

                    {/* Модальное окно добавления ордера */}
                    {showAddOrderModal && (
                        <AddOrderModal 
                            employees={employees}
                            onClose={() => setShowAddOrderModal(false)}
                            onSuccess={() => {
                                setShowAddOrderModal(false);
                                // Обновляем список ордеров
                                setFilters(prev => ({...prev}));
                            }}
                        />
                    )}

                    {/* Модальное окно редактирования ордера */}
                    {showEditOrderModal && editingOrder && (
                        <EditOrderModal 
                            order={editingOrder}
                            employees={employees}
                            onClose={() => {
                                setShowEditOrderModal(false);
                                setEditingOrder(null);
                            }}
                            onSuccess={() => {
                                setShowEditOrderModal(false);
                                setEditingOrder(null);
                                // Обновляем список ордеров
                                setFilters(prev => ({...prev}));
                            }}
                        />
                    )}

                    {/* Модальное окно для ввода пароля при удалении ордера */}
                    {showDeletePasswordModal && deletingOrder && (
                        <div style={{
                            position: 'fixed',
                            top: 0,
                            left: 0,
                            right: 0,
                            bottom: 0,
                            backgroundColor: 'rgba(0, 0, 0, 0.5)',
                            display: 'flex',
                            justifyContent: 'center',
                            alignItems: 'center',
                            zIndex: 1000
                        }}>
                            <div style={{
                                background: 'white',
                                padding: '30px',
                                borderRadius: '12px',
                                boxShadow: '0 10px 30px rgba(0, 0, 0, 0.3)',
                                maxWidth: '400px',
                                width: '100%',
                                textAlign: 'center'
                            }}>
                                <h4 style={{marginBottom: '20px', color: '#dc3545'}}>
                                    <i className="fas fa-exclamation-triangle"></i> Удаление ордера
                                </h4>
                                <p style={{marginBottom: '20px', color: '#666'}}>
                                    Вы уверены, что хотите удалить ордер <strong>{deletingOrder.order_id}</strong>?
                                </p>
                                <p style={{marginBottom: '20px', color: '#666', fontSize: '14px'}}>
                                    Для подтверждения введите пароль администратора:
                                </p>
                                <input
                                    type="password"
                                    value={deletePassword}
                                    onChange={(e) => setDeletePassword(e.target.value)}
                                    placeholder="Пароль администратора"
                                    style={{
                                        width: '100%',
                                        padding: '12px',
                                        border: '1px solid #ddd',
                                        borderRadius: '6px',
                                        fontSize: '16px',
                                        marginBottom: '20px'
                                    }}
                                    onKeyPress={(e) => {
                                        if (e.key === 'Enter') {
                                            confirmDeleteOrder();
                                        }
                                    }}
                                />
                                <div style={{display: 'flex', gap: '10px', justifyContent: 'center'}}>
                                    <button
                                        className="btn btn-secondary"
                                        onClick={() => {
                                            setShowDeletePasswordModal(false);
                                            setDeletingOrder(null);
                                            setDeletePassword('');
                                        }}
                                        style={{
                                            padding: '10px 20px',
                                            borderRadius: '6px',
                                            border: 'none',
                                            cursor: 'pointer'
                                        }}
                                    >
                                        Отмена
                                    </button>
                                    <button
                                        className="btn btn-danger"
                                        onClick={confirmDeleteOrder}
                                        disabled={deleting}
                                        style={{
                                            padding: '10px 20px',
                                            borderRadius: '6px',
                                            border: 'none',
                                            cursor: deleting ? 'not-allowed' : 'pointer',
                                            opacity: deleting ? 0.6 : 1
                                        }}
                                    >
                                        {deleting ? (
                                            <>
                                                <i className="fas fa-spinner fa-spin"></i> Удаление...
                                            </>
                                        ) : (
                                            <>
                                                <i className="fas fa-trash"></i> Удалить
                                            </>
                                        )}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Добавляю компонент EmployeePercentSettings
        function EmployeePercentSettings() {
            const [employees, setEmployees] = React.useState([]);
            const [percents, setPercents] = React.useState({});
            const [saving, setSaving] = React.useState(false);
            const [success, setSuccess] = React.useState('');
            const [error, setError] = React.useState('');
            React.useEffect(() => {
                fetch('/api/employees').then(r => r.json()).then(data => {
                    setEmployees(data);
                    // salary_percent теперь из API
                    const perc = {};
                    data.forEach(e => { if (e.salary_percent != null) perc[e.id] = e.salary_percent; });
                    setPercents(perc);
                });
            }, []);
            const handleChange = (id, value) => {
                setPercents(p => ({...p, [id]: value}));
                setSaving(true); setSuccess(''); setError('');
                fetch(`/api/employees/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ salary_percent: value })
                })
                .then(r => r.json().then(data => ({ok: r.ok, data})))
                .then(res => {
                    if (res.ok) setSuccess('Сохранено!');
                    else setError(res.data.error || 'Ошибка сохранения');
                    setSaving(false);
                })
                .catch(() => { setError('Ошибка сохранения'); setSaving(false); });
            };
            return (
                <div>
                    <table className="table" style={{maxWidth:600}}>
                        <thead><tr><th>Сотрудник</th><th>Процент (%)</th></tr></thead>
                        <tbody>
                            {employees.map(emp => (
                                <tr key={emp.id}>
                                    <td>{emp.name}</td>
                                    <td>
                                        <input type="number" min="0" max="100" step="0.1" className="form-control" style={{maxWidth:100}} value={percents[emp.id] || ''} onChange={e => handleChange(emp.id, e.target.value)} onWheel={e => e.target.blur()} />
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                    {saving && <span style={{color:'#888',marginLeft:10}}>Сохранение...</span>}
                    {success && <div style={{color:'#27ae60',marginTop:10}}>{success}</div>}
                    {error && <div style={{color:'#e74c3c',marginTop:10}}>{error}</div>}
                </div>
            );
        }



        // Компонент для загрузки BTC-файлов
        function BTCUploadModal({ employees, onClose, onSuccess }) {
            const [formData, setFormData] = React.useState({
                employee_id: '',
                account_name: '',
                file: null
            });
            const [uploading, setUploading] = React.useState(false);
            const [error, setError] = React.useState('');
            const [success, setSuccess] = React.useState('');
            const [accounts, setAccounts] = React.useState([]);

            React.useEffect(() => {
                fetch('/api/accounts')
                    .then(r => r.json())
                    .then(data => setAccounts(data.filter(acc => acc.platform === 'bybit')))
                    .catch(() => setAccounts([]));
            }, []);

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!formData.employee_id || !formData.account_name || !formData.file) {
                    setError('Заполните все поля и выберите файл');
                    return;
                }
                setUploading(true);
                setError('');
                setSuccess('');
                try {
                    const formDataToSend = new FormData();
                    formDataToSend.append('employee_id', formData.employee_id);
                    formDataToSend.append('platform', 'bybit_btc');
                    formDataToSend.append('account_name', formData.account_name);
                    formDataToSend.append('file', formData.file);
                    const response = await fetch('/api/orders/upload', {
                        method: 'POST',
                        body: formDataToSend
                    });
                    const result = await response.json();
                    if (response.ok) {
                        setSuccess(`Успешно загружено ${result.count} BTC-ордеров`);
                        setTimeout(() => { onSuccess(); }, 2000);
                    } else {
                        setError(result.error || 'Ошибка загрузки файла');
                    }
                } catch (err) {
                    setError('Ошибка соединения с сервером');
                } finally {
                    setUploading(false);
                }
            };

            return (
                <div style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,0.5)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:1000}}>
                    <div style={{background:'#fff',borderRadius:12,padding:32,minWidth:340,boxShadow:'0 8px 32px rgba(0,0,0,0.18)'}}>
                        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:18}}>
                            <h4 style={{margin:0,color:'#f7931a',display:'flex',alignItems:'center',gap:8}}><i className="fas fa-bitcoin"></i> Загрузка BTC-выгрузки Bybit</h4>
                            <button onClick={onClose} style={{background:'none',border:'none',fontSize:20,color:'#666',cursor:'pointer'}}><i className="fas fa-times"></i></button>
                        </div>
                        <form onSubmit={handleSubmit}>
                            <div style={{marginBottom:18}}>
                                <label style={{display:'block',marginBottom:6,fontWeight:'bold'}}>Сотрудник:</label>
                                <select className="form-control" value={formData.employee_id} onChange={e => setFormData(prev => ({...prev, employee_id: e.target.value, account_name: ''}))} required>
                                    <option value="">Выберите сотрудника</option>
                                    {employees.map(emp => (
                                        <option key={emp.id} value={emp.id}>{emp.name}</option>
                                    ))}
                                </select>
                            </div>
                            <div style={{marginBottom:18}}>
                                <label style={{display:'block',marginBottom:6,fontWeight:'bold'}}>Аккаунт Bybit:</label>
                                <select className="form-control" value={formData.account_name} onChange={e => setFormData(prev => ({...prev, account_name: e.target.value}))} required>
                                    <option value="">Выберите аккаунт</option>
                                    {accounts.map(acc => (
                                        <option key={acc.account_name} value={acc.account_name}>{acc.account_name}</option>
                                    ))}
                                </select>
                            </div>
                            <div style={{marginBottom:18}}>
                                <label style={{display:'block',marginBottom:6,fontWeight:'bold'}}><i className="fas fa-file-csv" style={{color:'#f7931a',marginRight:4}}></i> BTC CSV-файл:</label>
                                <input type="file" className="form-control" accept=".csv" onChange={e => setFormData(prev => ({...prev, file: e.target.files[0]}))} required />
                                <div style={{fontSize:'0.85em',color:'#6c757d',marginTop:4}}>Только CSV-файл BTC Bybit</div>
                            </div>
                            {error && <div style={{color:'#dc3545',marginBottom:10}}>{error}</div>}
                            {success && <div style={{color:'#27ae60',marginBottom:10}}>{success}</div>}
                            <button className="btn btn-warning" type="submit" disabled={uploading} style={{width:'100%',fontWeight:600,background:'#f7931a',color:'#fff',border:'none',padding:'12px 0',borderRadius:8}}>
                                {uploading ? 'Загрузка...' : 'Загрузить BTC-выгрузку'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        // Заменяю ReactDOM.render на createRoot
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html> 